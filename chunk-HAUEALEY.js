import{a as le}from"./chunk-SDVXMSWM.js";import{b as ce}from"./chunk-J2L7ZAMK.js";import{a as se}from"./chunk-7TUK6JK3.js";import{a as C}from"./chunk-D4NR3K55.js";import{a as de,b as j}from"./chunk-M5PFS4RI.js";import{a as pe}from"./chunk-6GGD6PVO.js";import{b as oe}from"./chunk-HPLSWIEJ.js";import{$ as G,$a as K,A as N,Aa as Q,B as w,D as F,Db as ee,E as A,Ga as h,H,Ha as $,Ja as q,O as l,Oc as U,Pc as u,Q as p,Qc as s,Tc as g,Ua as L,Wa as I,Wb as te,Xb as re,Y as T,ab as _,b as c,bb as R,cb as x,cc as m,dc as ie,ea as V,ec as ne,fa as z,ka as E,lb as X,m as S,ma as b,n as f,ob as D,p as d,q as J,qb as k,r as M,s as W,sc as ae,w as B,x as P,xb as Y,y as O,yb as Z}from"./chunk-EYIZCJHC.js";function he(a,e){for(let t of e){let r;if(t.endsWith("/")?(r=t,t=t.substring(0,-1)):r=`${t}/`,a.startsWith(r)||a===t)return!0}return!1}function ue(a,e,t=[]){return!(!he(a,e)||he(a,t))}var y=class a{constructor(e){this.http=e;this.startPolling()}watchers={};loaders={};polling;MaxWatcherInterval=400;MinWatcherInterval=200;RefreshInterval=50;eventDrawnSubject=new c;eventClearedSubject=new c;eventAppendSubject=new c;eventUpdatedSubject=new c;gatherWatchers(){let e=[],t=U.PageCheckInterval*1e3,r=Date.now()-t;for(let n in this.watchers){let i=this.watchers[n];i.shouldUpdate||r<=i.lastCheckedTime||i.metaUrlHasError||e.push(i)}return j(e)}invokeWatcher(e){let t=this.fetchJson(e.metaUrl).pipe(F(r=>{throw e.metaUrlHasError=!0,r}));return w(t,f(e))}clampInterval(e){return Math.max(Math.min(e,this.MaxWatcherInterval),this.MinWatcherInterval)}startPolling(){let e=U.PageCheckInterval*1e3;this.polling=P(e).pipe(d(r=>this.gatherWatchers()),l(r=>{let n=this.clampInterval(e/r.length);return s(`Polling delay ${n} for ${r.length} watchers`),w(S(r),P(n))}),l(([r,n])=>this.invokeWatcher(r))).subscribe({next:([r,n])=>{if(n.lastCheckedTime=Date.now(),n.lastUpdatedAt>=r.updated)return;n.shouldUpdate=!0,this.eventUpdatedSubject.next();let i=this.loaders[n.id];i?.updatedEvent&&i.updatedEvent.emit(r)},error:r=>{g("Error while polling. Restarting.",r),this.startPolling()},complete:()=>{g("Never complete the polling")}});let t=P(e).pipe(l(r=>this.http.fetchGhJson("/beacons.json",{addNonce:!0})),M(r=>{let n=[];for(let i in r.beacons){let o=r.beacons[i],v=this.http.fetchGhJson(o.resource,{addNonce:!0}).pipe(d(ge=>{for(let ve of ge)if(ve.value===o.value)return!0;return!1}));n.push(v)}return J(n).pipe(d(i=>i.every(o=>o)))}))}fetchJson(e){return this.http.fetchGhJson(e).pipe()}gatherRefreshener(){let e=[];for(let t in this.loaders){let r=this.loaders[t];e.push(r)}return j(e)}onClickRefresh(){s("ReloadService.onClickRefresh()");let e=this.gatherRefreshener(),t=this.RefreshInterval;S(e).pipe(d(r=>({loader:r,delay:t})),A(r=>B(r.delay).pipe(d(()=>r.loader)))).subscribe({next:r=>{r.refreshEvent.emit()},complete:()=>{s("ReloadService.onClickRefresh completed()"),this.eventDrawnSubject.next()}})}get eventDrawn(){return this.eventDrawnSubject}get eventCleared(){return this.eventClearedSubject}get eventAppend(){return this.eventAppendSubject}get eventUpdated(){return this.eventUpdatedSubject}findWatcher(e){for(let t in this.watchers)if(this.watchers[t].url===e)return t;return null}generateId(){let e=de(32);return s(`Generating reloadId: ${e}`),e}ensureLoader(e){let t=this.loaders[e];if(!t)throw new Error(`No loader found for id: ${e}`);return t}appendLoader(e){u(`Creating loader id:${e}`);let t={id:e,refreshEvent:new E};this.loaders[e]=t}registerLoader(){let e=this.generateId();return this.appendLoader(e),this.eventAppendSubject.next(),e}updatedEvent(e){let t=this.ensureLoader(e);return t.updatedEvent||(t.updatedEvent=new E),t.updatedEvent}refreshEvent(e){return this.ensureLoader(e).refreshEvent}registerWatcher(e,t,r){let n=this.findWatcher(e),i;return n?(i=this.watchers[n],i.lastUpdatedAt=t,i.lastCheckedTime=Date.now(),n):(n=this.generateId(),u(`Creating watcher id:${n}`),i={id:n,url:e,metaUrl:r||e,lastUpdatedAt:t,lastCheckedTime:Date.now(),shouldUpdate:!1},this.watchers[n]=i,this.appendLoader(n),this.eventAppendSubject.next(),n)}unregister(e){e in this.watchers&&(u(`Purging watcher id:${e}`),delete this.watchers[e]),e in this.loaders&&(u(`Purging loader id:${e}`),delete this.loaders[e]),Object.keys(this.watchers).length===0&&Object.keys(this.loaders).length===0&&(u("Watchers and Loaders both are cleared."),this.eventClearedSubject.next())}static \u0275fac=function(t){return new(t||a)(G(C))};static \u0275prov=T({token:a,factory:a.\u0275fac,providedIn:"root"})};var Ce=["gitfireCommentLoader"];function ye(a,e){if(a&1){let t=X();_(0,"div",2)(1,"button",3),D("click",function(n){V(t);let i=k(2);return z(i.onClickLoadComment(n))}),x(2,"img",4),ee(3,"\u30B3\u30E1\u30F3\u30C8\u8AAD\u307F\u8FBC\u307F"),R()()}}function Se(a,e){a&1&&x(0,"div",null,0)}function we(a,e){if(a&1&&L(0,ye,4,0,"div",2)(1,Se,2,0,"div"),a&2){let t=k();I(t.showComment()&&!t.isCommentLoader()?0:1)}}var me=class a{constructor(e,t,r,n,i){this.http=e;this.reloader=t;this.loader=r;this.router=n;this.localSession=i}pagePath=ie();pagePath$=oe(this.pagePath);loadError=m();fatalError=m();loadPageJson=m();loadPageBody=m();currentPath=null;eventForceUpdate$=new c;reloadId;refreshSubscription;destroy$=new c;eventPage$;isCommentLoader=b(!1);showComment=b(!1);gitfireCommentLoader=ne("gitfireCommentLoader",{read:$});includesComment=["/Gitwee","/Diary/","/Cheater/Gitwee"];excludesComment=[];doc=b(null);getPagePath(e){return`${e.jsonPath}.json`}getPageMetaPath(e){return`${e.jsonPath}.json`}fetchJson(e){return this.http.fetchGhJson(this.getPagePath(e)).pipe(d(t=>[e,t]))}ngOnInit(){s("PagePathComponent.OnInit()");let e=new c;this.eventPage$=W(f(null),this.eventForceUpdate$).pipe(l(i=>this.pagePath$),l(i=>this.fetchJson(i)));let t=this.eventPage$.pipe(N(([i,o])=>!o.redirectPath)),r=new c;this.eventPage$.pipe(p(this.destroy$)).subscribe(async([i,o])=>{o.redirectPath&&await this.tryRedirect(i.jsonPath,o.redirectPath)||r.next([i,o])}),O(t,r).pipe(p(this.destroy$)).subscribe({next:async([i,o])=>{s("redrawPage$.subscribe",i,o),this.maybeRedisplayComments(i),this.currentPath=i,this.drawPageBody(i,o),this.startWatching(i,o),this.loadPageJson.emit(o)},error:i=>{g(i),this.fatalError.emit(i)},complete:()=>{s("Successfully completed PagePathComponent")}}),e.pipe(p(this.destroy$)).subscribe(i=>this.loadError.emit(i)),this.localSession.markedLogout$.pipe(p(this.destroy$)).subscribe(()=>{this.isCommentLoader.set(!1)})}ngOnDestroy(){s("PagePathComponent.OnDestroy()"),this.ensureUnregisterWathing(),this.destroy$.next()}async tryRedirect(e,t){return s(`redirecting ${e} -> ${t}`),!!await this.router.navigateByUrl(t,{replaceUrl:!0})}startWatching(e,t){this.ensureUnregisterWathing();let r=this.getPagePath(e),n=this.reloader.registerWatcher(r,t.updated);this.reloadId=n,this.refreshSubscription=this.reloader.refreshEvent(n).subscribe(()=>{this.eventForceUpdate$.next()})}onPageLoaded(){this.loadPageBody.emit()}drawPageBody(e,t){s(`PagePathComponent.drawPageBody() drawing page at published at ${t.published}.`);let r=t.virtualPath||e.baseResource,n={html:t.html,styles:t.styles,resource:r};this.doc.set(n)}ensureUnregisterWathing(){this.reloadId&&(this.reloader.unregister(this.reloadId),delete this.reloadId),this.refreshSubscription&&this.refreshSubscription.unsubscribe()}urlSubscription=null;maybeRedisplayComments(e){this.currentPath!==e&&(this.maybeClearComments(),this.showComment.set(!1),this.isCommentLoader.set(!1),this.urlSubscription&&(this.urlSubscription.unsubscribe(),this.urlSubscription=null),this.urlSubscription=this.router.currentUrl$.pipe(p(this.destroy$)).subscribe(t=>{ue(t,this.includesComment,this.excludesComment)&&this.showComment.set(!0)}))}maybeClearComments(){let e=this.gitfireCommentLoader();return e?(e.clear(),e):null}onClickLoadComment(e){s("PagePathComponent.onClickLoadComment()"),this.eventPage$.pipe(p(this.destroy$),H(1)).subscribe(async([t,r])=>{s("PagePathComponent.onClickLoadComment() -> this.eventPage$",t,r),this.isCommentLoader.set(!0);let{GitfireModule:n}=await import("./chunk-U3VQ2NOT.js"),{CommentEntryComponent:i}=await import("./chunk-PUUO7FUH.js"),o=this.maybeClearComments();if(!o)throw new Error("No loader node is detected");let v=this.loader.appendComponentRef(o,n,i);v.setInput("pagePath",t),v.setInput("pageJson",r)})}static \u0275fac=function(t){return new(t||a)(h(C),h(y),h(le),h(se),h(pe))};static \u0275cmp=q({type:a,selectors:[["app-page-path"]],viewQuery:function(t,r){t&1&&Y(r.gitfireCommentLoader,Ce,5,$),t&2&&Z()},inputs:{pagePath:[1,"pagePath"]},outputs:{loadError:"loadError",fatalError:"fatalError",loadPageJson:"loadPageJson",loadPageBody:"loadPageBody"},decls:3,vars:4,consts:[["gitfireCommentLoader",""],[3,"pageLoaded","doc"],[1,"text-center","m-4"],["type","button","aria-expanded","true","aria-label","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059","title","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059",1,"btn","btn-primary",3,"click"],["src","/assets/octicons/comment.svg",1,"m-1"]],template:function(t,r){t&1&&(_(0,"app-safe-doc",1),D("pageLoaded",function(){return r.onPageLoaded()}),R(),L(1,we,2,1),te(2,"async")),t&2&&(K("doc",r.doc()),Q(),I(re(2,2,r.localSession.loginStateChanged$)?1:-1))},dependencies:[ce,ae],encapsulation:2})};export{y as a,me as b};
