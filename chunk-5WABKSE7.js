import{a as dt}from"./chunk-CB3UAQLU.js";import{a as Lt,b as J,c as Mt}from"./chunk-PJSI6WZC.js";import{a as Pt,b as kt}from"./chunk-DQJB75ZH.js";import{a as ct,e as wt}from"./chunk-5VQIW4GB.js";import{c as M,d as $}from"./chunk-Q36SEPEP.js";import{c as G,e as bt,f as Bt,g as It,h as z,l as St,n as Tt,o as At}from"./chunk-BHNCSSWD.js";import{b as W}from"./chunk-CDP2GTLG.js";import{a as k}from"./chunk-KZT4ZPQY.js";import{$a as g,$c as xt,Aa as u,Ab as q,Bb as at,Db as d,Fb as I,Ga as v,Ja as S,Nb as H,Nc as L,O as R,Oa as T,Ob as mt,Pc as C,Q as nt,Sc as w,Ua as s,Va as B,Vc as _t,Wa as c,Wb as h,Wc as Ct,Xb as y,Xc as pt,Yb as A,Yc as ft,Za as ot,Zb as ut,Zc as gt,_a as rt,ab as m,b as it,bb as r,cb as F,dc as tt,ea as p,fa as f,fd as Et,gd as vt,ib as U,ka as Z,lb as E,m as X,ma as O,md as Ft,o as Y,ob as x,od as ht,pd as yt,qb as a,qc as lt,rc as P,rd as Dt,sc as st,xa as b,z as N,zb as j}from"./chunk-FWGH4434.js";function Wt(e,i){if(e&1){let t=E();m(0,"div",0)(1,"button",8),x("click",function(){p(t);let n=a();return f(n.onClickDismiss())}),m(2,"span",9),d(3,"\xD7"),r()()()}}function Gt(e,i){e&1&&(m(0,"div",6),d(1,"OK!"),r())}function zt(e,i){e&1&&(m(0,"div",10),d(1,"\u5165\u529B\u5FC5\u9808\u3067\u3059\u3002"),r())}function Jt(e,i){e&1&&(m(0,"div",10),d(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),r())}function Kt(e,i){e&1&&(m(0,"div",10),d(1,"\u77ED\u3059\u304E\u307E\u3059\u3002"),r())}function Qt(e,i){if(e&1&&(s(0,zt,2,0,"div",10),s(1,Jt,2,0,"div",10),s(2,Kt,2,0,"div",10)),e&2){let t=a();c(t.textareaControl.errors!=null&&t.textareaControl.errors.required?0:-1),u(),c(t.textareaControl.errors!=null&&t.textareaControl.errors.maxlength?1:-1),u(),c(t.textareaControl.errors!=null&&t.textareaControl.errors.minlength?2:-1)}}var V=class e{constructor(i,t,o,n,l){this.user=i;this.auth=t;this.toastr=o;this.funcs=n;this.tos=l}editModel;pageId;showDismiss=!1;replyId;requestSent=new Z;editDismiss=new Z;inputForm;get textareaControl(){return this.inputForm.get("commentText")}ngOnInit(){C("CommentEditorComponent.OnInit()"),this.inputForm=new gt({}),this.inputForm.addControl("commentText",new xt(this.editModel?this.editModel.message:null,[Ct.required]))}onClickDismiss(){C("CommentEditorComponent.onClickDismiss()"),this.editDismiss.emit()}async doNewPost(){let i={message:this.textareaControl.value,pageId:this.pageId,replyId:this.replyId};return await this.funcs.call("postComment",i)}async doUpdatePost(i){let t={pageId:this.pageId,commentId:i.id,message:this.textareaControl.value};return await this.funcs.call("editComment",t)}onClickPostComment(){C("CommentEditorComponent.onClickPostComment()"),!this.inputForm.invalid&&(this.textareaControl.invalid||this.tos.confirmTos$(`${this.auth.myUid}/commentAgreement`,L.CommentServiceTosUrl).pipe(N(i=>i)).subscribe(async i=>{this.inputForm.disable();try{this.editModel?await this.doUpdatePost(this.editModel):await this.doNewPost(),this.toastr.info("\u6295\u7A3F\u3057\u307E\u3057\u305F\u3002(\u627F\u8A8D\u3055\u308C\u308B\u307E\u3067\u4ED6\u306E\u4EBA\u306B\u306F\u8868\u793A\u3055\u308C\u307E\u305B\u3093\u3002)"),this.textareaControl.setValue(""),this.inputForm.markAsPristine(),this.inputForm.markAsUntouched(),this.requestSent.emit()}catch(t){if("message"in t){let o=t.message;this.toastr.error(`\u6295\u7A3F\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002( ${o} )`)}else this.toastr.error("\u6295\u7A3F\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002")}finally{this.inputForm.enable()}}))}static \u0275fac=function(t){return new(t||e)(v(J),v($),v(k),v(M),v(Lt))};static \u0275cmp=S({type:e,selectors:[["gitfire-comment-editor"]],inputs:{editModel:"editModel",pageId:"pageId",showDismiss:"showDismiss",replyId:"replyId"},outputs:{requestSent:"requestSent",editDismiss:"editDismiss"},decls:16,vars:14,consts:[[1,"text-end"],[1,"input-group",3,"formGroup"],["title","\u3053\u306E\u540D\u524D\u3067\u6295\u7A3F\u306F\u8868\u793A\u3055\u308C\u307E\u3059\u3002","src","/assets/octicons/question.svg",1,"m-1","octicon-info","help-icon"],["disabled","",1,"m-3",3,"value"],[1,"m-3"],["autofocus","","name","commentText","formControlName","commentText","placeholder","\u6295\u7A3F\u3059\u308B\u30B3\u30E1\u30F3\u30C8\u3092\u3053\u3053\u306B\u66F8\u3044\u3066\u304F\u3060\u3055\u3044\u3002","required","","minlength","5","maxlength","65536",1,"p-3","form-control"],[1,"valid-feedback"],["title","\u30B3\u30E1\u30F3\u30C8\u5185\u5BB9\u306F\u627F\u8A8D\u5F8C\u306B\u8868\u793A\u3055\u308C\u307E\u3059\u3002",1,"btn","btn-primary","m-2",3,"click","disabled"],["type","button","aria-label","Close",1,"btn-close",3,"click"],["aria-hidden","true"],[1,"invalid-feedback"]],template:function(t,o){t&1&&(s(0,Wt,4,0,"div",0),m(1,"div",1)(2,"div")(3,"label"),d(4,"\u540D\u524D"),F(5,"img",2),d(6,": "),r(),F(7,"input",3),h(8,"async"),r(),m(9,"div",4),F(10,"textarea",5),s(11,Gt,2,0,"div",6)(12,Qt,3,3),r(),m(13,"div")(14,"button",7),x("click",function(){return o.onClickPostComment()}),d(15,"\u6295\u7A3F\u3059\u308B"),r()()()),t&2&&(c(o.showDismiss?0:-1),u(),at("was-validated",o.textareaControl.dirty||o.textareaControl.touched),g("formGroup",o.inputForm),u(6),g("value",H(y(8,12,o.user.myNickname$()))),u(2),q("width",100,"%"),u(),q("height",8,"rem"),u(),c(o.textareaControl.invalid?12:11),u(3),g("disabled",o.textareaControl.invalid||o.inputForm.disabled))},dependencies:[Dt,_t,pt,ft,Ft,ht,yt,vt,Et,P],encapsulation:2})};var Yt=(e,i)=>i.store.id;function Zt(e,i){e&1&&F(0,"span",1)}function te(e,i){if(e&1&&(m(0,"span",6)(1,"small",5),h(2,"date"),d(3),h(4,"date"),r()()),e&2){let t=a().$implicit;u(),g("title",H(A(2,3,t.updatedAt,"yyyy-MM-dd HH:mm"))),u(2),I("\u66F4\u65B0\u65E5: ",A(4,6,t.updatedAt,"yyyy-MM-dd"))}}function ee(e,i){if(e&1&&(m(0,"span",6)(1,"small"),d(2),h(3,"date"),r()()),e&2){let t=a().$implicit;u(2),I("\u627F\u8A8D\u65E5: ",A(3,1,t.decisionAt,"yyyy-MM-dd"))}}function ie(e,i){if(e&1){let t=E();m(0,"a",27),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickApprove(n,l))}),d(1,"\u627F\u8A8D"),r()}}function ne(e,i){if(e&1){let t=E();m(0,"a",28),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickApprove(n,l))}),d(1,"\u7DE8\u96C6\u627F\u8A8D"),r()}}function oe(e,i){if(e&1){let t=E();m(0,"a",29),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickApprove(n,l))}),d(1,"\u524A\u9664\u627F\u8A8D"),r()}}function re(e,i){if(e&1){let t=E();m(0,"a",30),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickReject(n,l))}),d(1,"\u62D2\u5426"),r()}}function ae(e,i){if(e&1){let t=E();m(0,"a",31),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickReject(n,l))}),d(1,"\u7DE8\u96C6\u62D2\u5426"),r()}}function me(e,i){if(e&1){let t=E();m(0,"a",32),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickReject(n,l))}),d(1,"\u7DE8\u96C6\u62D2\u5426"),r()}}function ue(e,i){if(e&1){let t=E();m(0,"a",33),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickProtect(n,l))}),d(1,"\u4FDD\u8B77"),r()}}function le(e,i){if(e&1){let t=E();m(0,"a",34),x("click",function(n){p(t);let l=a(2).$implicit,_=a(2);return f(_.onClickUnProtect(n,l))}),d(1,"\u4FDD\u8B77\u89E3\u9664"),r()}}function se(e,i){if(e&1&&(m(0,"span",7)(1,"span",17),d(2,"\uFE19"),r(),m(3,"div",18),s(4,ie,2,0,"a",19),s(5,ne,2,0,"a",20),s(6,oe,2,0,"a",21),s(7,re,2,0,"a",22),s(8,ae,2,0,"a",23),s(9,me,2,0,"a",24),s(10,ue,2,0,"a",25),s(11,le,2,0,"a",26),r()()),e&2){let t=a().$implicit;u(4),c(t.store.state==="pending"?4:-1),u(),c(t.store.state==="approved"&&t.store.editedState==="edit-request"?5:-1),u(),c(t.store.state==="approved"&&t.store.editedState==="delete-request"?6:-1),u(),c(t.store.state==="pending"?7:-1),u(),c(t.store.state==="approved"&&t.store.editedState==="edit-request"?8:-1),u(),c(t.store.state==="approved"&&t.store.editedState==="delete-request"?9:-1),u(),c(t.store.state==="approved"&&!t.store.isAdminEdit?10:-1),u(),c(t.store.state==="approved"&&t.store.isAdminEdit?11:-1)}}function ce(e,i){e&1&&F(0,"gitfire-user-box",9),e&2&&g("userPublic",i)}function de(e,i){e&1&&(m(0,"span",11),d(1,"\u7BA1\u7406\u4EBA\u306B\u3088\u308B\u4FDD\u8B77"),r())}function _e(e,i){e&1&&(m(0,"span",12),d(1,"\u5374\u4E0B\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3067\u3059\u3002"),r())}function Ce(e,i){e&1&&(m(0,"span",13),d(1,"\u627F\u8A8D\u5F85\u3061\u306E\u30B3\u30E1\u30F3\u30C8\u3067\u3059\u3002"),r())}function pe(e,i){e&1&&(m(0,"span",13),d(1,"\u524A\u9664\u3055\u308C\u307E\u3057\u305F\u3002"),r())}function fe(e,i){e&1&&(m(0,"span",12),d(1,"\u7DE8\u96C6\u7533\u8ACB\u304C\u5374\u4E0B\u3055\u308C\u307E\u3057\u305F\u3002"),r())}function ge(e,i){e&1&&(m(0,"span",12),d(1,"\u524A\u9664\u7533\u8ACB\u304C\u5374\u4E0B\u3055\u308C\u307E\u3057\u305F\u3002"),r())}function xe(e,i){e&1&&(m(0,"span",12),d(1,"\u524A\u9664\u7533\u8ACB\u4E2D\u3067\u3059\u3002"),r())}function Ee(e,i){e&1&&(m(0,"span",13),d(1,"\u7DE8\u96C6\u7533\u8ACB\u4E2D\u3067\u3059\u3002"),r())}function ve(e,i){if(e&1&&s(0,fe,2,0,"span",12)(1,ge,2,0,"span",12)(2,xe,2,0,"span",12)(3,Ee,2,0,"span",13),e&2){let t,o=a().$implicit;c((t=o.store.editedState)==="edit-rejected"?0:t==="delete-rejected"?1:t==="delete-request"?2:t==="edit-request"?3:-1)}}function Fe(e,i){if(e&1){let t=E();m(0,"gitfire-comment-editor",37),x("requestSent",function(){p(t);let n=a(3).$implicit,l=a(2);return f(l.onEditRequested(n))})("editDismiss",function(){p(t);let n=a(3).$implicit,l=a(2);return f(l.onEditDismissed(n))}),r()}if(e&2){let t=a(5);g("pageId",t.pageId())("editModel",i)("showDismiss",!0)}}function he(e,i){if(e&1&&(s(0,Fe,1,3,"gitfire-comment-editor",36),h(1,"async")),e&2){let t,o=a(2).$implicit;c((t=y(1,1,o.editor$))?0:-1,t)}}function ye(e,i){if(e&1&&F(0,"div",35),e&2){let t=a(2).$implicit;g("innerHTML",t.store.messageHtml,b)}}function De(e,i){if(e&1&&(m(0,"div"),s(1,he,2,3),s(2,ye,1,1,"div",35),r()),e&2){let t=a().$implicit;u(),c(t.isEditing?1:-1),u(),c(t.store.state==="approved"&&!t.isEditing?2:-1)}}function we(e,i){if(e&1&&F(0,"div",35),e&2){let t=a(2).$implicit;g("innerHTML",t.store.messageHtml,b)}}function be(e,i){if(e&1&&s(0,we,1,1,"div",35),e&2){let t=a().$implicit;c(t.store.state==="approved"?0:-1)}}function Be(e,i){e&1&&F(0,"span",1)}function Ie(e,i){e&1&&F(0,"div",40),e&2&&g("innerHTML",i.messageHtml,b)}function Se(e,i){e&1&&U(0)}function Te(e,i){if(e&1&&T(0,Se,1,0,"ng-container",41),e&2){a(2);let t=j(2);g("ngTemplateOutlet",t)}}function Ae(e,i){if(e&1&&(m(0,"div",38)(1,"span",13),d(2,"\u7533\u8ACB\u4E2D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),s(3,Ie,1,1,"div",40),h(4,"async"),B(5,Te,1,1,"ng-container"),r()),e&2){let t,o=a(2).$implicit;u(3),c((t=y(4,1,o.privateMessage$))?3:5,t)}}function Pe(e,i){e&1&&F(0,"div",40),e&2&&g("innerHTML",i.messageHtml,b)}function ke(e,i){e&1&&U(0)}function Le(e,i){if(e&1&&T(0,ke,1,0,"ng-container",41),e&2){a(2);let t=j(2);g("ngTemplateOutlet",t)}}function Me(e,i){if(e&1&&(m(0,"div",39)(1,"span",12),d(2,"\u5374\u4E0B\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),s(3,Pe,1,1,"div",40),h(4,"async"),B(5,Le,1,1,"ng-container"),r()),e&2){let t,o=a(2).$implicit;u(3),c((t=y(4,1,o.privateMessage$))?3:5,t)}}function $e(e,i){e&1&&F(0,"div",40),e&2&&g("innerHTML",i.messageHtml,b)}function Ve(e,i){e&1&&U(0)}function Re(e,i){if(e&1&&T(0,Ve,1,0,"ng-container",41),e&2){a(3);let t=j(2);g("ngTemplateOutlet",t)}}function Oe(e,i){if(e&1&&(m(0,"div",38)(1,"span",13),d(2,"\u7DE8\u96C6\u7533\u8ACB\u4E2D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),s(3,$e,1,1,"div",40),h(4,"async"),B(5,Re,1,1,"ng-container"),r()),e&2){let t,o=a(3).$implicit;u(3),c((t=y(4,1,o.privateMessage$))?3:5,t)}}function Ue(e,i){e&1&&F(0,"div",40),e&2&&g("innerHTML",i.messageHtml,b)}function je(e,i){e&1&&U(0)}function qe(e,i){if(e&1&&T(0,je,1,0,"ng-container",41),e&2){a(3);let t=j(2);g("ngTemplateOutlet",t)}}function He(e,i){if(e&1&&(m(0,"div",39)(1,"span",12),d(2,"\u7DE8\u96C6\u7533\u8ACB\u304C\u5374\u4E0B\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),s(3,Ue,1,1,"div",40),h(4,"async"),B(5,qe,1,1,"ng-container"),r()),e&2){let t,o=a(3).$implicit;u(3),c((t=y(4,1,o.privateMessage$))?3:5,t)}}function Ne(e,i){if(e&1&&(m(0,"div"),s(1,Oe,6,3,"div",38),s(2,He,6,3,"div",39),r()),e&2){let t=a(2).$implicit;u(),c(t.store.editedState==="edit-request"?1:-1),u(),c(t.store.editedState==="edit-rejected"?2:-1)}}function We(e,i){if(e&1&&(m(0,"div",14),T(1,Be,1,0,"ng-template",null,0,ut),s(3,Ae,6,3,"div",38),s(4,Me,6,3,"div",39),s(5,Ne,3,2,"div"),r()),e&2){let t=a().$implicit;u(3),c(t.store.state==="pending"?3:-1),u(),c(t.store.state==="rejected"?4:-1),u(),c(t.store.state==="approved"?5:-1)}}function Ge(e,i){if(e&1){let t=E();m(0,"button",42),x("click",function(n){p(t);let l=a().$implicit,_=a(2);return f(_.onClickReply(n,l))}),d(1,"\u8FD4\u4FE1"),r()}}function ze(e,i){if(e&1){let t=E();m(0,"button",43),x("click",function(n){p(t);let l=a().$implicit,_=a(2);return f(_.onClickDelete(n,l))}),d(1,"\u524A\u9664"),r(),m(2,"button",44),x("click",function(n){p(t);let l=a().$implicit,_=a(2);return f(_.onClickEdit(n,l))}),d(3,"\u7DE8\u96C6"),r()}}function Je(e,i){if(e&1){let t=E();m(0,"div",15)(1,"gitfire-comment-editor",45),x("requestSent",function(){p(t);let n=a().$implicit,l=a(2);return f(l.onReplyRequested(n))})("editDismiss",function(){p(t);let n=a().$implicit,l=a(2);return f(l.onReplyDismissed(n))}),r()()}if(e&2){let t=a().$implicit,o=a(2);u(),g("showDismiss",!0)("replyId",t.store.id)("pageId",o.pageId())}}function Ke(e,i){if(e&1&&(m(0,"div",4)(1,"div")(2,"div")(3,"span",5),h(4,"date"),d(5),h(6,"date"),r(),s(7,te,5,9,"span",6),s(8,ee,4,4,"span",6),s(9,se,12,8,"span",7),r(),m(10,"div",8),d(11,"\u30E6\u30FC\u30B6: "),s(12,ce,1,1,"gitfire-user-box",9),h(13,"async"),r()(),m(14,"div",10)(15,"div"),s(16,de,2,0,"span",11),s(17,_e,2,0,"span",12)(18,Ce,2,0,"span",13)(19,pe,2,0,"span",13)(20,ve,4,1),r(),m(21,"div"),s(22,De,3,2,"div"),s(23,be,1,1),r(),s(24,We,6,3,"div",14),r(),m(25,"div",15),s(26,Ge,2,0,"button",16),s(27,ze,4,0),r(),s(28,Je,2,3,"div",15),r()),e&2){let t,o,n=i.$implicit,l=i.$index,_=a(2);q("background",l%2!==0?_.ACCENT_COLOR:null),g("id",mt("appGitfireComment-",n.store.id)),u(3),g("title",H(A(4,19,n.publishAt,"yyyy-MM-dd HH:mm"))),u(2),I("\u6295\u7A3F\u65E5\u6642: ",A(6,22,n.publishAt,"yyyy-MM-dd HH:mm")),u(2),c(n.isEdited?7:-1),u(),c(n.decisionAt?8:-1),u(),c(n.isDisplayAdmin?9:-1),u(3),c((t=y(13,25,n.user$))?12:-1,t),u(4),c(n.store.isAdminEdit?16:-1),u(),c((o=n.store.state)==="rejected"?17:o==="pending"?18:o==="deleted"?19:o==="approved"?20:-1),u(5),c(n.isOwn?22:-1),u(),c(n.isOwn?-1:23),u(),c(n.isOwn||n.isDisplayAdmin?24:-1),u(2),c(n.canReply?26:-1),u(),c(n.canChange?27:-1),u(),c(n.isReplying?28:-1)}}function Qe(e,i){if(e&1){let t=E();m(0,"button",46),x("click",function(n){p(t);let l=a(2);return f(l.onClickMoreComment(n))}),d(1,"\u3055\u3089\u306B\u8AAD\u307F\u8FBC\u3080"),r()}}function Xe(e,i){if(e&1&&(m(0,"div"),ot(1,Ke,29,27,"div",2,Yt),s(3,Qe,2,0,"button",3),r()),e&2){let t=a();u(),rt(t.comments()),u(2),c(t.maybeMoreComment?3:-1)}}var et=class{store;updatedAt;publishAt;decisionAt;isEdited;privateMessage$;editor$;user$;isEditing;isReplying;isDisplayAdmin;canReply;canChange;isOwn},K=class e{constructor(i,t,o,n,l,_){this.auth=i;this.user=t;this.dialog=o;this.firestore=n;this.funcs=l;this.toastr=_;this.comments$=this.pageId$.pipe(R(D=>{let Q=z(this.firestore,"comment/v1/page",D),qt=It(Q,"public").withConverter(this.CommentStoreConverter),Ht=At(qt,Tt("publishAt","desc"),St(30));return bt(Ht,{idField:"id"})}))}ACCENT_COLOR=L.themaColor.EVEN;destroy$=new it;pageId=tt();pageId$=W(this.pageId);isPageProtect=tt(!1);comments$;comments=O([]);commentData={};maybeMoreComment=!1;isLoading=O(!0);CommentStoreConverter=Pt(["decisionAt","publishAt","updatedAt"]);ngOnDestroy(){C("CommentListComponent.OnDestroy()"),this.destroy$.next()}ngOnInit(){C("CommentListComponent.OnInit()"),this.comments$.pipe(nt(this.destroy$)).subscribe(i=>{let t=this.comments();for(let o of i){let n=this.commentData[o.id];n||(n=new et,t.push(n)),n.publishAt=o.publishAt.toDate(),n.updatedAt=o.updatedAt.toDate();let l=n.updatedAt.getTime()-n.publishAt.getTime();if(n.isEdited=o.editedState!=="none"&&Math.abs(l)>5,o.decisionAt&&(n.decisionAt=o.decisionAt.toDate()),n.user$=this.user.user$(o.owner),n.store=o,this.auth.myUid===o.owner||this.auth.isAdmin){if(!n.privateMessage$){let _={pageId:this.pageId(),commentId:o.id};n.privateMessage$=X(_).pipe(R(D=>this.funcs.call("readPrivateComment",D)),Y(D=>D)),n.editor$=n.privateMessage$.pipe(Y(D=>({id:D.id,message:D.message,images:D.images})))}}else n.editor$=X({id:o.id,message:o.message,images:o.images});n.isDisplayAdmin=this.auth.isAdmin,n.isOwn=o.owner===this.auth.myUid,n.canReply=!this.isPageProtect()&&!n.isOwn&&o.state==="approved"&&!o.isProtect,n.canChange=n.isOwn&&!o.isAdminEdit&&!o.isProtect&&o.state==="approved",this.commentData[o.id]=n}this.comments.set(t.sort((o,n)=>n.publishAt.getTime()-o.publishAt.getTime())),this.isLoading.set(!1)})}onClickEdit(i,t){C("CommentListComponent.onClickEdit()"),t.isEditing=!0}async doDeleteRequest(i){let t={pageId:this.pageId(),commentId:i.store.id};try{await this.funcs.call("deleteComment",t),this.toastr.info("\u524A\u9664\u7533\u8ACB\u3057\u307E\u3057\u305F\u3002\u627F\u8A8D\u5F8C\u306B\u524A\u9664\u3055\u308C\u307E\u3059\u3002")}catch(o){w("Error while delete request",o);let n=o instanceof Error?o.message:"Unknown error";this.toastr.error(`\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002 ( ${n} )`)}}async onClickDelete(i,t){C("onClickDelete()",i,t);let o=this.dialog.createHtmlBuilder(),n=new ct(`
<div>
\u7BA1\u7406\u4EBA\u306B\u627F\u8A8D\u3055\u308C\u305F\u5F8C\u3067\u524A\u9664\u3055\u308C\u307E\u3059\u3002\u3088\u308D\u3057\u3044\u3067\u3059\u304B\uFF1F
</div>
`);o.setMessage(n).setType(1).setSize(1).setTitle("\u78BA\u8A8D").okButton(async()=>{await this.doDeleteRequest(t)}).cancelButton(()=>{}).open()}onClickReply(i,t){C("CommentListComponent.onClickReply()",i,t),t.isReplying=!0}onEditDismissed(i){C("CommentListComponent.onEditDismissed()"),i.isEditing=!1}onEditRequested(i){C("CommentListComponent.onEditRequested()"),i.isEditing=!1}onReplyRequested(i){C("CommentListComponent.onReplyRequested()"),i.isReplying=!1}onReplyDismissed(i){C("CommentListComponent.onReplyDismissed()"),i.isReplying=!1}onClickMoreComment(i){C("CommentListComponent.onClickMoreComment()")}async onClickApprove(i,t){C("CommentListComponent.onClickApprove()");let o={pageId:this.pageId(),commentId:t.store.id};try{await this.funcs.call("approveComment",o),this.toastr.info("\u627F\u8A8D\u3057\u307E\u3057\u305F\u3002")}catch(n){w("Error while approve",n);let l=n instanceof Error?n.message:"Unknown error";this.toastr.error(`\u627F\u8A8D\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${l} )`)}}async onClickReject(i,t){C("CommentListComponent.onClickReject()");let o={pageId:this.pageId(),commentId:t.store.id};try{await this.funcs.call("rejectComment",o),this.toastr.info("\u5374\u4E0B\u3057\u307E\u3057\u305F\u3002")}catch(n){w("Error while reject",n);let l=n instanceof Error?n.message:"Unknown error";this.toastr.error(`\u5374\u4E0B\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${l} )`)}}async onClickProtect(i,t){C("CommentListComponent.onClickProtect()");let o={pageId:this.pageId(),commentId:t.store.id};try{await this.funcs.call("protectComment",o),this.toastr.info("\u4FDD\u8B77\u3057\u307E\u3057\u305F\u3002")}catch(n){w("Error while protect",n);let l=n instanceof Error?n.message:"Unknown error";this.toastr.error(`\u4FDD\u8B77\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${l} )`)}}async onClickUnProtect(i,t){C("CommentListComponent.onClickUnProtect()");let o={pageId:this.pageId(),commentId:t.store.id,unprotect:!0};try{await this.funcs.call("protectComment",o),this.toastr.info("\u4FDD\u8B77\u89E3\u9664\u3057\u307E\u3057\u305F\u3002")}catch(n){w("Error while unprotect",n);let l=n instanceof Error?n.message:"Unknown error";this.toastr.error(`\u4FDD\u8B77\u89E3\u9664\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${l} )`)}}static \u0275fac=function(t){return new(t||e)(v($),v(J),v(wt),v(G),v(M),v(k))};static \u0275cmp=S({type:e,selectors:[["gitfire-comment-list"]],inputs:{pageId:[1,"pageId"],isPageProtect:[1,"isPageProtect"]},decls:2,vars:2,consts:[["loadingMessage",""],["role","status",1,"spinner-border","text-primary"],[3,"id","background"],["title","\u53E4\u3044\u6295\u7A3F\u3092\u3055\u3089\u306B\u8AAD\u307F\u8FBC\u307F\u307E\u3059\u3002",1,"btn","btn-primary"],[3,"id"],[3,"title"],[1,"mx-1"],["data-bs-toggle","dropdown",1,"mx-2",2,"position","absolute","right","0px"],[2,"height","2rem"],[3,"userPublic"],[1,"m-1"],[1,"border","border-danger","text-danger","m-1","p-1"],[1,"text-warning"],[1,"text-info"],[1,"p-2"],[1,"m-2"],["title","\u3053\u306E\u30B3\u30E1\u30F3\u30C8\u3078\u8FD4\u4FE1\u3057\u307E\u3059\u3002",1,"btn","btn-primary","m-1"],[1,"gitweeMenuItem"],[1,"dropdown-menu"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem"],["title","\u30B3\u30E1\u30F3\u30C8\u3092\u4FDD\u8B77\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem"],["title","\u30B3\u30E1\u30F3\u30C8\u4FDD\u8B77\u3092\u89E3\u9664\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem",3,"click"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem",3,"click"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem",3,"click"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem",3,"click"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem",3,"click"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem",3,"click"],["title","\u30B3\u30E1\u30F3\u30C8\u3092\u4FDD\u8B77\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem",3,"click"],["title","\u30B3\u30E1\u30F3\u30C8\u4FDD\u8B77\u3092\u89E3\u9664\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem",3,"click"],[1,"p-2",3,"innerHTML"],[3,"pageId","editModel","showDismiss"],[3,"requestSent","editDismiss","pageId","editModel","showDismiss"],[1,"border","border-info"],[1,"border","border-warning"],[3,"innerHTML"],[4,"ngTemplateOutlet"],["title","\u3053\u306E\u30B3\u30E1\u30F3\u30C8\u3078\u8FD4\u4FE1\u3057\u307E\u3059\u3002",1,"btn","btn-primary","m-1",3,"click"],["title","\u6295\u7A3F\u306E\u524A\u9664\u3092\u7533\u8ACB\u3057\u307E\u3059\u3002",1,"btn","btn-warning","m-1",3,"click"],["title","\u30B3\u30E1\u30F3\u30C8\u3092\u7DE8\u96C6\u3057\u307E\u3059\u3002",1,"btn","btn-secondary","m-1",3,"click"],[3,"requestSent","editDismiss","showDismiss","replyId","pageId"],["title","\u53E4\u3044\u6295\u7A3F\u3092\u3055\u3089\u306B\u8AAD\u307F\u8FBC\u307F\u307E\u3059\u3002",1,"btn","btn-primary",3,"click"]],template:function(t,o){if(t&1&&(s(0,Zt,1,0,"span",1),s(1,Xe,4,1,"div")),t&2){let n;c(o.isLoading()?0:-1),u(),c((n=o.comments())?1:-1,n)}},dependencies:[lt,V,Mt,P,st],styles:[".gitweeMenuItem[_ngcontent-%COMP%]{cursor:pointer}"]})};function Ye(e,i){if(e&1){let t=E();m(0,"button",7),x("click",function(){p(t);let n=a(4);return f(n.onClickProtect())}),d(1,"\u30DA\u30FC\u30B8\u3092\u4FDD\u8B77"),r()}}function Ze(e,i){if(e&1){let t=E();m(0,"button",8),x("click",function(){p(t);let n=a(4);return f(n.onClickUnProtect())}),d(1,"\u4FDD\u8B77\u3092\u89E3\u9664"),r()}}function ti(e,i){if(e&1&&s(0,Ye,2,0,"button",5)(1,Ze,2,0,"button",6),e&2){let t=a();c(t.isProtect?1:0)}}function ei(e,i){e&1&&(m(0,"span",9)(1,"span",10),d(2,"\u30DA\u30FC\u30B8\u306F\u4FDD\u8B77\u3055\u308C\u3066\u3044\u307E\u3059"),r()())}function ii(e,i){if(e&1&&s(0,ei,3,0,"span",9),e&2){let t=a();c(t.isProtect?0:-1)}}function ni(e,i){if(e&1){let t=E();m(0,"button",11),x("click",function(n){p(t);let l=a(3);return f(l.onClickWatchPage(n,!0))}),d(1,"Watch(\u30C6\u30B9\u30C8\u4E2D)"),r(),m(2,"button",12),x("click",function(n){p(t);let l=a(3);return f(l.onClickWatchPage(n,!1))}),d(3,"Unwatch(\u30C6\u30B9\u30C8\u4E2D)"),r()}}function oi(e,i){if(e&1&&(m(0,"span",13),d(1),r()),e&2){let t=a(2);u(),I("(\u4FDD\u7559 ",t.countPending," \u4EF6)")}}function ri(e,i){if(e&1&&(m(0,"div",4)(1,"span"),d(2),r(),s(3,oi,2,1,"span",13),r()),e&2){let t=a();u(2),I("",t.countAll," \u4EF6\u306E\u30B3\u30E1\u30F3\u30C8"),u(),c(t.countPending>0?3:-1)}}function ai(e,i){e&1&&(m(0,"div",1),d(1,"\u30B3\u30E1\u30F3\u30C8\u306F\u3042\u308A\u307E\u305B\u3093"),r())}function mi(e,i){if(e&1&&(m(0,"div")(1,"div",1),s(2,ti,2,1)(3,ii,1,1),s(4,ni,4,0),r(),s(5,ri,4,2,"div",4)(6,ai,2,0,"div",1),r()),e&2){let t=a(2);u(2),c(t.auth.isAdmin?2:3),u(2),c(t.auth.hasMessaging?4:-1),u(),c(i.countAll>0?5:6)}}function ui(e,i){e&1&&(m(0,"div",1),d(1,"\u30B3\u30E1\u30F3\u30C8\u306F\u3042\u308A\u307E\u305B\u3093"),r())}function li(e,i){if(e&1&&F(0,"gitfire-comment-editor",2),e&2){let t=a(2);g("pageId",t.pageId())}}function si(e,i){if(e&1&&(m(0,"div"),s(1,mi,7,3,"div"),h(2,"async"),B(3,ui,2,0,"div",1),m(4,"div"),s(5,li,1,1,"gitfire-comment-editor",2),h(6,"async"),F(7,"gitfire-comment-list",3),h(8,"async"),r()()),e&2){let t,o,n,l=a();u(),c((t=y(2,4,l.pageInfo$))?1:3,t),u(4),c((o=y(6,6,l.pageInfo$))!=null&&o.isProtect?-1:5),u(2),g("pageId",l.pageId())("isPageProtect",(n=y(8,8,l.pageInfo$))==null?null:n.isProtect)}}function ci(e,i){e&1&&F(0,"span",0)}var jt=class e{constructor(i,t,o,n,l){this.auth=i;this.firestore=t;this.router=o;this.funcs=n;this.toastr=l;this.pageInfo$=this.pageId$.pipe(R(_=>{let Q=z(this.firestore,"comment/v1/page",_).withConverter(this.PageStoreConverter);return Bt(Q)}))}pagePath;pageJson;pageInfo$;pageId=O(null);pageId$=W(this.pageId).pipe(N(i=>!!i));PageStoreConverter=kt(["lastPostAt","lastUpdatedAt"]);pagePath2PageKey(i){let t=`${L.PAGE_DATA}/`,o=t.length,n=i.jsonPath;if(!n.startsWith(t))throw new Error(`Not a supported path ${n}`);return n.substring(o-1)}buildLeafUrl(){let i=this.pageJson;return i.anchorLink?i.anchorId?`${i.anchorLink}#${i.anchorId}`:i.anchorLink:this.router.url}async ngOnInit(){C("CommentEntryComponent.OnInit()",this.pagePath);let i=this.pageJson?.pageKey||this.pagePath2PageKey(this.pagePath),t=this.buildLeafUrl(),o={pageKey:i,leafUrl:t},n=await this.funcs.call("getPageId",o);this.pageId.set(n),C("getPageId",n,o)}async doProtectPage(i){let t={pageId:this.pageId(),unprotect:i};await this.funcs.call("protectPage",t)}async onClickUnProtect(){C("CommentEntryComponent.onClickUnProtect()");try{this.doProtectPage(!0),this.toastr.info("\u30DA\u30FC\u30B8\u306E\u4FDD\u8B77\u3092\u89E3\u9664\u3057\u307E\u3057\u305F\u3002")}catch(i){w(i);let t=i instanceof Error?i.message:"Unknown error";this.toastr.error(`\u30DA\u30FC\u30B8\u306E\u4FDD\u8B77\u3092\u89E3\u9664\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${t} )`)}}async onClickWatchPage(i,t){C("CommentEntryComponent.onClickWatchPage()");try{let o={pageId:this.pageId(),isWatch:t};await this.funcs.call("watchCommentPage",o),this.toastr.info(t?"\u30DA\u30FC\u30B8\u306E Watch \u3092\u958B\u59CB\u3057\u307E\u3057\u305F\u3002":"\u30DA\u30FC\u30B8\u3092 Watch \u3092\u505C\u6B62\u3057\u307E\u3057\u305F\u3002")}catch(o){w(o);let n=o instanceof Error?o.message:"Unknown error";this.toastr.error(`\u30DA\u30FC\u30B8\u306E Watch \u72B6\u614B\u3092\u5909\u66F4\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${n} )`)}}async onClickProtect(){C("CommentEntryComponent.onClickProtect()");try{this.doProtectPage(!1),this.toastr.info("\u30DA\u30FC\u30B8\u3092\u4FDD\u8B77\u3057\u307E\u3057\u305F\u3002")}catch(i){w(i);let t=i instanceof Error?i.message:"Unknown error";this.toastr.error(`\u30DA\u30FC\u30B8\u3092\u4FDD\u8B77\u72B6\u614B\u306B\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${t} )`)}}static \u0275fac=function(t){return new(t||e)(v($),v(G),v(dt),v(M),v(k))};static \u0275cmp=S({type:e,selectors:[["gitfire-comment-entry"]],inputs:{pagePath:"pagePath",pageJson:"pageJson"},decls:3,vars:1,consts:[["role","status",1,"spinner-border","text-primary"],[1,"text-end"],[3,"pageId"],[3,"pageId","isPageProtect"],[1,"m-1","text-end"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u7981\u6B62\u3057\u307E\u3059\u3002",1,"btn","btn-danger","m-1"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u53EF\u80FD\u306B\u3057\u307E\u3059\u3002",1,"btn","btn-info","m-1"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u7981\u6B62\u3057\u307E\u3059\u3002",1,"btn","btn-danger","m-1",3,"click"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u53EF\u80FD\u306B\u3057\u307E\u3059\u3002",1,"btn","btn-info","m-1",3,"click"],[1,"p-1","border","border-danger"],[1,"text-danger"],["title","\u3053\u306E\u6A5F\u80FD\u306F\u8A66\u9A13\u904B\u7528\u4E2D\u3067\u3059\u3002\u3053\u306E\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3001\u66F4\u65B0\u3092\u901A\u77E5\u3057\u307E\u3059\u3002",1,"btn","btn-secondary","m-1",3,"click"],["title","\u3053\u306E\u6A5F\u80FD\u306F\u8A66\u9A13\u904B\u7528\u4E2D\u3067\u3059\u3002\u3053\u306E\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3001\u66F4\u65B0\u901A\u77E5\u3092\u505C\u6B62\u3057\u307E\u3059\u3002",1,"btn","btn-secondary","m-1",3,"click"],[1,"text-warning"]],template:function(t,o){t&1&&(F(0,"hr"),s(1,si,9,10,"div")(2,ci,1,0,"span",0)),t&2&&(u(),c(o.pageId()?1:2))},dependencies:[V,K,P],encapsulation:2})};export{V as a,K as b,jt as c};
