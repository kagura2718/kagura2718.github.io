import{a as $e}from"./chunk-CEGM4YDP.js";import{d as Se,e as Fe}from"./chunk-PPKZ6WBG.js";import{a as Pe,e as Ge}from"./chunk-CMOT2GVO.js";import{a as _e,b as Ne,c as Re,d as Ue,e as Be,f as Me,g as je,h as qe,i as B,j as Le}from"./chunk-UXGQAVKW.js";import{a as Te,b as Ie,c as we,d as Ae,e as a,l as Ee,m as ke,p as Oe}from"./chunk-XQP67AG3.js";import{$ as X,Ba as u,Cb as le,Eb as c,Fb as me,G as y,Ka as F,M as Z,Oa as ae,Ob as U,P as K,Qc as s,R as g,Tc as T,Va as D,Vc as fe,Xa as b,Yc as pe,Z as S,Zc as Ce,_c as ve,a as W,aa as p,ab as $,ad as ge,b as f,ba as Y,bb as C,ca as ee,cb as v,cd as he,da as te,db as x,eb as _,fb as N,gb as ce,gd as De,hd as be,ia as re,ic as de,la as oe,m as H,ma as ne,nb as R,o as d,pb as ue,ra as h,sd as ye,ya as ie,za as se}from"./chunk-NPI22PXE.js";import{R as xe}from"./chunk-LZXNU2FR.js";import{a as V,d as Q}from"./chunk-VB56BUGO.js";var I=function(){return I=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++){t=arguments[o];for(var m in t)Object.prototype.hasOwnProperty.call(t,m)&&(e[m]=t[m])}return e},I.apply(this,arguments)};var nt={includeMetadataChanges:!1};function M(r,e){return e===void 0&&(e=nt),new W(function(t){var o=B(r,e,{next:t.next.bind(t),error:t.error.bind(t),complete:t.complete.bind(t)});return{unsubscribe:o}})}function Je(r){return M(r,{includeMetadataChanges:!0})}function ze(r,e){return e===void 0&&(e={}),Je(r).pipe(d(function(t){return j(t,e)}))}function j(r,e){var t;e===void 0&&(e={});var o=r.data(e);return!r.exists()||typeof o!="object"||o===null||!e.idField?o:I(I({},o),(t={},t[e.idField]=r.id,t))}function Ve(r){return M(r,{includeMetadataChanges:!0}).pipe(d(function(e){return e.docs}))}function Qe(r,e){return e===void 0&&(e={}),Ve(r).pipe(d(function(t){return t.map(function(o){return j(o,e)})}))}var l=class{constructor(e){return e}},We="firestore",q=class{constructor(){return we(We)}};var L=new X("angularfire2.firestore-instances");function it(r,e){let t=Ie(We,r,e);return t&&new l(t)}function st(r){return(e,t)=>{let o=e.runOutsideAngular(()=>r(t));return new l(o)}}var at={provide:q,deps:[[new h,L]]},ct={provide:l,useFactory:it,deps:[[new h,L],Ee]};function Nr(r,...e){return xe("angularfire",Te.full,"fst"),ee([ct,at,{provide:L,useFactory:st(r),multi:!0,deps:[ne,re,Ae,ke,[new h,Pe],[new h,Oe],...e]}])}var Rr=a(Qe,!0);var w=a(ze,!0);var Ur=a(_e,!0,2);var A=a(Ne,!0,2);var Br=a(Re,!0);var Mr=a(Me,!0,2);var jr=a(Be,!0,2),qr=a(Ue,!0,2);var He=a(je,!0,2);var Lr=a(qe,!0,2);function Jr(r=[]){return{toFirestore(e){let n=e,{id:t}=n;return Q(n,["id"])},fromFirestore(e,t){let o=e.data(t);return V({id:e.id},o)}}}function E(r=[]){return{toFirestore(e){return e},fromFirestore(e,t){return e.data(t)}}}var k=class{saveNeverAsk;isConfirmed};function lt(r,e){r&1&&(C(0,"div",1),x(1,"div",11),v()),r&2&&(u(),$("innerHTML",e.html,ie))}function mt(r,e){r&1&&x(0,"span",2)}var O=class r extends Se{confirmed=new oe;inputConfirmForm;tosJson=de();constructor(){super()}ngOnInit(){s("TosConfirmComponent.OnInit()"),this.inputConfirmForm=new ve({}),this.inputConfirmForm.addControl("neverConfirmTosCheck",new ge(!1))}get neverCheckTosControl(){return this.inputConfirmForm.get("neverConfirmTosCheck")}onClickConfirm(e){if(s("TosConfirmComponent.onClickConfirm()"),e.preventDefault(),this.inputConfirmForm.markAllAsTouched(),this.inputConfirmForm.invalid)return;let t=new k,o=this.inputConfirmForm.get("neverConfirmTosCheck");t.saveNeverAsk=o.value,t.isConfirmed=!0,this.confirmed.emit(t),this.close()}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=F({type:r,selectors:[["gitfire-tos-confirm"]],inputs:{tosJson:[1,"tosJson"]},outputs:{confirmed:"confirmed",tosJson:"tosJsonChange"},features:[ae],decls:18,vars:5,consts:[[1,"container"],[1,"m-3"],["role","status",1,"spinner-border","text-primary"],[1,"text-center"],[3,"formGroup"],[1,"m-5","custom-control","custom-checkbox"],["for","appGitfireTosConfirmNeverDismissCheck",1,"visually-hidden"],["id","appGitfireTosConfirmNeverDismissCheck","name","neverConfirmTosCheck","formControlName","neverConfirmTosCheck","type","checkbox",1,"form-check-input"],[1,"text-muted","fw-light"],["href","/terms.htm","about","_blank"],["id","appGitfireTosConfirmButton",1,"btn","btn-success",3,"click","disabled"],[3,"innerHTML"]],template:function(t,o){if(t&1&&(C(0,"div",0),D(1,lt,2,1,"div",1)(2,mt,1,0,"span",2),C(3,"div",3)(4,"form",4)(5,"div",5)(6,"label",6),c(7,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),v(),x(8,"input",7),c(9,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),v(),C(10,"div",8),c(11,"\u8A73\u3057\u304F\u306F"),C(12,"a",9),c(13,"[\u5229\u7528\u898F\u7D04]"),v(),c(14,"\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002 "),v(),C(15,"div",1)(16,"button",10),ue("click",function(m){return o.onClickConfirm(m)}),c(17,"\u78BA\u8A8D\u3057\u307E\u3057\u305F"),v()()()()()),t&2){let n;u(),b((n=o.tosJson())?1:2,n),u(3),$("formGroup",o.inputConfirmForm),u(),le("was-validated",o.neverCheckTosControl.dirty||o.neverCheckTosControl.touched),u(11),$("disabled",!o.inputConfirmForm.valid)}},dependencies:[ye,he,fe,pe,Ce,be,De],encapsulation:2})};var Ke=class r{constructor(e,t,o){this.http=e;this.dialog=t;this.firestore=o}UserAgreementConverter=E(["createdAt"]);ProtectedUserPrefix="users/v1/protected";destroy$=new f;ngOnDestroy(){s("TosService.OnDestroy()"),this.destroy$.next()}constructSetupTosConfirm(e,t){return o=>{o.tosJson.set(t.json),o.confirmed.pipe(g(this.destroy$)).subscribe(n=>{if(!n.isConfirmed)throw new Error("assert");n.saveNeverAsk?t.answer=2:t.answer=0,e.next(t)})}}confirmTos$(e,t){if(e.match(/\/$/))throw new Error(`Assertion. Not a supported ${e}`);let o=new f,n=new f,m=new f,et=this.http.fetchGhJson(t).pipe(y(1),K(i=>{let P=`${this.ProtectedUserPrefix}/${e}/${i.version}`,J=A(this.firestore,P).withConverter(this.UserAgreementConverter),z={json:i,cached:!1,cacheRef:J};return w(J).pipe(d(tt=>(tt?.alwaysConfirmed&&(s("TOS has already been confirmed."),z.cached=!0),z)))}));return m.pipe(g(this.destroy$)).subscribe({next:i=>{this.dialog.createDefaultBuilder().prepareBody(O).setupChild(this.constructSetupTosConfirm(n,i)).setType(1).setSize(1).setTitle("\u5229\u7528\u898F\u7D04\u306E\u78BA\u8A8D").closeButton(()=>{i.answer=1,n.next(i)}).setFinalize(()=>{i.answer=1,n.next(i)}).open()},complete:()=>{s("completed dialog$")},error:i=>{T("error dialog$",i)}}),et.pipe(y(1),g(this.destroy$)).subscribe({next:i=>{if(i.cached){o.next(!0);return}m.next(i)},complete:()=>{s("Completed TOS reading")},error:i=>{T("Failed reading TOS cache",i)}}),n.pipe(y(1),g(this.destroy$)).subscribe({next:async i=>{switch(i.answer){case 0:o.next(!0);break;case 1:o.next(!1);break;case 2:let P={_docClass:"User:UserAgreementStore",alwaysConfirmed:!0,createdAt:Le()};o.next(!0),await He(i.cacheRef,P);break;default:throw new Error(`Not a valid answer ${i.answer}`)}},complete:()=>{s("Completed dialog result."),o.complete()},error:i=>{T("Failed receive dialog result"),o.complete()}}),o}static \u0275fac=function(t){return new(t||r)(p($e),p(Fe),p(l))};static \u0275prov=S({token:r,factory:r.\u0275fac,providedIn:"root"})};var Xe=class r{constructor(e,t){this.firestore=e;this.auth=t}destroy$=new f;nicknameCache={};userCache={};env=Y(te);UserPublicConverter=E(["createdAt","updatedAt"]);ngOnDestroy(){s("UserService.OnDestroy"),this.destroy$.next()}myNickname$(){return this.auth.myUid?this.nickname$(this.auth.myUid):H("")}user$(e){let t=this.userCache[e];if(t)return t;let o=A(this.firestore,`users/v1/public/${e}`).withConverter(this.UserPublicConverter);return t=w(o).pipe(Z(1)),this.userCache[e]=t,t}nickname$(e){let t=this.nicknameCache[e];return t||(t=this.user$(e).pipe(d(o=>o?o.nickname:null)),this.nicknameCache[e]=t,t)}static \u0275fac=function(t){return new(t||r)(p(l),p(Ge))};static \u0275prov=S({token:r,factory:r.\u0275fac,providedIn:"root"})};function dt(r,e){r&1&&ce(0,"img",2),r&2&&R("src",U(e),se)}function ft(r,e){if(r&1&&(_(0,"span",0),D(1,dt,1,2,"img",2),c(2),N()),r&2){let t,o=e;R("title",U(o.about)),u(),b((t=o.photoURL)?1:-1,t),u(),me(o.nickname)}}function pt(r,e){r&1&&(_(0,"span",1),c(1,"[\u524A\u9664]"),N())}var Ye=class r{userPublic;constructor(){}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=F({type:r,selectors:[["gitfire-user-box"]],inputs:{userPublic:"userPublic"},decls:2,vars:1,consts:[[1,"p-1",3,"title"],["title","\u524A\u9664\u3055\u308C\u305F\u30E6\u30FC\u30B6\u3067\u3059",1,"text-warning"],[1,"p-1",2,"height","100%","width","2rem",3,"src"]],template:function(t,o){if(t&1&&D(0,ft,3,4,"span",0)(1,pt,2,0,"span",1),t&2){let n;b((n=o.userPublic)?0:1,n)}},encapsulation:2})};export{l as a,Nr as b,Rr as c,w as d,Ur as e,A as f,Br as g,Mr as h,jr as i,qr as j,Lr as k,Jr as l,E as m,Ke as n,Xe as o,Ye as p};
