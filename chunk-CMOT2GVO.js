import{k as Pe}from"./chunk-UXGQAVKW.js";import{a as ke}from"./chunk-DG46H57O.js";import{a as ce}from"./chunk-GWNSOZ2S.js";import{a as H,b as z,c as y,d as j,e as w,l as Ee,m as Se,p as Ie,x as be}from"./chunk-XQP67AG3.js";import{$ as te,E as Q,G as Z,H as M,M as x,Oc as _,P as S,Qc as f,R as I,Rc as g,S as ee,Tc as b,Z as U,aa as m,b as C,ba as ne,ca as re,d as W,da as ie,ea as se,ia as oe,m as L,ma as ae,ra as R,z as K}from"./chunk-NPI22PXE.js";import{E as $,F as me,K as fe,L as ge,M as Ae,P as ve,R as P,d as ue,g as le,h as de,j as he,w as pe}from"./chunk-LZXNU2FR.js";var Dt="auth";var N=class{constructor(){return y(Dt)}};var Wt="type.googleapis.com/google.protobuf.Int64Value",Lt="type.googleapis.com/google.protobuf.UInt64Value";function Ue(e,t){let n={};for(let r in e)e.hasOwnProperty(r)&&(n[r]=t(e[r]));return n}function F(e){if(e==null)return null;if(e instanceof Number&&(e=e.valueOf()),typeof e=="number"&&isFinite(e)||e===!0||e===!1||Object.prototype.toString.call(e)==="[object String]")return e;if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(t=>F(t));if(typeof e=="function"||typeof e=="object")return Ue(e,t=>F(t));throw new Error("Data cannot be encoded in JSON: "+e)}function k(e){if(e==null)return e;if(e["@type"])switch(e["@type"]){case Wt:case Lt:{let t=Number(e.value);if(isNaN(t))throw new Error("Data cannot be decoded from JSON: "+e);return t}default:throw new Error("Data cannot be decoded from JSON: "+e)}return Array.isArray(e)?e.map(t=>k(t)):typeof e=="function"||typeof e=="object"?Ue(e,t=>k(t)):e}var q="functions";var Re={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},d=class e extends pe{constructor(t,n,r){super(`${q}/${t}`,n||""),this.details=r,Object.setPrototypeOf(this,e.prototype)}};function Mt(e){if(e>=200&&e<300)return"ok";switch(e){case 0:return"internal";case 400:return"invalid-argument";case 401:return"unauthenticated";case 403:return"permission-denied";case 404:return"not-found";case 409:return"aborted";case 429:return"resource-exhausted";case 499:return"cancelled";case 500:return"internal";case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline-exceeded"}return"unknown"}function O(e,t){let n=Mt(e),r=n,i;try{let c=t&&t.error;if(c){let o=c.status;if(typeof o=="string"){if(!Re[o])return new d("internal","internal");n=Re[o],r=o}let a=c.message;typeof a=="string"&&(r=a),i=c.details,i!==void 0&&(i=k(i))}}catch{}return n==="ok"?null:new d(n,r,i)}var V=class{constructor(t,n,r,i){this.app=t,this.auth=null,this.messaging=null,this.appCheck=null,this.serverAppAppCheckToken=null,Ae(t)&&t.settings.appCheckToken&&(this.serverAppAppCheckToken=t.settings.appCheckToken),this.auth=n.getImmediate({optional:!0}),this.messaging=r.getImmediate({optional:!0}),this.auth||n.get().then(c=>this.auth=c,()=>{}),this.messaging||r.get().then(c=>this.messaging=c,()=>{}),this.appCheck||i?.get().then(c=>this.appCheck=c,()=>{})}async getAuthToken(){if(this.auth)try{let t=await this.auth.getToken();return t?.accessToken}catch{return}}async getMessagingToken(){if(!(!this.messaging||!("Notification"in self)||Notification.permission!=="granted"))try{return await this.messaging.getToken()}catch{return}}async getAppCheckToken(t){if(this.serverAppAppCheckToken)return this.serverAppAppCheckToken;if(this.appCheck){let n=t?await this.appCheck.getLimitedUseToken():await this.appCheck.getToken();return n.error?null:n.token}return null}async getContext(t){let n=await this.getAuthToken(),r=await this.getMessagingToken(),i=await this.getAppCheckToken(t);return{authToken:n,messagingToken:r,appCheckToken:i}}};var G="us-central1",xt=/^data: (.*?)(?:\n|$)/;function _t(e){let t=null;return{promise:new Promise((n,r)=>{t=setTimeout(()=>{r(new d("deadline-exceeded","deadline-exceeded"))},e)}),cancel:()=>{t&&clearTimeout(t)}}}var B=class{constructor(t,n,r,i,c=G,o=(...a)=>fetch(...a)){this.app=t,this.fetchImpl=o,this.emulatorOrigin=null,this.contextProvider=new V(t,n,r,i),this.cancelAllRequests=new Promise(a=>{this.deleteService=()=>Promise.resolve(a())});try{let a=new URL(c);this.customDomain=a.origin+(a.pathname==="/"?"":a.pathname),this.region=G}catch{this.customDomain=null,this.region=c}}_delete(){return this.deleteService()}_url(t){let n=this.app.options.projectId;return this.emulatorOrigin!==null?`${this.emulatorOrigin}/${n}/${this.region}/${t}`:this.customDomain!==null?`${this.customDomain}/${t}`:`https://${this.region}-${n}.cloudfunctions.net/${t}`}};function Ht(e,t,n){let r=le(t);e.emulatorOrigin=`http${r?"s":""}://${t}:${n}`,r&&(de(e.emulatorOrigin),he("Functions",!0))}function zt(e,t,n){let r=i=>Vt(e,t,i,n||{});return r.stream=(i,c)=>Bt(e,t,i,c),r}async function jt(e,t,n,r){n["Content-Type"]="application/json";let i;try{i=await r(e,{method:"POST",body:JSON.stringify(t),headers:n})}catch{return{status:0,json:null}}let c=null;try{c=await i.json()}catch{}return{status:i.status,json:c}}async function $e(e,t){let n={},r=await e.contextProvider.getContext(t.limitedUseAppCheckTokens);return r.authToken&&(n.Authorization="Bearer "+r.authToken),r.messagingToken&&(n["Firebase-Instance-ID-Token"]=r.messagingToken),r.appCheckToken!==null&&(n["X-Firebase-AppCheck"]=r.appCheckToken),n}function Vt(e,t,n,r){let i=e._url(t);return Gt(e,i,n,r)}async function Gt(e,t,n,r){n=F(n);let i={data:n},c=await $e(e,r),o=r.timeout||7e4,a=_t(o),s=await Promise.race([jt(t,i,c,e.fetchImpl),a.promise,e.cancelAllRequests]);if(a.cancel(),!s)throw new d("cancelled","Firebase Functions instance was deleted.");let l=O(s.status,s.json);if(l)throw l;if(!s.json)throw new d("internal","Response is not valid JSON object.");let u=s.json.data;if(typeof u>"u"&&(u=s.json.result),typeof u>"u")throw new d("internal","Response is missing data field.");return{data:k(u)}}function Bt(e,t,n,r){let i=e._url(t);return qt(e,i,n,r||{})}async function qt(e,t,n,r){var i;n=F(n);let c={data:n},o=await $e(e,r);o["Content-Type"]="application/json",o.Accept="text/event-stream";let a;try{a=await e.fetchImpl(t,{method:"POST",body:JSON.stringify(c),headers:o,signal:r?.signal})}catch(h){if(h instanceof Error&&h.name==="AbortError"){let T=new d("cancelled","Request was cancelled.");return{data:Promise.reject(T),stream:{[Symbol.asyncIterator](){return{next(){return Promise.reject(T)}}}}}}let E=O(0,null);return{data:Promise.reject(E),stream:{[Symbol.asyncIterator](){return{next(){return Promise.reject(E)}}}}}}let s,l,u=new Promise((h,E)=>{s=h,l=E});(i=r?.signal)===null||i===void 0||i.addEventListener("abort",()=>{let h=new d("cancelled","Request was cancelled.");l(h)});let p=a.body.getReader(),A=Jt(p,s,l,r?.signal);return{stream:{[Symbol.asyncIterator](){let h=A.getReader();return{async next(){let{value:E,done:T}=await h.read();return{value:E,done:T}},async return(){return await h.cancel(),{done:!0,value:void 0}}}}},data:u}}function Jt(e,t,n,r){let i=(o,a)=>{let s=o.match(xt);if(!s)return;let l=s[1];try{let u=JSON.parse(l);if("result"in u){t(k(u.result));return}if("message"in u){a.enqueue(k(u.message));return}if("error"in u){let p=O(0,u);a.error(p),n(p);return}}catch(u){if(u instanceof d){a.error(u),n(u);return}}},c=new TextDecoder;return new ReadableStream({start(o){let a="";return s();async function s(){if(r?.aborted){let l=new d("cancelled","Request was cancelled");return o.error(l),n(l),Promise.resolve()}try{let{value:l,done:u}=await e.read();if(u){a.trim()&&i(a.trim(),o),o.close();return}if(r?.aborted){let A=new d("cancelled","Request was cancelled");o.error(A),n(A),await e.cancel();return}a+=c.decode(l,{stream:!0});let p=a.split(`
`);a=p.pop()||"";for(let A of p)A.trim()&&i(A.trim(),o);return s()}catch(l){let u=l instanceof d?l:O(0,null);o.error(u),n(u)}}},cancel(){return e.cancel()}})}var Te="@firebase/functions",Ce="0.12.9";var Xt="auth-internal",Yt="app-check-internal",Kt="messaging-internal";function Qt(e){let t=(n,{instanceIdentifier:r})=>{let i=n.getProvider("app").getImmediate(),c=n.getProvider(Xt),o=n.getProvider(Kt),a=n.getProvider(Yt);return new B(i,c,o,a,r)};fe(new me(q,t,"PUBLIC").setMultipleInstances(!0)),P(Te,Ce,e),P(Te,Ce,"esm2017")}function ye(e=ve(),t=G){let r=ge($(e),q).getImmediate({identifier:t}),i=ue("functions");return i&&we(r,...i),r}function we(e,t,n){Ht($(e),t,n)}function Ne(e,t,n){return zt($(e),t,n)}Qt();var v=class{constructor(t){return t}},Fe="functions",J=class{constructor(){return y(Fe)}};var X=new te("angularfire2.functions-instances");function Zt(e,t){let n=z(Fe,e,t);return n&&new v(n)}function en(e){return(t,n)=>{let r=t.runOutsideAngular(()=>e(n));return new v(r)}}var tn={provide:J,deps:[[new R,X]]},nn={provide:v,useFactory:Zt,deps:[[new R,X],Ee]};function pr(e,...t){return P("angularfire",H.full,"fn"),re([nn,tn,{provide:X,useFactory:en(e),multi:!0,deps:[ae,oe,j,Se,[new R,N],[new R,Ie],...t]}])}var mr=w(ye,!0),Oe=w(Ne,!0);var D=class e{constructor(t){this.remote=t;f("LocalFunctionsService.constructor()")}destroy$=new C;ngOnDestroy(){f("LocalFunctionsService.OnDestroy()"),this.destroy$.next()}async action(t){this.call(t,void 0)}async read(t){return this.call(t,void 0)}async call(t,n){return this.execute(t,n)}async execute(t,n){return(await Oe(this.remote,t)(n)).data}static \u0275fac=function(n){return new(n||e)(m(v))};static \u0275prov=U({token:e,factory:e.\u0275fac,providedIn:"root"})};var Y=class{constructor(t,n,r,i,c){this.auth=t;this.funcs=n;this.localSession=r;this.store=i;this.dom=c;f("SingletonAuth.constructor()"),this.dom.addResourceHint("https://identitytoolkit.googleapis.com","preconnect"),this.dom.addResourceHint("https://firebaseinstallations.googleapis.com","preconnect"),this.dom.addResourceHint("https://firestore.googleapis.com","preconnect"),this.dom.addResourceHint("https://apis.google.com","preconnect"),this.dom.addResourceHint(`https://${_.firebaseConfig.authDomain}`,"preconnect"),this.dom.addResourceHint(`https://${_.FirebaseCloudFunctionsHost}`,"preconnect");let o=this.auth.user.pipe(M());o.pipe(M(),I(this.finalize$)).subscribe(s=>{this.sourceValue$.next()}),this.state$=o.pipe(K(s=>s!==null)),this.localSession.markedLogout$.pipe(I(this.finalize$)).subscribe(()=>{this.sourceValue$.next()}),this.state$.pipe(I(this.finalize$)).subscribe({error:s=>{b("AuthService.state$ error",s),this.doFinalize()},complete:()=>{g("AuthService.state$ completed."),this.doFinalize()}}),this.state$.pipe(S(s=>se(this.env,()=>this.store.collection(`/users/v1/protected/${s.uid}/fcm`).valueChanges().pipe(ee(l=>f("UserProtectedStore has changed.",l))))),I(this.finalize$)).subscribe({next:s=>{this.sourceValue$.next()},error:s=>{b("AuthService.state$ Maybe after logout permission error. Ignore it.",s),this.doFinalize()},complete:()=>{g("AuthService.state$ completed."),this.doFinalize()}});let a=this.state$.pipe(S(async s=>{try{let l=await this.funcs.read("readUserSettings"),u=s;return u.isAdmin=l.isAdmin,u.isDeveloper=l.isDeveloper,u.hasMessaging=l.hasMessaging,u}catch(l){return b("AuthService while check user settings.",l),null}}));this.localUser$=this.sourceValue$.pipe(Q(100),S(()=>o.pipe(S(s=>s===null?L(null):a))),x(1)),this.localUser$.pipe(I(this.finalize$)).subscribe({next:async s=>{f("AuthService.localUser$.subscribe()",s),s?(this.loginUid=s.uid,this.isAdminUser=!!s.isAdmin,this.isDevelopUser=!!s.isDeveloper,this.hasMessagingDevice=!!s.hasMessaging,this.localSession.updateLoginPhoto(s.photoURL),this.localSession.markLogin()):(this.localSession.unmarkLogin(),this.localSession.updateLoginPhoto(null),this.loginUid=null,this.isAdminUser=!1,this.isDevelopUser=!1,this.hasMessagingDevice=!1,g("Explicitly logout on client sdk."),await this.auth.signOut())},complete:()=>{g("AuthService.localUser$ complete."),this.doFinalize()},error:s=>{b("AuthService.localUser$ error while retrieving.",s),this.doFinalize()}})}finalize$=new C;state$;localUser$;isAdminUser=!1;isDevelopUser=!1;hasMessagingDevice=!1;loginUid=null;env=ne(ie);sourceValue$=new W;doFinalize(){this.finalize$.isStopped||(g("Do finalize Singleton Auth"),this.finalize$.next(),this.finalize$.complete())}},De=class e{constructor(t,n,r,i,c){this.auth=t;this.funcs=n;this.localSession=r;this.store=i;this.dom=c;f("AuthService.constructor()");let o=new W;e.AUTH===null&&(e.AUTH=new Y(t,n,r,i,c),e.AUTH.finalize$.pipe(Z(1)).subscribe({next:()=>{g("Finalize singleton auth continue..")},complete:()=>{g("Finalizing singleton auth completed."),e.AUTH=null,o.next()},error:a=>{b("Finalizing singleton auth cause by error.",a),e.AUTH=null,o.next()}})),this._clientSideUser$=o.pipe(S(()=>e.AUTH===null?L(null):e.AUTH.localUser$),x(1)),o.next()}static AUTH=null;_clientSideUser$;get clientSideUser$(){return this._clientSideUser$}get isAdmin(){return e.AUTH?e.AUTH.isAdminUser:!1}get isDeveloper(){return e.AUTH?e.AUTH.isDevelopUser:!1}get hasMessaging(){return e.AUTH?e.AUTH.hasMessagingDevice:!1}get myUid(){return e.AUTH?e.AUTH.loginUid:null}static \u0275fac=function(n){return new(n||e)(m(be),m(D),m(ce),m(Pe),m(ke))};static \u0275prov=U({token:e,factory:e.\u0275fac,providedIn:"root"})};export{N as a,pr as b,mr as c,D as d,De as e};
