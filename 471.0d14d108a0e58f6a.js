"use strict";(self.webpackChunkKaguraGithubPages=self.webpackChunkKaguraGithubPages||[]).push([[471],{471:(lt,I,a)=>{a.r(I),a.d(I,{GitfireChatModule:()=>ut});var u=a(9417),l=a(177),p=a(5794),F=a(4871),k=a(467),$=a(7935),C=a(8455),D=a(6354),h=a(5312),t=a(4438),y=a(896),G=a(1474),N=a(8334),B=a(9243);let g=(()=>{class i{tos;auth;store;funcs;user;room;roomIndex;constructor(o,e,n,r,c){this.tos=o,this.auth=e,this.store=n,this.funcs=r,this.user=c,this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}fieldTimestamp(){return $.A.firestore.FieldValue.serverTimestamp()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,h.cA.ChatServiceTosUrl)}readChitchat$(o){return this.room.doc(o).collection("chitchat",e=>e.orderBy("createdAt","desc").limit(30))}postComment$(o,e){return(0,C.H)(this.funcs.call("postChat",{roomId:o,text:e}))}deleteRoom$(o){var e=this;if(!o)throw new Error("roomId is not supplied");const n=this.room.doc(o);return(0,C.H)(this.store.firestore.runTransaction(function(){var r=(0,k.A)(function*(c){const f=(yield c.get(n.ref)).data().nick,E=e.roomIndex.doc(f);yield c.delete(n.ref),yield c.delete(E.ref)});return function(c){return r.apply(this,arguments)}}()))}ensureRoom$(o){var e=this;if(!o)throw new Error("room nick is not supplied");const r=this.roomIndex.doc(o);return(0,C.H)(this.store.firestore.runTransaction(function(){var c=(0,k.A)(function*(s){const x=yield s.get(r.ref);if(x.exists){const j=x.data();return{id:j.value,nick:o,isOwned:j.owner===e.auth.myUid,isExisting:!0}}const f=e.room.ref.doc(),E={nick:o,owner:e.auth.myUid,createdAt:e.fieldTimestamp()};yield s.set(f,E);const mt={value:f.id,owner:e.auth.myUid};return yield s.set(r.ref,mt),{id:f.id,nick:o,isExisting:!1,isOwned:!0}});return function(s){return c.apply(this,arguments)}}()))}maybeRoomInfo$(o){return this.roomIndex.doc(o).get().pipe((0,D.T)(n=>{let r={nick:o,isExisting:!!n.exists};if(!n.exists)return r;const c=n.data();return r.isOwned=c.owner===this.auth.myUid,r.id=c.value,r}))}static \u0275fac=function(e){return new(e||i)(t.KVO(y.u),t.KVO(G.u),t.KVO(N.Qe),t.KVO(F.Y),t.KVO(B.D))};static \u0275prov=t.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var A=a(3691),d=a(1188),R=a(1413),M=a(4412),V=a(4779),b=a(7673),S=a(6697),v=a(5558),Y=a(1033);class w{id;text;admin;html;createdAt;user$;constructor(m,o,e,n,r,c){this.id=m,this.text=o,this.admin=e,this.html=n,this.createdAt=r,this.user$=c}}var T=a(2275),U=a(4416),_=a(681),O=a(4906);const X=["chatBox"];function H(i,m){1&i&&t.nrm(0,"div",9)}function K(i,m){1&i&&t.nrm(0,"gitfire-user-box",16),2&i&&t.Y8G("userPublic",m.ngIf)}function P(i,m){if(1&i&&t.nrm(0,"div",17),2&i){const o=t.XpG().$implicit;t.Y8G("innerHTML",o.html,t.npT)}}function Q(i,m){if(1&i&&(t.j41(0,"div",18),t.EFF(1),t.k0s()),2&i){const o=t.XpG().$implicit;t.R7$(),t.JRh(o.text)}}function J(i,m){if(1&i&&(t.j41(0,"div",10)(1,"div",11),t.EFF(2),t.nI1(3,"relativeTime"),t.k0s(),t.j41(4,"div",12),t.DNE(5,K,1,1,"gitfire-user-box",13),t.nI1(6,"async"),t.k0s(),t.DNE(7,P,1,1,"div",14)(8,Q,2,1,"div",15),t.k0s()),2&i){const o=m.$implicit;t.Y8G("ngClass",o.admin?"bg-info text-white":"text-muted"),t.R7$(2),t.SpI("",t.bMT(3,5,o.createdAt)," "),t.R7$(3),t.Y8G("ngIf",t.bMT(6,7,o.user$)),t.R7$(2),t.Y8G("ngIf",o.html),t.R7$(),t.Y8G("ngIf",!o.html)}}let L=(()=>{class i{chat;dialog;toastr;destroy$=new R.B;roomInfo;exitRoom=new t.bkB;message="";chatBox;chitchat=[];chitchatMap={};constructor(o,e,n){this.chat=o,this.dialog=e,this.toastr=n}ngOnInit(){this.chat.readChitchat$(this.roomInfo.id).valueChanges({idField:"id"}).subscribe(e=>{(0,h.Oi)("Receive ChitChat",e);for(const n of e){const r=n.id;let c=this.chitchatMap[r];const s=n;c||(c=new w(r,s.text,!!s.admin,s.html,s.createdAt?s.createdAt.toDate():new Date,this.chat.user.user$(s.uid)),this.chitchat.push(c),this.chitchatMap[r]=c)}this.chitchat=this.chitchat.sort((n,r)=>this.descDate(n.createdAt,r.createdAt))})}descDate(o,e){return o===e?0:o<e?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo.id).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524a\u9664\u3057\u307e\u3057\u305f\u3002")})}onClickDeleteRoom(o){this.dialog.createSimpleBuilder().setType(T.hs.Warn).setSize(T.EV.Default).setTitle("\u78ba\u8a8d").setMessage("\u672c\u5f53\u306b\u524a\u9664\u3057\u307e\u3059\u304b\uff1f").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(o){this.exitRoom.emit()}onPostComment(o){this.chatBox.invalid||this.chat.postComment$(this.roomInfo.id,this.message).subscribe(e=>{const n=this.chatBox.control;n.setValue(""),n.markAsPristine()},e=>{(0,h.sJ)("Error while post chat",e);const n=e instanceof Error?e.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307e\u3057\u305f\u3002 ( ${n} )`)})}static \u0275fac=function(e){return new(e||i)(t.rXU(g),t.rXU(U.o3),t.rXU(p.tw))};static \u0275cmp=t.VBU({type:i,selectors:[["gitfire-chat-room"]],viewQuery:function(e,n){if(1&e&&t.GBs(X,5),2&e){let r;t.mGM(r=t.lsd())&&(n.chatBox=r.first)}},inputs:{roomInfo:"roomInfo"},outputs:{exitRoom:"exitRoom"},decls:12,vars:8,consts:[["chatBox","ngModel"],[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"click","disabled","title"],["title","\u5165\u53e3\u306b\u623b\u308a\u307e\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModelChange","keyup.enter","ngModel"],[1,"col-3","btn","btn-primary",3,"click","disabled"],["class","valid-feedback",4,"ngIf"],["class","row m-3",3,"ngClass",4,"ngFor","ngForOf"],[1,"valid-feedback"],[1,"row","m-3",3,"ngClass"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic",4,"ngIf"],["class","col-8",3,"innerHTML",4,"ngIf"],["class","col-8",4,"ngIf"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(e,n){if(1&e){const r=t.RV6();t.j41(0,"div",1)(1,"button",2),t.bIt("click",function(s){return t.eBV(r),t.Njj(n.onClickDeleteRoom(s))}),t.EFF(2,"\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u524a\u9664"),t.k0s(),t.j41(3,"button",3),t.bIt("click",function(s){return t.eBV(r),t.Njj(n.onClickExitRoom(s))}),t.EFF(4,"\u9000\u5ba4"),t.k0s()(),t.j41(5,"div",4)(6,"input",5,0),t.mxI("ngModelChange",function(s){return t.eBV(r),t.DH7(n.message,s)||(n.message=s),t.Njj(s)}),t.bIt("keyup.enter",function(s){return t.eBV(r),t.Njj(n.onPostComment(s))}),t.k0s(),t.j41(8,"button",6),t.bIt("click",function(s){return t.eBV(r),t.Njj(n.onPostComment(s))}),t.EFF(9,"\u9001\u4fe1"),t.k0s(),t.DNE(10,H,1,0,"div",7),t.k0s(),t.DNE(11,J,9,9,"div",8)}if(2&e){const r=t.sdS(7);t.R7$(),t.Y8G("disabled",!n.roomInfo.isOwned)("title",n.roomInfo.isOwned?"":"\u30eb\u30fc\u30e0\u3092\u958b\u8a2d\u3057\u305f\u4eba\u3060\u3051\u304c\u524a\u9664\u3067\u304d\u307e\u3059\u3002"),t.R7$(4),t.AVh("was-validated",r.dirty||r.touched),t.R7$(),t.R50("ngModel",n.message),t.R7$(2),t.Y8G("disabled",!r.valid),t.R7$(2),t.Y8G("ngIf",r.valid),t.R7$(),t.Y8G("ngForOf",n.chitchat)}},dependencies:[l.YU,l.Sq,l.bT,u.me,u.BC,u.YS,u.tU,u.vS,_.g,l.Jj,O.C]})}return i})();var z=a(5964);const W=["inputRoomForm"];function Z(i,m){1&i&&(t.j41(0,"div",15),t.EFF(1,"\u90e8\u5c4b\u306e\u540d\u524d(\u30cb\u30c3\u30af\u30cd\u30fc\u30e0)\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),t.k0s())}function q(i,m){1&i&&(t.j41(0,"div",15),t.EFF(1,"\u77ed\u3059\u304e\u307e\u3059\u3002"),t.k0s())}function tt(i,m){1&i&&(t.j41(0,"div",15),t.EFF(1,"\u9577\u3059\u304e\u307e\u3059\u3002"),t.k0s())}function ot(i,m){if(1&i&&(t.qex(0),t.DNE(1,Z,2,0,"div",14)(2,q,2,0,"div",14)(3,tt,2,0,"div",14),t.bVm()),2&i){t.XpG();const o=t.sdS(23);t.R7$(),t.Y8G("ngIf",null==o.errors?null:o.errors.required),t.R7$(),t.Y8G("ngIf",null==o.errors?null:o.errors.minlength),t.R7$(),t.Y8G("ngIf",null==o.errors?null:o.errors.maxlength)}}let et=(()=>{class i{chat;toastr;roomSelected=new t.bkB;initialRoomNick;inputRoomForm;roomNick;nickname;constructor(o,e){this.chat=o,this.toastr=e}ngOnInit(){this.roomNick=this.initialRoomNick,this.chat.user.myNickname$().subscribe(o=>{this.nickname=o})}onEnterRoom(o){if(!this.inputRoomForm.valid)return;const e=this.roomNick;this.chat.confirmTos$().pipe((0,z.p)(n=>n),(0,v.n)(n=>this.chat.ensureRoom$(e))).subscribe(n=>{(0,h.Oi)(`Creating room id: ${n.id} with ${n.nick}`),this.roomNick="",this.toastr.info(n.isExisting?`chat \u30eb\u30fc\u30e0 "${e}" \u306b\u5165\u5ba4\u3057\u307e\u3059\u3002`:`\u65b0\u3057\u3044 chat \u30eb\u30fc\u30e0 "${e}" \u3092\u4f5c\u308a\u307e\u3057\u305f\u3002`),this.roomSelected.emit(n)})}static \u0275fac=function(e){return new(e||i)(t.rXU(g),t.rXU(p.tw))};static \u0275cmp=t.VBU({type:i,selectors:[["gitfire-chat-entrance"]],viewQuery:function(e,n){if(1&e&&t.GBs(W,5),2&e){let r;t.mGM(r=t.lsd())&&(n.inputRoomForm=r.first)}},inputs:{initialRoomNick:"initialRoomNick"},outputs:{roomSelected:"roomSelected"},decls:27,vars:9,consts:[["chatConfigureForm","ngForm"],["nickNameBox","ngModel"],["inputRoomForm","ngForm"],["roomBox","ngModel"],["routerLink","/Gitfire/settings"],[1,""],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4f8b: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModelChange","ngModel","disabled"],["title","\u5165\u5ba4\u3059\u308b\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u540d\u524d\u3067\u3059\u3002\u5b58\u5728\u3057\u306a\u3044\u540d\u524d\u306e\u5834\u5408\u306f\u65b0\u3057\u3044\u90e8\u5c4b\u304c\u4f5c\u3089\u308c\u307e\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"click","disabled"],[4,"ngIf"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]],template:function(e,n){if(1&e){const r=t.RV6();t.j41(0,"div")(1,"p"),t.EFF(2,"Chat \u3067\u4f7f\u3046\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3067\u3059\u3002"),t.j41(3,"a",4),t.EFF(4,"[\u8a2d\u5b9a]"),t.k0s(),t.EFF(5,"\u304b\u3089\u5909\u66f4\u3067\u304d\u307e\u3059\u3002"),t.k0s(),t.j41(6,"form",5,0)(8,"div",6)(9,"label",7),t.EFF(10,"\u30cb\u30c3\u30af\u30cd\u30fc\u30e0"),t.k0s(),t.j41(11,"input",8,1),t.mxI("ngModelChange",function(s){return t.eBV(r),t.DH7(n.nickname,s)||(n.nickname=s),t.Njj(s)}),t.k0s()()()(),t.j41(13,"div")(14,"h2"),t.EFF(15,"Chat Room \u306e\u540d\u524d"),t.nrm(16,"img",9),t.k0s(),t.j41(17,"form",null,2)(19,"div",6)(20,"label",10),t.EFF(21,"Room"),t.k0s(),t.j41(22,"input",11,3),t.mxI("ngModelChange",function(s){return t.eBV(r),t.DH7(n.roomNick,s)||(n.roomNick=s),t.Njj(s)}),t.k0s(),t.j41(24,"button",12),t.bIt("click",function(s){return t.eBV(r),t.Njj(n.onEnterRoom(s))}),t.EFF(25,"\u5165\u5ba4"),t.k0s(),t.DNE(26,ot,4,3,"ng-container",13),t.k0s()()()}if(2&e){const r=t.sdS(12),c=t.sdS(18),s=t.sdS(23);t.R7$(8),t.AVh("was-validated",r.dirty||r.touched),t.R7$(3),t.R50("ngModel",n.nickname),t.Y8G("disabled",!0),t.R7$(8),t.AVh("was-validated",s.dirty||s.touched),t.R7$(3),t.R50("ngModel",n.roomNick),t.R7$(2),t.Y8G("disabled",!c.valid),t.R7$(2),t.Y8G("ngIf",s.invalid)}},dependencies:[l.bT,u.qT,u.me,u.BC,u.cb,u.YS,u.xh,u.tU,u.vS,u.cV,d.Wk]})}return i})();function nt(i,m){1&i&&(t.qex(0),t.nrm(1,"span",2),t.bVm())}function it(i,m){if(1&i){const o=t.RV6();t.qex(0),t.j41(1,"gitfire-chat-entrance",3),t.bIt("roomSelected",function(n){t.eBV(o);const r=t.XpG();return t.Njj(r.onRoomSelected(n))}),t.k0s(),t.bVm()}if(2&i){const o=t.XpG();t.R7$(),t.Y8G("initialRoomNick",o.roomNick)}}function rt(i,m){if(1&i){const o=t.RV6();t.qex(0),t.j41(1,"gitfire-chat-room",4),t.bIt("exitRoom",function(){t.eBV(o);const n=t.XpG();return t.Njj(n.onExitedRoom())}),t.k0s(),t.bVm()}if(2&i){const o=t.XpG();t.R7$(),t.Y8G("roomInfo",o.existRoomInfo)}}const st=[{path:"",component:(()=>{class i{chat;router;route;destroy$=new R.B;state$=new M.t("loading");existRoomInfo;roomInfo;roomNick;ensureTos$=new R.B;constructor(o,e,n){this.chat=o,this.router=e,this.route=n}ngOnInit(){this.route.fragment.pipe((0,S.s)(1),(0,v.n)(o=>this.maybeRoomInfo$(o))).subscribe(o=>{if(!o||!o.id)return this.state$.next("entrance"),void(o&&o.nick&&(this.roomNick=o.nick));this.ensureTos$.next(o)}),this.ensureTos$.pipe((0,v.n)(o=>(0,V.y)((0,b.of)(o),this.chat.confirmTos$()))).subscribe(([o,e])=>{e?(this.state$.next("room"),this.setRoomInfo(o)):(this.state$.next("entrance"),this.roomNick=o.nick)})}ngOnDestroy(){this.destroy$.next()}onRoomSelected(o){(0,h.Oi)("onRoomSelected()",o),this.state$.next("room"),this.setRoomInfo(o),this.router.navigate(["/Gitfire/chat"],{fragment:o.nick})}onExitedRoom(){(0,h.Oi)("onExitedRoom()"),this.state$.next("entrance"),this.setRoomInfo(null),this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(o){return null==o||o.length<4||10<=o.length?(0,b.of)(null):this.chat.maybeRoomInfo$(o)}get isAdActive(){return!!h.cA.production}setRoomInfo(o){if(!o)return delete this.roomInfo,void delete this.existRoomInfo;this.roomInfo=o,o.id?this.existRoomInfo=o:delete this.existRoomInfo}static \u0275fac=function(e){return new(e||i)(t.rXU(g),t.rXU(d.Ix),t.rXU(d.nX))};static \u0275cmp=t.VBU({type:i,selectors:[["ng-component"]],decls:6,vars:6,consts:[[3,"ngSwitch"],[4,"ngSwitchCase"],["role","status",1,"spinner-border","text-primary"],[3,"roomSelected","initialRoomNick"],[3,"exitRoom","roomInfo"]],template:function(e,n){1&e&&(t.qex(0,0),t.nI1(1,"async"),t.DNE(2,nt,2,0,"ng-container",1)(3,it,2,1,"ng-container",1)(4,rt,2,1,"ng-container",1),t.bVm(),t.nrm(5,"app-ad-fragment")),2&e&&(t.Y8G("ngSwitch",t.bMT(1,4,n.state$)),t.R7$(2),t.Y8G("ngSwitchCase","loading"),t.R7$(),t.Y8G("ngSwitchCase","entrance"),t.R7$(),t.Y8G("ngSwitchCase","room"))},dependencies:[l.ux,l.e1,Y.j,L,et,l.Jj]})}return i})()}];let at=(()=>{class i{static \u0275fac=function(e){return new(e||i)};static \u0275mod=t.$C({type:i});static \u0275inj=t.G2t({imports:[d.iI.forChild(st),d.iI]})}return i})();var ct=a(5427);let ut=(()=>{class i{static \u0275fac=function(e){return new(e||i)};static \u0275mod=t.$C({type:i});static \u0275inj=t.G2t({providers:[B.D,g,p.tw,F.Y,y.u],imports:[l.MD,u.YN,p._B.forRoot(h.cA.toastrConfig),ct.j,at,A.Q]})}return i})()}}]);