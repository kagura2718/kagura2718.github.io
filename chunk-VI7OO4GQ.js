import{a as ce}from"./chunk-GPRUCSUT.js";import{d as ae,e as me}from"./chunk-KRTLXW6N.js";import{a as k,d as x,f as F,m as ue,r as le}from"./chunk-J7BLHJAA.js";import{ia as pe}from"./chunk-LQZV7VGV.js";import{Ba as m,Cb as W,Eb as a,Fb as K,G as b,Ka as T,M,Oa as Q,Ob as B,P as G,Qc as s,R as f,Tc as D,Va as d,Vc as Y,Xa as C,Yc as Z,Z as y,Zc as ee,_c as te,aa as p,ab as g,ad as oe,b as c,bb as u,cb as l,cd as re,db as S,eb as _,fb as $,gb as V,gd as ie,hd as ne,ic as X,la as z,m as J,nb as E,o as h,pb as q,sd as se,ya as H,za as L}from"./chunk-55LM3UKD.js";import{a as R,d as I}from"./chunk-VB56BUGO.js";function xe(r=[]){return{toFirestore(t){let n=t,{id:e}=n;return I(n,["id"])},fromFirestore(t,e){let o=t.data(e);return R({id:t.id},o)}}}function w(r=[]){return{toFirestore(t){return t},fromFirestore(t,e){return t.data(e)}}}var A=class{saveNeverAsk;isConfirmed};function ye(r,t){r&1&&(u(0,"div",1),S(1,"div",11),l()),r&2&&(m(),g("innerHTML",t.html,H))}function Te(r,t){r&1&&S(0,"span",2)}var O=class r extends ae{confirmed=new z;inputConfirmForm;tosJson=X();constructor(){super()}ngOnInit(){s("TosConfirmComponent.OnInit()"),this.inputConfirmForm=new te({}),this.inputConfirmForm.addControl("neverConfirmTosCheck",new oe(!1))}get neverCheckTosControl(){return this.inputConfirmForm.get("neverConfirmTosCheck")}onClickConfirm(t){if(s("TosConfirmComponent.onClickConfirm()"),t.preventDefault(),this.inputConfirmForm.markAllAsTouched(),this.inputConfirmForm.invalid)return;let e=new A,o=this.inputConfirmForm.get("neverConfirmTosCheck");e.saveNeverAsk=o.value,e.isConfirmed=!0,this.confirmed.emit(e),this.close()}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=T({type:r,selectors:[["gitfire-tos-confirm"]],inputs:{tosJson:[1,"tosJson"]},outputs:{confirmed:"confirmed",tosJson:"tosJsonChange"},features:[Q],decls:18,vars:5,consts:[[1,"container"],[1,"m-3"],["role","status",1,"spinner-border","text-primary"],[1,"text-center"],[3,"formGroup"],[1,"m-5","custom-control","custom-checkbox"],["for","appGitfireTosConfirmNeverDismissCheck",1,"visually-hidden"],["id","appGitfireTosConfirmNeverDismissCheck","name","neverConfirmTosCheck","formControlName","neverConfirmTosCheck","type","checkbox",1,"form-check-input"],[1,"text-muted","fw-light"],["href","/terms.htm","about","_blank"],["id","appGitfireTosConfirmButton",1,"btn","btn-success",3,"click","disabled"],[3,"innerHTML"]],template:function(e,o){if(e&1&&(u(0,"div",0),d(1,ye,2,1,"div",1)(2,Te,1,0,"span",2),u(3,"div",3)(4,"form",4)(5,"div",5)(6,"label",6),a(7,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),l(),S(8,"input",7),a(9,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),l(),u(10,"div",8),a(11,"\u8A73\u3057\u304F\u306F"),u(12,"a",9),a(13,"[\u5229\u7528\u898F\u7D04]"),l(),a(14,"\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002 "),l(),u(15,"div",1)(16,"button",10),q("click",function(v){return o.onClickConfirm(v)}),a(17,"\u78BA\u8A8D\u3057\u307E\u3057\u305F"),l()()()()()),e&2){let n;m(),C((n=o.tosJson())?1:2,n),m(3),g("formGroup",o.inputConfirmForm),m(),W("was-validated",o.neverCheckTosControl.dirty||o.neverCheckTosControl.touched),m(11),g("disabled",!o.inputConfirmForm.valid)}},dependencies:[se,re,Y,Z,ee,ne,ie],encapsulation:2})};var fe=class r{constructor(t,e,o){this.http=t;this.dialog=e;this.firestore=o}UserAgreementConverter=w(["createdAt"]);ProtectedUserPrefix="users/v1/protected";destroy$=new c;ngOnDestroy(){s("TosService.OnDestroy()"),this.destroy$.next()}constructSetupTosConfirm(t,e){return o=>{o.tosJson.set(e.json),o.confirmed.pipe(f(this.destroy$)).subscribe(n=>{if(!n.isConfirmed)throw new Error("assert");n.saveNeverAsk?e.answer=2:e.answer=0,t.next(e)})}}confirmTos$(t,e){if(t.match(/\/$/))throw new Error(`Assertion. Not a supported ${t}`);let o=new c,n=new c,v=new c,ve=this.http.fetchGhJson(e).pipe(b(1),G(i=>{let U=`${this.ProtectedUserPrefix}/${t}/${i.version}`,P=F(this.firestore,U).withConverter(this.UserAgreementConverter),j={json:i,cached:!1,cacheRef:P};return x(P).pipe(h(he=>(he?.alwaysConfirmed&&(s("TOS has already been confirmed."),j.cached=!0),j)))}));return v.pipe(f(this.destroy$)).subscribe({next:i=>{this.dialog.createDefaultBuilder().prepareBody(O).setupChild(this.constructSetupTosConfirm(n,i)).setType(1).setSize(1).setTitle("\u5229\u7528\u898F\u7D04\u306E\u78BA\u8A8D").closeButton(()=>{i.answer=1,n.next(i)}).setFinalize(()=>{i.answer=1,n.next(i)}).open()},complete:()=>{s("completed dialog$")},error:i=>{D("error dialog$",i)}}),ve.pipe(b(1),f(this.destroy$)).subscribe({next:i=>{if(i.cached){o.next(!0);return}v.next(i)},complete:()=>{s("Completed TOS reading")},error:i=>{D("Failed reading TOS cache",i)}}),n.pipe(b(1),f(this.destroy$)).subscribe({next:async i=>{switch(i.answer){case 0:o.next(!0);break;case 1:o.next(!1);break;case 2:let U={_docClass:"User:UserAgreementStore",alwaysConfirmed:!0,createdAt:pe()};o.next(!0),await ue(i.cacheRef,U);break;default:throw new Error(`Not a valid answer ${i.answer}`)}},complete:()=>{s("Completed dialog result."),o.complete()},error:i=>{D("Failed receive dialog result"),o.complete()}}),o}static \u0275fac=function(e){return new(e||r)(p(ce),p(me),p(k))};static \u0275prov=y({token:r,factory:r.\u0275fac,providedIn:"root"})};var de=class r{constructor(t,e){this.firestore=t;this.auth=e}destroy$=new c;nicknameCache={};userCache={};UserPublicConverter=w(["createdAt","updatedAt"]);ngOnDestroy(){s("UserService.OnDestroy"),this.destroy$.next()}myNickname$(){return this.auth.myUid?this.nickname$(this.auth.myUid):J("")}user$(t){let e=this.userCache[t];if(e)return e;let o=F(this.firestore,`users/v1/public/${t}`).withConverter(this.UserPublicConverter);return e=x(o).pipe(M(1)),this.userCache[t]=e,e}nickname$(t){let e=this.nicknameCache[t];return e||(e=this.user$(t).pipe(h(o=>o?o.nickname:null)),this.nicknameCache[t]=e,e)}static \u0275fac=function(e){return new(e||r)(p(k),p(le))};static \u0275prov=y({token:r,factory:r.\u0275fac,providedIn:"root"})};function Se(r,t){r&1&&V(0,"img",2),r&2&&E("src",B(t),L)}function De(r,t){if(r&1&&(_(0,"span",0),d(1,Se,1,2,"img",2),a(2),$()),r&2){let e,o=t;E("title",B(o.about)),m(),C((e=o.photoURL)?1:-1,e),m(),K(o.nickname)}}function ke(r,t){r&1&&(_(0,"span",1),a(1,"[\u524A\u9664]"),$())}var Ce=class r{userPublic;constructor(){}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=T({type:r,selectors:[["gitfire-user-box"]],inputs:{userPublic:"userPublic"},decls:2,vars:1,consts:[[1,"p-1",3,"title"],["title","\u524A\u9664\u3055\u308C\u305F\u30E6\u30FC\u30B6\u3067\u3059",1,"text-warning"],[1,"p-1",2,"height","100%","width","2rem",3,"src"]],template:function(e,o){if(e&1&&d(0,De,3,4,"span",0)(1,ke,2,0,"span",1),e&2){let n;C((n=o.userPublic)?0:1,n)}},encapsulation:2})};export{xe as a,w as b,fe as c,de as d,Ce as e};
