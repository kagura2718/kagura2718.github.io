import{a as me}from"./chunk-L3JE333W.js";import{d as se,e as ae}from"./chunk-CVXX5FR7.js";import{D as ce}from"./chunk-6WZUEDWW.js";import{c as pe}from"./chunk-5YUGNV6C.js";import{h as y}from"./chunk-A7HDYDRL.js";import{Ba as s,Cb as q,Eb as n,Fb as K,G as b,Jc as Q,Ka as x,M,Oa as z,Ob as O,P as R,Qc as a,Tc as w,Va as d,Vc as X,Xa as C,Yc as Y,Z as g,Zc as Z,_c as ee,aa as c,ab as A,ad as te,b as f,ba as T,bb as p,cb as l,cd as re,da as S,db as F,ea as k,eb as _,fb as I,gb as H,gd as oe,hd as ie,la as G,m as P,nb as E,o as h,pb as L,rb as W,sd as ne,ya as J,za as V}from"./chunk-7VISKNRN.js";var U=class{saveNeverAsk;isConfirmed};function ve(o,t){if(o&1&&(p(0,"div",1),F(1,"div",11),l()),o&2){let e=W();s(),A("innerHTML",e.tosJson.html,J)}}function he(o,t){o&1&&F(0,"span",2)}var D=class o extends se{confirmed=new G;inputConfirmForm;tosJson;constructor(){super()}ngOnInit(){a("TosConfirmComponent.OnInit()"),this.inputConfirmForm=new ee({}),this.inputConfirmForm.addControl("neverConfirmTosCheck",new te(!1))}ngAfterViewInit(){a("TosConfirmComponent.AfterViewInit()")}get neverCheckTosControl(){return this.inputConfirmForm.get("neverConfirmTosCheck")}onClickConfirm(t){if(t.preventDefault(),this.inputConfirmForm.markAllAsTouched(),this.inputConfirmForm.invalid)return;let e=new U,r=this.inputConfirmForm.get("neverConfirmTosCheck");e.saveNeverAsk=r.value,e.isConfirmed=!0,this.confirmed.emit(e)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["gitfire-tos-confirm"]],inputs:{tosJson:"tosJson"},outputs:{confirmed:"confirmed"},features:[z],decls:18,vars:5,consts:[[1,"container"],[1,"m-3"],["role","status",1,"spinner-border","text-primary"],[1,"text-center"],[3,"formGroup"],[1,"m-5","custom-control","custom-checkbox"],["for","appGitfireTosConfirmNeverDismissCheck",1,"visually-hidden"],["id","appGitfireTosConfirmNeverDismissCheck","name","neverConfirmTosCheck","formControlName","neverConfirmTosCheck","type","checkbox",1,"form-check-input"],[1,"text-muted","fw-light"],["routerLink","/terms.htm"],["id","appGitfireTosConfirmButton","data-bs-dismiss","modal",1,"btn","btn-success",3,"click","disabled"],[3,"innerHTML"]],template:function(e,r){e&1&&(p(0,"div",0),d(1,ve,2,1,"div",1)(2,he,1,0,"span",2),p(3,"div",3)(4,"form",4)(5,"div",5)(6,"label",6),n(7,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),l(),F(8,"input",7),n(9,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),l(),p(10,"div",8),n(11,"\u8A73\u3057\u304F\u306F"),p(12,"a",9),n(13,"[\u5229\u7528\u898F\u7D04]"),l(),n(14,"\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002 "),l(),p(15,"div",1)(16,"button",10),L("click",function(u){return r.onClickConfirm(u)}),n(17,"\u78BA\u8A8D\u3057\u307E\u3057\u305F"),l()()()()()),e&2&&(s(),C(r.tosJson?1:2),s(3),A("formGroup",r.inputConfirmForm),s(),q("was-validated",r.neverCheckTosControl.dirty||r.neverCheckTosControl.touched),s(11),A("disabled",!r.inputConfirmForm.valid))},dependencies:[ne,re,X,Y,Z,ie,oe,Q],encapsulation:2})};var le=class o{constructor(t,e,r){this.http=t;this.dialog=e;this.store=r;this.privUser=this.store.collection("/users/v1/protected")}privUser;env=T(S);constructSetupTosConfirm(t,e){return r=>{r.tosJson=e.json,r.confirmed.subscribe(m=>{if(!m.isConfirmed)throw new Error("assert");m.saveNeverAsk?e.answer=2:e.answer=0,t.next(e)})}}confirmTos$(t,e){if(t.match(/\/$/))throw new Error(`Assertion. Not a supported ${t}`);let r=new f,m=new f,u=new f,j=new f,de=this.http.fetchGhJson(e).pipe(b(1),R(i=>k(this.env,()=>{let v=this.privUser.doc(`${t}/${i.version}`),B={json:i,cached:!1,cacheRef:v};return v.get().pipe(h(($,ke)=>($.exists&&$.data().alwaysConfirmed&&(a("TOS has already been confirmed."),B.cached=!0),B)))})));return j.pipe().subscribe({next:i=>{this.dialog.createDefaultBuilder().prepareBody(D).setupChild(this.constructSetupTosConfirm(u,i)).setType(1).setSize(1).setTitle("\u5229\u7528\u898F\u7D04\u306E\u78BA\u8A8D").closeButton(()=>{i.answer=1,u.next(i)}).setFinalize(()=>{i.answer=1,u.next(i)}).open()},complete:()=>{a("completeed dialog$")},error:i=>{w("error dialog$",i)}}),de.pipe(b(1)).subscribe({next:i=>{if(i.cached){r.next(!0);return}j.next(i)},complete:()=>{a("Completed TOS reading")},error:i=>{w("Failed reading TOS cache",i)}}),u.pipe(b(1)).subscribe({next:async i=>{switch(i.answer){case 0:r.next(!0);break;case 1:r.next(!1);break;case 2:let v={_docClass:"User:UserAgreementStore",alwaysConfirmed:!0,createdAt:this.fieldTimestamp()};r.next(!0),await i.cacheRef.set(v);break;default:throw new Error(`Not a valid answer ${i.answer}`)}},complete:()=>{a("Completed dialog result."),r.complete()},error:i=>{w("Failed receive dialog result"),r.complete()}}),r}fieldTimestamp(){return ce.firestore.FieldValue.serverTimestamp()}static \u0275fac=function(e){return new(e||o)(c(me),c(ae),c(y))};static \u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})};var ue=class o{constructor(t,e){this.store=t;this.auth=e;this.pubUser=this.store.collection("/users/v1/public")}pubUser;nicknameCache={};userCache={};env=T(S);myNickname$(){return this.auth.myUid?this.nickname$(this.auth.myUid):P("")}user$(t){let e=this.userCache[t];return e||(e=k(this.env,()=>this.pubUser.doc(t).valueChanges().pipe(M(1))),this.userCache[t]=e,e)}nickname$(t){let e=this.nicknameCache[t];return e||(e=this.user$(t).pipe(h(r=>r?r.nickname:null)),this.nicknameCache[t]=e,e)}static \u0275fac=function(e){return new(e||o)(c(y),c(pe))};static \u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})};function ge(o,t){o&1&&H(0,"img",2),o&2&&E("src",O(t),V)}function Te(o,t){if(o&1&&(_(0,"span",0),d(1,ge,1,2,"img",2),n(2),I()),o&2){let e,r=t;E("title",O(r.about)),s(),C((e=r.photoURL)?1:-1,e),s(),K(r.nickname)}}function Se(o,t){o&1&&(_(0,"span",1),n(1,"[\u524A\u9664]"),I())}var fe=class o{userPublic;constructor(){}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["gitfire-user-box"]],inputs:{userPublic:"userPublic"},decls:2,vars:1,consts:[[1,"p-1",3,"title"],["title","\u524A\u9664\u3055\u308C\u305F\u30E6\u30FC\u30B6\u3067\u3059",1,"text-warning"],[1,"p-1",2,"height","100%","width","2rem",3,"src"]],template:function(e,r){if(e&1&&d(0,Te,3,4,"span",0)(1,Se,2,0,"span",1),e&2){let m;C((m=r.userPublic)?0:1,m)}},encapsulation:2})};export{le as a,ue as b,fe as c};
