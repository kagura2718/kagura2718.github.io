import{a as Ze}from"./chunk-FKH2EOOQ.js";import{a as tt}from"./chunk-HP542DHF.js";import{a as se,b as ce,c as et}from"./chunk-JUZAHXMJ.js";import{b as me}from"./chunk-DQJB75ZH.js";import"./chunk-OVGWOFM3.js";import{e as Ge}from"./chunk-2K3GGOJ3.js";import{a as Ae,c as re}from"./chunk-LCGQWH44.js";import{c as ae,d as Ye}from"./chunk-57X3MC42.js";import{a as qe,b as Qe,d as ze,f as fe,g as B,i as He,k as Je,m as Ke,n as Xe,o as he}from"./chunk-5CVYVRTT.js";import"./chunk-FYNN2IQP.js";import"./chunk-M5PFS4RI.js";import{a as We}from"./chunk-TTD52GUP.js";import"./chunk-XGZHVJI3.js";import{a as Y}from"./chunk-XRX4MRYS.js";import"./chunk-M5RCGXCJ.js";import"./chunk-BQLV7WLJ.js";import{$ as k,$a as C,$c as Pe,A as ye,Aa as c,B as _e,Bb as N,Db as l,Eb as De,Fb as Me,Fc as Be,Ga as p,H as xe,Hb as P,Ib as j,Ic as Fe,Ja as M,Jb as U,Jc as $e,Ka as z,Nc as pe,O as V,Oc as Z,Q as v,Qc as y,Tc as Oe,Ua as f,Va as we,Wa as h,Wb as L,Wc as ee,Xb as G,Y as be,Yc as te,Z as Q,Za as Ie,Zc as Ve,_a as ke,ab as s,b,bb as m,bd as oe,c as ge,cb as S,cc as Ne,cd as je,dc as Te,ea as u,fa as d,ic as W,ka as Se,lb as w,m as A,ma as D,n as de,nd as ie,ob as g,p as Re,pd as Ue,qb as R,qd as ne,rd as T,sc as X,sd as Le,tb as H,ub as J,vb as K,xa as Ee,zb as I}from"./chunk-57KELPP2.js";import"./chunk-LRFDAHTL.js";import"./chunk-VB56BUGO.js";var _=class i{constructor(t,e,o,n,a){this.tos=t;this.auth=e;this.firestore=o;this.funcs=n;this.user=a}roomPath="chat/v1/room";roomIndexPath="index/chat/roomnick";destroy$=new b;ChatStoreConverter=me(["createdAt"]);ChatRoomStoreConverter=me(["createdAt"]);ChatRoomIndexStoreConverter=me([]);ngOnDestroy(){y("ChatService.OnDestroy()"),this.destroy$.next()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,Z.ChatServiceTosUrl)}readChitchat$(t){let e=`${this.roomPath}/${t}/chitchat`,o=fe(this.firestore,e).withConverter(this.ChatStoreConverter),n=Xe(o,Ke("createdAt","desc"),Je(30));return ze(n,{idField:"id"})}postComment$(t,e){let o={roomId:t,text:e};return A(this.funcs.call("postChat",o))}deleteRoom$(t){if(!t)throw new Error("roomId is not supplied");return A(he(this.firestore,async e=>{let o=B(this.firestore,this.roomPath,t).withConverter(this.ChatRoomStoreConverter),r=(await e.get(o)).data().nick,x=B(this.firestore,this.roomIndexPath,r),E=await e.get(x);await e.delete(o),await e.delete(x)}))}ensureRoom$(t){if(!t)throw new Error("room nick is not supplied");return A(he(this.firestore,async e=>{let o=B(this.firestore,this.roomIndexPath,t).withConverter(this.ChatRoomIndexStoreConverter),n=await e.get(o);if(n.exists()){let ve=n.data();return{id:ve.value,nick:t,isOwned:ve.owner===this.auth.myUid,isExisting:!0}}let a=B(fe(this.firestore,this.roomPath)),r={nick:t,owner:this.auth.myUid,createdAt:qe()};await e.set(a,r);let x={value:a.id,owner:this.auth.myUid};return await e.set(o,x),{id:a.id,nick:t,isExisting:!1,isOwned:!0}}))}maybeRoomInfo$(t){let e=B(this.firestore,this.roomIndexPath,t).withConverter(this.ChatRoomIndexStoreConverter);return A(He(e)).pipe(Re(o=>{let n={nick:t,isExisting:!!o.exists};if(!o.exists)return n;let a=o.data();return n.isOwned=a.owner===this.auth.myUid,n.id=a.value,n}))}static \u0275fac=function(e){return new(e||i)(k(se),k(Ye),k(Qe),k(ae),k(ce))};static \u0275prov=be({token:i,factory:i.\u0275fac,providedIn:"root"})};var at=["inputRoomForm"];function mt(i,t){i&1&&(s(0,"div",13),l(1,"\u90E8\u5C4B\u306E\u540D\u524D(\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0)\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),m())}function st(i,t){i&1&&(s(0,"div",13),l(1,"\u77ED\u3059\u304E\u307E\u3059\u3002"),m())}function ct(i,t){i&1&&(s(0,"div",13),l(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),m())}function lt(i,t){if(i&1&&(f(0,mt,2,0,"div",13),f(1,st,2,0,"div",13),f(2,ct,2,0,"div",13)),i&2){R();let e=I(23);h(e.errors!=null&&e.errors.required?0:-1),c(),h(e.errors!=null&&e.errors.minlength?1:-1),c(),h(e.errors!=null&&e.errors.maxlength?2:-1)}}var F=class i{constructor(t,e){this.chat=t;this.toastr=e}roomSelected=Ne();initialRoomNick=Te(null);inputRoomForm;roomNick=W();nickname=W();destroy$=new b;ngOnInit(){this.initialRoomNick()&&this.roomNick.set(this.initialRoomNick()),this.chat.user.myNickname$().pipe(v(this.destroy$)).subscribe(t=>{this.nickname.set(t)})}ngOnDestroy(){this.destroy$.next()}onEnterRoom(t){if(!this.inputRoomForm.valid)return;let e=this.roomNick();this.chat.confirmTos$().pipe(ye(o=>o),V(o=>this.chat.ensureRoom$(e)),v(this.destroy$)).subscribe(o=>{y(`Creating room id: ${o.id} with ${o.nick}`),this.roomNick.set(""),o.isExisting?this.toastr.info(`chat \u30EB\u30FC\u30E0 "${e}" \u306B\u5165\u5BA4\u3057\u307E\u3059\u3002`):this.toastr.info(`\u65B0\u3057\u3044 chat \u30EB\u30FC\u30E0 "${e}" \u3092\u4F5C\u308A\u307E\u3057\u305F\u3002`),this.roomSelected.emit(o)})}static \u0275fac=function(e){return new(e||i)(p(_),p(Y))};static \u0275cmp=M({type:i,selectors:[["gitfire-chat-entrance"]],viewQuery:function(e,o){if(e&1&&H(at,5),e&2){let n;J(n=K())&&(o.inputRoomForm=n.first)}},inputs:{initialRoomNick:[1,"initialRoomNick"],roomNick:[1,"roomNick"],nickname:[1,"nickname"]},outputs:{roomSelected:"roomSelected",roomNick:"roomNickChange",nickname:"nicknameChange"},decls:27,vars:9,consts:[["chatConfigureForm","ngForm"],["nickNameBox","ngModel"],["inputRoomForm","ngForm"],["roomBox","ngModel"],["routerLink","/Gitfire/settings"],[1,""],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4F8B: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModelChange","ngModel","disabled"],["title","\u5165\u5BA4\u3059\u308B\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u540D\u524D\u3067\u3059\u3002\u5B58\u5728\u3057\u306A\u3044\u540D\u524D\u306E\u5834\u5408\u306F\u65B0\u3057\u3044\u90E8\u5C4B\u304C\u4F5C\u3089\u308C\u307E\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"click","disabled"],[1,"invalid-feedback"]],template:function(e,o){if(e&1){let n=w();s(0,"div")(1,"p"),l(2,"Chat \u3067\u4F7F\u3046\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3067\u3059\u3002"),s(3,"a",4),l(4,"[\u8A2D\u5B9A]"),m(),l(5,"\u304B\u3089\u5909\u66F4\u3067\u304D\u307E\u3059\u3002"),m(),s(6,"form",5,0)(8,"div",6)(9,"label",7),l(10,"\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0"),m(),s(11,"input",8,1),U("ngModelChange",function(r){return u(n),j(o.nickname,r)||(o.nickname=r),d(r)}),m()()()(),s(13,"div")(14,"h2"),l(15,"Chat Room \u306E\u540D\u524D"),S(16,"img",9),m(),s(17,"form",null,2)(19,"div",6)(20,"label",10),l(21,"Room"),m(),s(22,"input",11,3),U("ngModelChange",function(r){return u(n),j(o.roomNick,r)||(o.roomNick=r),d(r)}),m(),s(24,"button",12),g("click",function(r){return u(n),d(o.onEnterRoom(r))}),l(25,"\u5165\u5BA4"),m(),f(26,lt,3,3),m()()()}if(e&2){let n=I(12),a=I(18),r=I(23);c(8),N("was-validated",n.dirty||n.touched),c(3),P("ngModel",o.nickname),C("disabled",!0),c(8),N("was-validated",r.dirty||r.touched),c(3),P("ngModel",o.roomNick),c(2),C("disabled",!a.valid),c(2),h(r.invalid?26:-1)}},dependencies:[T,je,ee,te,Ve,ie,Ue,ne,oe,Pe,Le,$e],encapsulation:2})};var le=class{constructor(t,e,o,n,a,r){this.id=t;this.text=e;this.admin=o;this.html=n;this.createdAt=a;this.user$=r}};var ut=["chatBox"],dt=(i,t)=>t.id;function pt(i,t){i&1&&S(0,"div",7)}function ft(i,t){i&1&&S(0,"gitfire-user-box",11),i&2&&C("userPublic",t)}function ht(i,t){if(i&1&&S(0,"div",12),i&2){let e=R().$implicit;C("innerHTML",e.html,Ee)}}function Ct(i,t){if(i&1&&(s(0,"div",13),l(1),m()),i&2){let e=R().$implicit;c(),De(e.text)}}function vt(i,t){if(i&1&&(s(0,"div",1)(1,"div",9),l(2),L(3,"relativeTime"),m(),s(4,"div",10),f(5,ft,1,1,"gitfire-user-box",11),L(6,"async"),m(),f(7,ht,1,1,"div",12)(8,Ct,2,1,"div",13),m()),i&2){let e,o=t.$implicit;N("bg-info",o.admin)("text-white",o.admin)("text-muted",!o.admin),c(2),Me("",G(3,9,o.createdAt)," "),c(3),h((e=G(6,11,o.user$))?5:-1,e),c(2),h(o.html?7:8)}}var $=class i{constructor(t,e,o){this.chat=t;this.dialog=e;this.toastr=o}destroy$=new b;roomInfo=W();exitRoom=new Se;message="";chatBox;chitchat=D([]);chitchatMap={};ngOnInit(){this.chat.readChitchat$(this.roomInfo().id).pipe(v(this.destroy$)).subscribe(e=>{y("Receive ChitChat",e);let o=this.chitchat();for(let a of e){let r=a.id,x=this.chitchatMap[r],E=a;x||(x=new le(r,E.text,!!E.admin,E.html,E.createdAt?E.createdAt.toDate():new Date,this.chat.user.user$(E.uid)),o.push(x),this.chitchatMap[r]=x)}let n=[...o].sort((a,r)=>this.descDate(a.createdAt,r.createdAt));this.chitchat.set(n)})}descDate(t,e){return t===e?0:t<e?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo().id).pipe(v(this.destroy$)).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524A\u9664\u3057\u307E\u3057\u305F\u3002")})}onClickDeleteRoom(t){this.dialog.createSimpleBuilder().setType(1).setSize(1).setTitle("\u78BA\u8A8D").setMessage("\u672C\u5F53\u306B\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(t){this.exitRoom.emit()}onPostComment(t){this.chatBox.invalid||this.chat.postComment$(this.roomInfo().id,this.message).pipe(v(this.destroy$)).subscribe(e=>{let o=this.chatBox.control;o.setValue(""),o.markAsPristine()},e=>{Oe("Error while post chat",e);let o=e instanceof Error?e.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307E\u3057\u305F\u3002 ( ${o} )`)})}static \u0275fac=function(e){return new(e||i)(p(_),p(Ge),p(Y))};static \u0275cmp=M({type:i,selectors:[["gitfire-chat-room"]],viewQuery:function(e,o){if(e&1&&H(ut,5),e&2){let n;J(n=K())&&(o.chatBox=n.first)}},inputs:{roomInfo:[1,"roomInfo"]},outputs:{roomInfo:"roomInfoChange",exitRoom:"exitRoom"},decls:13,vars:7,consts:[["chatBox","ngModel"],[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"click","disabled","title"],["title","\u5165\u53E3\u306B\u623B\u308A\u307E\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModelChange","keyup.enter","ngModel"],[1,"col-3","btn","btn-primary",3,"click","disabled"],[1,"valid-feedback"],[1,"row","m-3",3,"bg-info","text-white","text-muted"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(e,o){if(e&1){let n=w();s(0,"div",1)(1,"button",2),g("click",function(r){return u(n),d(o.onClickDeleteRoom(r))}),l(2,"\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u524A\u9664"),m(),s(3,"button",3),g("click",function(r){return u(n),d(o.onClickExitRoom(r))}),l(4,"\u9000\u5BA4"),m()(),s(5,"div",4)(6,"input",5,0),U("ngModelChange",function(r){return u(n),j(o.message,r)||(o.message=r),d(r)}),g("keyup.enter",function(r){return u(n),d(o.onPostComment(r))}),m(),s(8,"button",6),g("click",function(r){return u(n),d(o.onPostComment(r))}),l(9,"\u9001\u4FE1"),m(),f(10,pt,1,0,"div",7),m(),Ie(11,vt,9,13,"div",8,dt)}if(e&2){let n=I(7);c(),C("disabled",!o.roomInfo().isOwned)("title",o.roomInfo().isOwned?"":"\u30EB\u30FC\u30E0\u3092\u958B\u8A2D\u3057\u305F\u4EBA\u3060\u3051\u304C\u524A\u9664\u3067\u304D\u307E\u3059\u3002"),c(4),N("was-validated",n.dirty||n.touched),c(),P("ngModel",o.message),c(2),C("disabled",!n.valid),c(2),h(n.valid?10:-1),c(),ke(o.chitchat())}},dependencies:[T,ee,te,ie,ne,oe,re,et,X,tt],encapsulation:2})};function gt(i,t){i&1&&S(0,"app-spinner")}function Rt(i,t){if(i&1){let e=w();s(0,"gitfire-chat-entrance",2),g("roomSelected",function(n){u(e);let a=R();return d(a.onRoomSelected(n))}),m()}if(i&2){let e=R();C("initialRoomNick",e.roomNick())}}function yt(i,t){if(i&1){let e=w();s(0,"gitfire-chat-room",3),g("exitRoom",function(){u(e);let n=R();return d(n.onExitedRoom())}),m()}if(i&2){let e=R();C("roomInfo",e.existRoomInfo())}}var O=class i{constructor(t,e,o){this.chat=t;this.router=e;this.route=o}destroy$=new b;state$=new ge("loading");existRoomInfo=D(null);roomInfo=D(null);roomNick=D(null);ensureTos$=new b;ngOnInit(){this.route.fragment.pipe(xe(1),V(t=>this.maybeRoomInfo$(t)),v(this.destroy$)).subscribe(t=>{if(!t||!t.id){this.state$.next("entrance"),t&&t.nick&&this.roomNick.set(t.nick);return}this.ensureTos$.next(t)}),this.ensureTos$.pipe(V(t=>_e(de(t),this.chat.confirmTos$())),v(this.destroy$)).subscribe(([t,e])=>{e?(this.state$.next("room"),this.setRoomInfo(t)):(this.state$.next("entrance"),this.roomNick.set(t.nick))})}ngOnDestroy(){y("ChatComponent.OnDestroy()"),this.destroy$.next()}onRoomSelected(t){y("onRoomSelected()",t),this.state$.next("room"),this.setRoomInfo(t),this.router.navigate(["/Gitfire/chat"],{fragment:t.nick})}onExitedRoom(){y("onExitedRoom()"),this.state$.next("entrance"),this.setRoomInfo(null),this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(t){return t==null||t.length<4||10<=t.length?de(null):this.chat.maybeRoomInfo$(t)}get isAdActive(){return!!Z.production}setRoomInfo(t){if(!t){this.roomInfo.set(null);return}this.roomInfo.set(t),t.id?this.existRoomInfo.set(t):this.existRoomInfo.set(null)}static \u0275fac=function(e){return new(e||i)(p(_),p(Fe),p(Be))};static \u0275cmp=M({type:i,selectors:[["ng-component"]],decls:5,vars:3,consts:[[3,"initialRoomNick"],[3,"roomInfo"],[3,"roomSelected","initialRoomNick"],[3,"exitRoom","roomInfo"]],template:function(e,o){if(e&1&&(f(0,gt,1,0,"app-spinner"),L(1,"async"),we(2,Rt,1,1,"gitfire-chat-entrance",0)(3,yt,1,1,"gitfire-chat-room",1),S(4,"app-ad-fragment")),e&2){let n;h((n=G(1,1,o.state$))==="loading"?0:n==="entrance"?2:n==="room"?3:-1)}},dependencies:[We,F,$,Ae,X],encapsulation:2})};var _t=[{path:"",component:O}],ue=class i{static \u0275fac=function(e){return new(e||i)};static \u0275mod=z({type:i});static \u0275inj=Q({imports:[pe.forChild(_t),pe]})};var it=class i{static \u0275fac=function(e){return new(e||i)};static \u0275mod=z({type:i});static \u0275inj=Q({providers:[ce,_,ae,se],imports:[T,re,ue,Ze,$,F,O]})};export{it as GitfireChatModule};
