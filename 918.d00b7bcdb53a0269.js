"use strict";(self.webpackChunkKaguraGithubPages=self.webpackChunkKaguraGithubPages||[]).push([[918],{9918:(ft,T,a)=>{a.r(T),a.d(T,{GitfireChatModule:()=>lt});var m=a(6223),h=a(6814),g=a(2425),A=a(3158),Z=a(5861),E=a(7142),v=a(2459),M=a(7398),d=a(108),t=a(9212),F=a(8441),J=a(1626),N=a(5579),k=a(6323);class D{id;nick;isOwned=!1}class I extends D{isExisting;constructor(c){super(),this.isExisting=c}}let C=(()=>{class n{tos;auth;store;funcs;user;room;roomIndex;constructor(o,e,i,r,s){this.tos=o,this.auth=e,this.store=i,this.funcs=r,this.user=s,this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}fieldTimestamp(){return E.Z.firestore.FieldValue.serverTimestamp()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,d.NZ.ChatServiceTosUrl)}readChitchat$(o){return this.room.doc(o).collection("chitchat",e=>e.orderBy("createdAt","desc").limit(30))}postComment$(o,e){return(0,v.D)(this.funcs.call("postChat",{roomId:o,text:e}))}deleteRoom$(o){var e=this;if(!o)throw new Error("roomId is not supplied");const i=this.room.doc(o);return(0,v.D)(this.store.firestore.runTransaction(function(){var r=(0,Z.Z)(function*(s){const l=(yield s.get(i.ref)).data().nick,p=e.roomIndex.doc(l);yield s.delete(i.ref),yield s.delete(p.ref)});return function(s){return r.apply(this,arguments)}}()))}ensureRoom$(o){var e=this;if(!o)throw new Error("room nick is not supplied");const r=this.roomIndex.doc(o);return(0,v.D)(this.store.firestore.runTransaction(function(){var s=(0,Z.Z)(function*(u){const y=yield u.get(r.ref),l=new I(!0);if(l.nick=o,y.exists){const B=y.data();return l.id=B.value,l.isOwned=B.owner===e.auth.myUid,l}const p=e.room.ref.doc(),ht={nick:o,owner:e.auth.myUid,createdAt:e.fieldTimestamp()};yield u.set(p,ht);const dt={value:p.id,owner:e.auth.myUid};return yield u.set(r.ref,dt),l.id=p.id,l.isExisting=!1,l.isOwned=!0,l});return function(u){return s.apply(this,arguments)}}()))}maybeRoomInfo$(o){return this.roomIndex.doc(o).get().pipe((0,M.U)(i=>{const r=new I(!!i.exists);if(r.nick=o,!i.exists)return r;const s=i.data();return r.isOwned=s.owner===this.auth.myUid,r.id=s.value,r}))}static \u0275fac=function(e){return new(e||n)(t.LFG(F.F),t.LFG(J.e),t.LFG(N.ST),t.LFG(A.c),t.LFG(k.K))};static \u0275prov=t.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var b=a(9484),f=a(5187),x=a(8645),w=a(5619),Q=a(9026),_=a(2096),U=a(8180),R=a(4664),S=a(5576);class G{id;text;admin;html;createdAt;user$;constructor(c,o,e,i,r,s){this.id=c,this.text=o,this.admin=e,this.html=i,this.createdAt=r,this.user$=s}}var $=a(8022),O=a(5123),Y=a(8032),L=a(6281);const j=["chatBox"];function P(n,c){1&n&&t._UZ(0,"div",9)}function H(n,c){1&n&&t._UZ(0,"gitfire-user-box",16),2&n&&t.Q6J("userPublic",c.ngIf)}function K(n,c){if(1&n&&t._UZ(0,"div",17),2&n){const o=t.oxw().$implicit;t.Q6J("innerHTML",o.html,t.oJD)}}function z(n,c){if(1&n&&(t.TgZ(0,"div",18),t._uU(1),t.qZA()),2&n){const o=t.oxw().$implicit;t.xp6(1),t.Oqu(o.text)}}function W(n,c){if(1&n&&(t.TgZ(0,"div",10)(1,"div",11),t._uU(2),t.ALo(3,"relativeTime"),t.qZA(),t.TgZ(4,"div",12),t.YNc(5,H,1,1,"gitfire-user-box",13),t.ALo(6,"async"),t.qZA(),t.YNc(7,K,1,1,"div",14)(8,z,2,1,"div",15),t.qZA()),2&n){const o=c.$implicit;t.Q6J("ngClass",o.admin?"bg-info text-white":"text-muted"),t.xp6(2),t.hij("",t.lcZ(3,5,o.createdAt)," "),t.xp6(3),t.Q6J("ngIf",t.lcZ(6,7,o.user$)),t.xp6(2),t.Q6J("ngIf",o.html),t.xp6(1),t.Q6J("ngIf",!o.html)}}let X=(()=>{class n{chat;dialog;toastr;destroy$=new x.x;roomInfo;exitRoom=new t.vpe;message="";chatBox;chitchat=[];chitchatMap={};constructor(o,e,i){this.chat=o,this.dialog=e,this.toastr=i}ngOnInit(){this.chat.readChitchat$(this.roomInfo.id).valueChanges({idField:"id"}).subscribe(e=>{(0,d.eM)("Receive ChitChat",e);for(const i of e){const r=i.id;let s=this.chitchatMap[r];const u=i;s||(s=new G(r,u.text,!!u.admin,u.html,u.createdAt?u.createdAt.toDate():new Date,this.chat.user.user$(u.uid)),this.chitchat.push(s),this.chitchatMap[r]=s)}this.chitchat=this.chitchat.sort((i,r)=>this.descDate(i.createdAt,r.createdAt))})}descDate(o,e){return o===e?0:o<e?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo.id).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524a\u9664\u3057\u307e\u3057\u305f\u3002")})}onClickDeleteRoom(o){this.dialog.createSimpleBuilder().setType($.iR.Warn).setSize($.PW.Default).setTitle("\u78ba\u8a8d").setMessage("\u672c\u5f53\u306b\u524a\u9664\u3057\u307e\u3059\u304b\uff1f").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(o){this.exitRoom.emit()}onPostComment(o){this.chatBox.invalid||this.chat.postComment$(this.roomInfo.id,this.message).subscribe(e=>{const i=this.chatBox.control;i.setValue(""),i.markAsPristine()},e=>{(0,d.wb)("Error while post chat",e);const i=e instanceof Error?e.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307e\u3057\u305f\u3002 ( ${i} )`)})}static \u0275fac=function(e){return new(e||n)(t.Y36(C),t.Y36(O.xA),t.Y36(g._W))};static \u0275cmp=t.Xpm({type:n,selectors:[["gitfire-chat-room"]],viewQuery:function(e,i){if(1&e&&t.Gf(j,5),2&e){let r;t.iGM(r=t.CRH())&&(i.chatBox=r.first)}},inputs:{roomInfo:"roomInfo"},outputs:{exitRoom:"exitRoom"},decls:12,vars:8,consts:[[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"disabled","title","click"],["title","\u5165\u53e3\u306b\u623b\u308a\u307e\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModel","ngModelChange","keyup.enter"],["chatBox","ngModel"],[1,"col-3","btn","btn-primary",3,"disabled","click"],["class","valid-feedback",4,"ngIf"],["class","row m-3",3,"ngClass",4,"ngFor","ngForOf"],[1,"valid-feedback"],[1,"row","m-3",3,"ngClass"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic",4,"ngIf"],["class","col-8",3,"innerHTML",4,"ngIf"],["class","col-8",4,"ngIf"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(e,i){if(1&e&&(t.TgZ(0,"div",0)(1,"button",1),t.NdJ("click",function(s){return i.onClickDeleteRoom(s)}),t._uU(2,"\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u524a\u9664"),t.qZA(),t.TgZ(3,"button",2),t.NdJ("click",function(s){return i.onClickExitRoom(s)}),t._uU(4,"\u9000\u5ba4"),t.qZA()(),t.TgZ(5,"div",3)(6,"input",4,5),t.NdJ("ngModelChange",function(s){return i.message=s})("keyup.enter",function(s){return i.onPostComment(s)}),t.qZA(),t.TgZ(8,"button",6),t.NdJ("click",function(s){return i.onPostComment(s)}),t._uU(9,"\u9001\u4fe1"),t.qZA(),t.YNc(10,P,1,0,"div",7),t.qZA(),t.YNc(11,W,9,9,"div",8)),2&e){const r=t.MAs(7);t.xp6(1),t.Q6J("disabled",!i.roomInfo.isOwned)("title",i.roomInfo.isOwned?"":"\u30eb\u30fc\u30e0\u3092\u958b\u8a2d\u3057\u305f\u4eba\u3060\u3051\u304c\u524a\u9664\u3067\u304d\u307e\u3059\u3002"),t.xp6(4),t.ekj("was-validated",r.dirty||r.touched),t.xp6(1),t.Q6J("ngModel",i.message),t.xp6(2),t.Q6J("disabled",!r.valid),t.xp6(2),t.Q6J("ngIf",r.valid),t.xp6(1),t.Q6J("ngForOf",i.chitchat)}},dependencies:[h.mk,h.sg,h.O5,m.Fj,m.JJ,m.Q7,m.nD,m.On,Y.a,h.Ov,L.a]})}return n})();var q=a(2181);const V=["inputRoomForm"];function tt(n,c){1&n&&(t.TgZ(0,"div",15),t._uU(1,"\u90e8\u5c4b\u306e\u540d\u524d(\u30cb\u30c3\u30af\u30cd\u30fc\u30e0)\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),t.qZA())}function ot(n,c){1&n&&(t.TgZ(0,"div",15),t._uU(1,"\u77ed\u3059\u304e\u307e\u3059\u3002"),t.qZA())}function et(n,c){1&n&&(t.TgZ(0,"div",15),t._uU(1,"\u9577\u3059\u304e\u307e\u3059\u3002"),t.qZA())}function nt(n,c){if(1&n&&(t.ynx(0),t.YNc(1,tt,2,0,"div",14)(2,ot,2,0,"div",14)(3,et,2,0,"div",14),t.BQk()),2&n){t.oxw();const o=t.MAs(23);t.xp6(1),t.Q6J("ngIf",null==o.errors?null:o.errors.required),t.xp6(1),t.Q6J("ngIf",null==o.errors?null:o.errors.minlength),t.xp6(1),t.Q6J("ngIf",null==o.errors?null:o.errors.maxlength)}}let it=(()=>{class n{chat;toastr;roomSelected=new t.vpe;initialRoomNick;inputRoomForm;roomNick;nickname;constructor(o,e){this.chat=o,this.toastr=e}ngOnInit(){this.roomNick=this.initialRoomNick,this.chat.user.myNickname$().subscribe(o=>{this.nickname=o})}onEnterRoom(o){if(!this.inputRoomForm.valid)return;const e=this.roomNick;this.chat.confirmTos$().pipe((0,q.h)(i=>i),(0,R.w)(i=>this.chat.ensureRoom$(e))).subscribe(i=>{(0,d.eM)(`Creating room id: ${i.id} with ${i.nick}`),this.roomNick="",this.toastr.info(i.isExisting?`chat \u30eb\u30fc\u30e0 "${e}" \u306b\u5165\u5ba4\u3057\u307e\u3059\u3002`:`\u65b0\u3057\u3044 chat \u30eb\u30fc\u30e0 "${e}" \u3092\u4f5c\u308a\u307e\u3057\u305f\u3002`),this.roomSelected.emit(i)})}static \u0275fac=function(e){return new(e||n)(t.Y36(C),t.Y36(g._W))};static \u0275cmp=t.Xpm({type:n,selectors:[["gitfire-chat-entrance"]],viewQuery:function(e,i){if(1&e&&t.Gf(V,5),2&e){let r;t.iGM(r=t.CRH())&&(i.inputRoomForm=r.first)}},inputs:{initialRoomNick:"initialRoomNick"},outputs:{roomSelected:"roomSelected"},decls:27,vars:9,consts:[["routerLink","/Gitfire/settings"],[1,""],["chatConfigureForm","ngForm"],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4f8b: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModel","disabled","ngModelChange"],["nickNameBox","ngModel"],["title","\u5165\u5ba4\u3059\u308b\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u540d\u524d\u3067\u3059\u3002\u5b58\u5728\u3057\u306a\u3044\u540d\u524d\u306e\u5834\u5408\u306f\u65b0\u3057\u3044\u90e8\u5c4b\u304c\u4f5c\u3089\u308c\u307e\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["inputRoomForm","ngForm"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModel","ngModelChange"],["roomBox","ngModel"],[1,"btn","btn-primary",3,"disabled","click"],[4,"ngIf"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]],template:function(e,i){if(1&e&&(t.TgZ(0,"div")(1,"p"),t._uU(2,"Chat \u3067\u4f7f\u3046\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3067\u3059\u3002"),t.TgZ(3,"a",0),t._uU(4,"[\u8a2d\u5b9a]"),t.qZA(),t._uU(5,"\u304b\u3089\u5909\u66f4\u3067\u304d\u307e\u3059\u3002"),t.qZA(),t.TgZ(6,"form",1,2)(8,"div",3)(9,"label",4),t._uU(10,"\u30cb\u30c3\u30af\u30cd\u30fc\u30e0"),t.qZA(),t.TgZ(11,"input",5,6),t.NdJ("ngModelChange",function(s){return i.nickname=s}),t.qZA()()()(),t.TgZ(13,"div")(14,"h2"),t._uU(15,"Chat Room \u306e\u540d\u524d"),t._UZ(16,"img",7),t.qZA(),t.TgZ(17,"form",null,8)(19,"div",3)(20,"label",9),t._uU(21,"Room"),t.qZA(),t.TgZ(22,"input",10,11),t.NdJ("ngModelChange",function(s){return i.roomNick=s}),t.qZA(),t.TgZ(24,"button",12),t.NdJ("click",function(s){return i.onEnterRoom(s)}),t._uU(25,"\u5165\u5ba4"),t.qZA(),t.YNc(26,nt,4,3,"ng-container",13),t.qZA()()()),2&e){const r=t.MAs(12),s=t.MAs(18),u=t.MAs(23);t.xp6(8),t.ekj("was-validated",r.dirty||r.touched),t.xp6(3),t.Q6J("ngModel",i.nickname)("disabled",!0),t.xp6(8),t.ekj("was-validated",u.dirty||u.touched),t.xp6(3),t.Q6J("ngModel",i.roomNick),t.xp6(2),t.Q6J("disabled",!s.valid),t.xp6(2),t.Q6J("ngIf",u.invalid)}},dependencies:[h.O5,m._Y,m.Fj,m.JJ,m.JL,m.Q7,m.wO,m.nD,m.On,m.F,f.rH]})}return n})();function rt(n,c){1&n&&(t.ynx(0),t._UZ(1,"span",2),t.BQk())}function st(n,c){if(1&n){const o=t.EpF();t.ynx(0),t.TgZ(1,"gitfire-chat-entrance",3),t.NdJ("roomSelected",function(i){t.CHM(o);const r=t.oxw();return t.KtG(r.onRoomSelected(i))}),t.qZA(),t.BQk()}if(2&n){const o=t.oxw();t.xp6(1),t.Q6J("initialRoomNick",o.roomNick)}}function at(n,c){if(1&n){const o=t.EpF();t.ynx(0),t.TgZ(1,"gitfire-chat-room",4),t.NdJ("exitRoom",function(){t.CHM(o);const i=t.oxw();return t.KtG(i.onExitedRoom())}),t.qZA(),t.BQk()}if(2&n){const o=t.oxw();t.xp6(1),t.Q6J("roomInfo",o.roomInfo)}}const ct=[{path:"",component:(()=>{class n{chat;router;route;destroy$=new x.x;state$=new w.X("loading");roomInfo;roomNick;ensureTos$=new x.x;constructor(o,e,i){this.chat=o,this.router=e,this.route=i}ngOnInit(){this.route.fragment.pipe((0,U.q)(1),(0,R.w)(o=>this.maybeRoomInfo$(o))).subscribe(o=>{if(!o||!o.id)return this.state$.next("entrance"),void(o&&o.nick&&(this.roomNick=o.nick));this.ensureTos$.next(o)}),this.ensureTos$.pipe((0,R.w)(o=>(0,Q.$)((0,_.of)(o),this.chat.confirmTos$()))).subscribe(([o,e])=>{e?(this.state$.next("room"),this.roomInfo=o):(this.state$.next("entrance"),this.roomNick=o.nick)})}ngOnDestroy(){this.destroy$.next()}onRoomSelected(o){(0,d.eM)("onRoomSelected()",o),this.state$.next("room"),this.roomInfo=o,this.router.navigate(["/Gitfire/chat"],{fragment:o.nick})}onExitedRoom(){(0,d.eM)("onExitedRoom()"),this.state$.next("entrance"),this.roomInfo=null,this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(o){return null==o||o.length<4||10<=o.length?(0,_.of)(null):this.chat.maybeRoomInfo$(o)}get isAdActive(){return!!d.NZ.production}static \u0275fac=function(e){return new(e||n)(t.Y36(C),t.Y36(f.F0),t.Y36(f.gz))};static \u0275cmp=t.Xpm({type:n,selectors:[["ng-component"]],decls:6,vars:6,consts:[[3,"ngSwitch"],[4,"ngSwitchCase"],["role","status",1,"spinner-border","text-primary"],[3,"initialRoomNick","roomSelected"],[3,"roomInfo","exitRoom"]],template:function(e,i){1&e&&(t.ynx(0,0),t.ALo(1,"async"),t.YNc(2,rt,2,0,"ng-container",1)(3,st,2,1,"ng-container",1)(4,at,2,1,"ng-container",1),t.BQk(),t._UZ(5,"app-ad-fragment")),2&e&&(t.Q6J("ngSwitch",t.lcZ(1,4,i.state$)),t.xp6(2),t.Q6J("ngSwitchCase","loading"),t.xp6(1),t.Q6J("ngSwitchCase","entrance"),t.xp6(1),t.Q6J("ngSwitchCase","room"))},dependencies:[h.RF,h.n9,S.J,X,it,h.Ov]})}return n})()}];let ut=(()=>{class n{static \u0275fac=function(e){return new(e||n)};static \u0275mod=t.oAB({type:n});static \u0275inj=t.cJS({imports:[f.Bz.forChild(ct),f.Bz]})}return n})();var mt=a(8641);let lt=(()=>{class n{static \u0275fac=function(e){return new(e||n)};static \u0275mod=t.oAB({type:n});static \u0275inj=t.cJS({providers:[k.K,C,g._W,A.c,F.F],imports:[h.ez,m.u5,g.Rh.forRoot(d.NZ.toastrConfig),mt.R,ut,b.M]})}return n})()}}]);