import{a as Ue}from"./chunk-DPFH7O4I.js";import{c as he,d as H,g as P,i as Y}from"./chunk-T2NEJTFN.js";import{b as U,c as Ne}from"./chunk-5LQQWSVJ.js";import"./chunk-N2QKUVGW.js";import"./chunk-QFPXZNHT.js";import"./chunk-M5PFS4RI.js";import"./chunk-QQD6XY2M.js";import"./chunk-UTQ6RLWD.js";import{a as ve,c as $e}from"./chunk-BGEVS7UH.js";import"./chunk-5WAFVXVX.js";import"./chunk-IO3TRROU.js";import{a as ge}from"./chunk-FVIPMTMU.js";import{$a as se,Ba as m,Cb as q,Eb as u,Fb as le,G as te,Gb as ue,Ha as j,Hb as me,Ka as re,La as A,Nc as L,Ob as ce,Oc as B,Pb as $,Qc as p,R as ie,Tc as Ce,Va as h,Vc as ye,Wc as xe,Xa as g,Xb as de,Xc as Z,Yb as pe,Yc as Fe,Z as oe,Zc as Se,_ as k,_a as ae,_c as Ee,aa as M,ab as y,ad as F,b as v,bb as r,cb as a,db as C,ed as be,fa as _,fd as _e,ga as I,gd as Ie,hd as we,id as Pe,jd as Be,kd as Te,l as Q,m as ee,mb as D,nd as ke,od as Me,pb as w,qd as Ae,rb as x,rd as De,sc as fe,sd as N,za as ne}from"./chunk-LR2XCKTF.js";import"./chunk-KEDNFY7G.js";import"./chunk-EU2KAMEK.js";import"./chunk-LZXNU2FR.js";import{a as T,b as J}from"./chunk-VB56BUGO.js";var S=class t{constructor(e,i,o){this.auth=e;this.storage=i;this.funcs=o;p("PostService.constructor()",e,i,o)}destroy$=new v;ngOnDestroy(){p("PostService.OnDestroy()"),this.destroy$.next()}listDraftImages(){let e={};return Q(this.funcs.call("listDraftImages",e))}async generateImageId(e){let i={count:e},o=await this.funcs.call("generateImageId_V2",i);return p(`Fetched count: ${e} ids`,o),o}async uploadImage(e,i){let o=e.id;p(`Uploading ${o} from ${i.name} with size: ${i.size}`);let n=this.storage.ref(e.imagePath),l={contentType:i.type};await n.put(i,l)}getThumbnailUrl$(e){if(e.imageError)return ee(null);let i=e.id,o=this.auth.myUid;return this.storage.ref(e.thumbnailPath).getDownloadURL()}async postComment(e,i,o){let n={text:i,commentType:e,images:o};await this.funcs.call("doPost_V2",n)}async deleteImage(e){let i={imageId:e};await this.funcs.call("deleteImage",i)}static \u0275fac=function(i){return new(i||t)(M(Ne),M(Ue),M(U))};static \u0275prov=oe({token:t,factory:t.\u0275fac,providedIn:"root"})};var Le=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],He=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Ye=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Ze=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],Re=(t,e,i)=>{let o=t;return typeof e=="string"||Array.isArray(e)?o=t.toLocaleString(e,i):(e===!0||i!==void 0)&&(o=t.toLocaleString(void 0,i)),o},Ge=t=>{if(typeof t=="number")return Math.log10(t);let e=t.toString(10);return e.length+Math.log10(`0.${e.slice(0,15)}`)},We=t=>typeof t=="number"?Math.log(t):Ge(t)*Math.log(10),Xe=(t,e)=>{if(typeof t=="number")return t/e;let i=t/BigInt(e),o=t%BigInt(e);return Number(i)+Number(o)/e},ze=(t,e)=>{if(e===void 0)return t;if(typeof e!="number"||!Number.isSafeInteger(e)||e<0)throw new TypeError(`Expected fixedWidth to be a non-negative integer, got ${typeof e}: ${e}`);return e===0?t:t.length<e?t.padStart(e," "):t},Ke=t=>{let{minimumFractionDigits:e,maximumFractionDigits:i}=t;if(!(e===void 0&&i===void 0))return J(T(T({},e!==void 0&&{minimumFractionDigits:e}),i!==void 0&&{maximumFractionDigits:i}),{roundingMode:"trunc"})};function R(t,e){if(typeof t!="bigint"&&!Number.isFinite(t))throw new TypeError(`Expected a finite number, got ${typeof t}: ${t}`);e=T({bits:!1,binary:!1,space:!0,nonBreakingSpace:!1},e);let i=e.bits?e.binary?Ze:Ye:e.binary?He:Le,o=e.space?e.nonBreakingSpace?"\xA0":" ":"",n=typeof t=="number"?t===0:t===0n;if(e.signed&&n){let d=` 0${o}${i[0]}`;return ze(d,e.fixedWidth)}let l=t<0,s=l?"-":e.signed?"+":"";l&&(t=-t);let c=Ke(e),f;if(t<1){let d=Re(t,e.locale,c);f=s+d+o+i[0]}else{let d=Math.min(Math.floor(e.binary?We(t)/Math.log(1024):Ge(t)/3),i.length-1);if(t=Xe(t,(e.binary?1024:1e3)**d),!c){let O=Math.max(3,Math.floor(t).toString().length);t=t.toPrecision(O)}let b=Re(Number(t),e.locale,c),V=i[d];f=s+b+o+V}return ze(f,e.fixedWidth)}var X=class extends Error{constructor(e){super(e)}},K=class extends Error{constructor(e){super(e)}};var z=class extends Error{constructor(e){super(e)}};function Je(t,e){let i=t.width/t.height;if(e.maxSize){let o=e.maxSize;if(t.width>t.height){if(t.width>o)return[o,Math.floor(o/i)]}else if(t.height>o)return[Math.floor(o*i),o];return[t.width,t.height]}else if(e.maxWidth||e.maxHeight){let o=1,n=1;e.maxWidth&&e.maxWidth>0&&t.width>e.maxWidth&&(o=e.maxWidth/t.width),e.maxHeight&&e.maxHeight>0&&t.height>e.maxHeight&&(n=e.maxHeight/t.height);let l=Math.min(o,n,1),s=t.height*l;return[t.width*l,s]}else throw new X("Not a supported configuration. You should add maxSize.")}function Ve(t,e){if(!t.type.match(/^image\//))throw new z(`Not a supported file type: ${t.type}`);let i;typeof e=="number"?i={maxSize:e}:i=e;let o=new v,n=new Image,l=new FileReader;return l.onload=()=>{let s=l.result;n.src=s,n.onload=()=>{let[c,f]=Je(n,i);console.log(`Resize ${n.width}x${n.height} -> ${c}x${f}`);let d=document.createElement("canvas");d.width=c,d.height=f;let b=d.getContext("2d");if(!b)throw new K("Unable to create context on canvas.");b.drawImage(n,0,0,c,f),b.canvas.toBlob(V=>{let O=V;o.next(O),o.complete()},i.outputType||"image/jpeg")}},n.onerror=s=>o.error(s),l.readAsDataURL(t),o}function Oe(t){let e=new v,i=new FileReader;return i.onload=()=>{let o=i.result;if(o===null)throw new z(`${t} is not readable.`);e.next(o)},i.readAsDataURL(t),e}var Qe=(t,e)=>e.id;function et(t,e){t&1&&(r(0,"div",31),u(1,"\u5165\u529B\u5FC5\u9808\u3067\u3059\u3002"),a())}function tt(t,e){t&1&&(r(0,"div",31),u(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),a())}function it(t,e){if(t&1&&(h(0,et,2,0,"div",31),h(1,tt,2,0,"div",31)),t&2){let i=x();g(i.commentControl.errors!=null&&i.commentControl.errors.required?0:-1),m(),g(i.commentControl.errors!=null&&i.commentControl.errors.maxlength?1:-1)}}function ot(t,e){t&1&&(r(0,"div",16),u(1,"OK!"),a())}function nt(t,e){t&1&&(r(0,"div",18)(1,"div",32)(2,"span",33),u(3,"File storage changing..."),a()()())}function rt(t,e){if(t&1&&(r(0,"div",37),u(1),a()),t&2){let i=x().$implicit;m(),me("",i.file==null?null:i.file.name,": ",e)}}function at(t,e){if(t&1&&(r(0,"div",38),C(1,"img",39),de(2,"async"),a()),t&2){let i=x().$implicit;m(),y("alt",$("\u9078\u629E\u3057\u305F\u753B\u50CF ",i.id))("src",ce(pe(2,4,i.thumbUrl$)),ne)}}function st(t,e){if(t&1){let i=D();r(0,"div")(1,"div",34),C(2,"label"),r(3,"input",35),w("change",function(n){let l=_(i).$implicit,s=x();return I(s.onChangeDeleteCheck(n,l))}),a()(),r(4,"div",36),h(5,rt,2,2,"div",37),h(6,at,3,6,"div",38),r(7,"div")(8,"span"),u(9),a()()()()}if(t&2){let i,o=e.$implicit,n=e.$index;m(3),y("id",$("appGitfirePostThumb-",o.id))("formControlName",n),m(2),g((i=o.errorMessage)?5:-1,i),m(),g(o.errorMessage?-1:6),m(3),ue("Size: ",o.displayBytes)}}function lt(t,e){if(t&1){let i=D();r(0,"div")(1,"button",40),w("click",function(n){_(i);let l=x();return I(l.onClickDeleteImages(n))}),u(2,"\u524A\u9664"),a()()}}function ut(t,e){if(t&1&&(r(0,"div")(1,"div",41)(2,"div",42)(3,"div",43),u(4),a(),r(5,"div",44)(6,"span",33),u(7,"Posting..."),a()()()()()),t&2){let i=x();m(),y("@maskTrigger",void 0),m(3),le(i.postProgressMessage)}}var E=class t{constructor(e,i){this.serv=e;this.toastr=i}isMask=!1;destroy$=new v;imageItems=[];inputForm;ImageMaxCount=B.POST_IMAGE_MAX_COUNT;managingFiles=!1;postProgressMessage=null;ngOnDestroy(){this.destroy$.next()}ngOnInit(){this.serv.listDraftImages().pipe(te(1),ie(this.destroy$)).subscribe(e=>{for(let i of e){let o=new F(!1),n={id:i.id,thumbUrl$:this.serv.getThumbnailUrl$(i),displayBytes:R(i.fileSize),form:o};this.deletionControls.push(o),this.imageItems.push(n)}}),this.inputForm=new Ee({}),this.inputForm.addControl("commentType",new F("none",[])),this.inputForm.addControl("comment",new F(null,[Z.required])),this.inputForm.addControl("deletion",new be([])),this.inputForm.addControl("confirmTosCheck",new F(!1,[Z.required])),this.inputForm.addControl("rawImageCheck",new F(!1,[]))}get typeControl(){return this.inputForm.get("commentType")}get commentControl(){return this.inputForm.get("comment")}get rawImageControl(){return this.inputForm.get("rawImageCheck")}get deletionControls(){return this.inputForm.get("deletion")}get confirmControl(){return this.inputForm.get("confirmTosCheck")}async resizeImage(e){return Ve(e,{maxSize:512}).toPromise()}async onChangeFiles(e){p("onChangeFiles()",e);let i=e.target,o=i.files;if(!(o.length<=0)){if(o.length+this.imageItems.length>B.POST_IMAGE_MAX_COUNT){this.toastr.error(`\u6DFB\u4ED8\u53EF\u80FD\u306A\u30D5\u30A1\u30A4\u30EB\u306F ${B.POST_IMAGE_MAX_COUNT} \u500B\u307E\u3067\u3067\u3059\u3002`);return}this.managingFiles=!0;try{for(let n=0;n<o.length;n++){let l=o[n],s;if(this.rawImageControl.value?s=l:s=await this.resizeImage(l),s.size>=20*1024*1024){this.toastr.error("\u30D5\u30A1\u30A4\u30EB\u306E\u30B5\u30A4\u30BA\u304C\u5927\u304D\u3059\u304E\u307E\u3059\u3002(\u7D04 20MB \u307E\u3067)");return}let c=new F(!1),f={file:s,form:c,thumbUrl$:Oe(s),displayBytes:R(s.size)};this.imageItems.push(f),this.deletionControls.push(c)}i.files=null}finally{this.managingFiles=!1}}}async onClickDeleteImages(e){p("onClickDeleteImages()",e);let i=!1;this.managingFiles=!0;try{for(let o of this.imageItems){let n=this.imageItems.indexOf(o);if(this.deletionControls.at(n).value){if(o.id)try{await this.serv.deleteImage(o.id)}catch{o.errorMessage="\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F",i=!0;continue}this.imageItems=this.imageItems.filter(s=>s!==o),this.deletionControls.removeAt(n)}}}finally{this.managingFiles=!1}if(this.deletionSelected=!1,i){this.toastr.error("\u4E00\u90E8\u306E\u753B\u50CF\u306E\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002");return}this.toastr.info("\u753B\u50CF\u3092\u524A\u9664\u3057\u307E\u3057\u305F\u3002")}async doUploadImages(){let e=[],i=this.imageItems.filter(o=>!o.id);if(0<i.length){let o=null;try{o=await this.serv.generateImageId(i.length)}catch(n){throw Ce("Upload \u30D5\u30A1\u30A4\u30EB\u306E id \u751F\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002"),this.toastr.error("\u30D5\u30A1\u30A4\u30EB\u306E upload \u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002"),n}for(let n=0;n<i.length;n++){this.postProgressMessage=`\u30D5\u30A1\u30A4\u30EB\u3092\u30A2\u30C3\u30D7\u30ED\u30FC\u30C9\u3057\u3066\u3044\u307E\u3059\u2026 ( ${n} / ${i.length})`;let l=i[n],s=o[n];try{await this.serv.uploadImage(s,l.file),l.id=s.id,l.errorMessage=null}catch(c){throw l.errorMessage="Upload \u306B\u5931\u6557\u3057\u307E\u3057\u305F",c}}for(let n of this.imageItems)e.push(n.id)}return e}deletionSelected=!1;onChangeDeleteCheck(e,i){p("onClickDeleteCheck()",e);for(let o of this.deletionControls.controls)if(o.value){this.deletionSelected=!0;return}this.deletionSelected=!1}async onClickPost(e){if(p("onClickPost()",e),this.inputForm.invalid||this.commentControl.invalid||this.typeControl.invalid||this.confirmControl.invalid)return;let i=this.commentControl.value,o=this.typeControl.value;this.isMask=!0;try{this.postProgressMessage="\u6295\u7A3F\u306E\u6E96\u5099\u3092\u3057\u3066\u3044\u307E\u3059\u2026";let n=await this.doUploadImages();this.postProgressMessage="\u6295\u7A3F\u3057\u3066\u3044\u307E\u3059\u2026",await this.serv.postComment(o,i,n),this.commentControl.setValue(""),this.confirmControl.setValue(!1),this.typeControl.setValue("none"),this.deletionControls.clear(),this.imageItems=[],this.resetFormControl(this.commentControl),this.resetFormControl(this.typeControl),this.resetFormControl(this.deletionControls),this.resetFormControl(this.confirmControl),this.toastr.info("\u6295\u7A3F\u3092\u53D7\u3051\u4ED8\u3051\u307E\u3057\u305F\u3002\u30E1\u30FC\u30EB\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002")}finally{this.postProgressMessage=null,this.isMask=!1}}resetFormControl(e){e.markAsPristine(),e.markAsUntouched()}get isAdActive(){return!!B.production}static \u0275fac=function(i){return new(i||t)(j(S),j(ge))};static \u0275cmp=re({type:t,selectors:[["gitfire-post"]],decls:56,vars:12,consts:[["mainForm",""],["imageBox",""],[1,"m-3"],[1,"container",3,"formGroup"],[1,"input-group","m-2"],["for","appGitfirePostType",1,"visually-hidden"],["title","\u30B3\u30E1\u30F3\u30C8\u306E\u7A2E\u985E\u306B\u8A72\u5F53\u3059\u308B\u3082\u306E\u304C\u3042\u308C\u3070\u3001\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044\u3002","src","/assets/octicons/question.svg",1,"m-1","octicon-info","help-icon"],["id","appGitfirePostType","name","commentType","formControlName","commentType",1,"form-select"],["value","none"],["value","provisioning"],["value","thanks"],["value","commission"],["value","inquiry"],["value","dislike"],["value","others"],["id","appGitfirePostTextArea","name","comment","formControlName","comment","maxlength","4096","required","","type","text","placeholder","\u30B3\u30E1\u30F3\u30C8",1,"form-control",2,"height","150px"],[1,"valid-feedback"],[2,"position","relative"],[1,"gitfire-mask","d-flex","justify-content-center"],["title","\u9AD8\u89E3\u50CF\u5EA6\u304C\u5FC5\u8981\u306A\u753B\u50CF\u3092 upload \u3057\u305F\u3044\u5834\u5408\u306F check \u3092\u5165\u308C\u3066\u304B\u3089\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044\u3002",1,"form-check"],["aria-label","Check if not shrinkg all images.","formControlName","rawImageCheck","type","checkbox",1,"form-check-input"],[1,"custom-file"],["id","appGitfirePostFilesInput","multiple","","type","file","accept","image/*","aria-label","Choose images to upload.",1,"custom-file-input","form-control",3,"change"],["for","appPostFilesInput",1,"custom-file-label"],["src","/assets/octicons/question.svg",1,"m-1","octicon-info","help-icon",3,"title"],["formArrayName","deletion",1,"input-group","m-2"],[1,"input-group","my-4","m-2"],[1,"mx-auto"],["type","checkbox","required","","name","confirmTosCheck","formControlName","confirmTosCheck","aria-label","Checkbox for Terms Of Service confirmation",1,"form-check-input"],["target","_blank","href","/terms.htm",1,""],["type","submit","title","\u7BA1\u7406\u4EBA\u306B\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u9001\u4FE1\u3057\u307E\u3059\u3002",1,"btn","btn-lg","btn-primary","mx-auto",3,"click","disabled"],[1,"invalid-feedback"],["role","status",1,"spinner-border","text-info"],[1,"visually-hidden"],[1,"form-check"],["title","Upload \u3057\u306A\u3044\u3067\u524A\u9664\u3059\u308B\u5834\u5408\u306F\u30C1\u30A7\u30C3\u30AF\u3057\u3066\u304F\u3060\u3055\u3044\u3002","aria-label","Choose images for deletion.","type","checkbox",1,"form-check-input",3,"change","id","formControlName"],[1,"m-1",2,"max-height","100px","max-width","100px"],[1,"text-danger"],[1,"border"],[2,"height","100%","width","100%",3,"alt","src"],["type","submit",1,"btn","btn-danger",2,"height","50px",3,"click"],["id","appGitfirePostMask",1,"gitfire-mask"],[1,"d-flex","justify-content-center"],[2,"position","fixed","text-align","center","width","100%","border-style","dotted","top","50%","left","0px","font-size","2rem","color","#5566ff"],["role","status",1,"spinner-border","spinner-border-xl","text-info",2,"width","200px","height","200px","position","fixed","top","20%"]],template:function(i,o){if(i&1){let n=D();r(0,"p",2),u(1,"\u7BA1\u7406\u4EBA\u306B\u30B3\u30E1\u30F3\u30C8\u3092\u9001\u4FE1"),a(),r(2,"div",3,0)(4,"div",4)(5,"label",5),u(6,"\u30B3\u30E1\u30F3\u30C8\u7A2E\u5225 (\u7701\u7565\u53EF\u80FD)"),C(7,"img",6),a(),r(8,"select",7)(9,"option",8),u(10,"\u30B3\u30E1\u30F3\u30C8\u7A2E\u5225(\u7701\u7565\u53EF\u80FD)"),a(),r(11,"option",9),u(12,"\u60C5\u5831\u63D0\u4F9B (Provisioning)"),a(),r(13,"option",10),u(14,"\u8B1D\u610F (Thanks)"),a(),r(15,"option",11),u(16,"\u4F9D\u983C (Commision)"),a(),r(17,"option",12),u(18,"\u304A\u554F\u3044\u5408\u308F\u305B (Inquiry)"),a(),r(19,"option",13),u(20,"\u6C17\u306B\u5165\u3089\u306A\u3044 (Dislike)"),a(),r(21,"option",14),u(22,"\u305D\u306E\u4ED6 (Others)"),a()()(),r(23,"div",4),C(24,"textarea",15),h(25,it,2,2)(26,ot,2,0,"div",16),a(),r(27,"div",17),h(28,nt,4,0,"div",18),r(29,"div",4)(30,"div",19),C(31,"input",20),r(32,"label"),u(33,"\u753B\u50CF\u3092\u7E2E\u5C0F\u3057\u306A\u3044"),a()()(),r(34,"div",4)(35,"div",21)(36,"input",22,1),w("change",function(s){return _(n),I(o.onChangeFiles(s))}),a(),r(38,"label",23),u(39,"\u753B\u50CF\u3092\u9078\u629E (\u7701\u7565\u53EF\u80FD)"),a()(),C(40,"img",24),a(),r(41,"div",25),ae(42,st,10,6,"div",null,Qe),h(44,lt,3,0,"div"),a()(),r(45,"div",26)(46,"div",27),C(47,"input",28),r(48,"a",29),u(49,"[\u5229\u7528\u898F\u7D04]"),a(),u(50," \u3092\u78BA\u8A8D\u3057\u307E\u3057\u305F"),a()(),r(51,"div",4)(52,"button",30),w("click",function(s){return _(n),I(o.onClickPost(s))}),u(53,"\u9001\u4FE1"),a()()(),C(54,"app-ad-fragment"),h(55,ut,8,2,"div")}i&2&&(m(2),y("formGroup",o.inputForm),m(2),q("was-validated",o.typeControl.dirty||o.typeControl.touched),m(19),q("was-validated",o.commentControl.dirty||o.commentControl.touched),m(2),g(o.commentControl.invalid?25:26),m(3),g(o.managingFiles?28:-1),m(12),y("title",$("\u753B\u50CF\u306F ",o.ImageMaxCount," \u500B\u307E\u3067\u4E00\u5EA6\u306B\u767B\u9332\u3067\u304D\u307E\u3059\u3002")),m(2),se(o.imageItems),m(2),g(o.deletionSelected?44:-1),m(8),y("disabled",o.inputForm.invalid||o.deletionSelected||o.managingFiles),m(3),g(o.isMask?55:-1))},dependencies:[N,Be,Te,xe,ye,Pe,Fe,Se,ke,Ae,Me,we,Ie,_e,ve,fe],styles:[".gitfire-mask[_ngcontent-%COMP%]{opacity:.5;z-index:10000;background:#000;position:absolute;width:100%;height:100%}#appGitfirePostMask[_ngcontent-%COMP%]{top:0;left:0}"],data:{animation:[he("maskTrigger",[Y(":enter",[P({opacity:0}),H("300ms ease-in-out",P({opacity:"*"}))]),Y(":leave",[P({opacity:"*"}),H("300ms ease-in-out",P({opacity:0}))])])]}})};var mt=[{path:"",component:E}],G=class t{static \u0275fac=function(i){return new(i||t)};static \u0275mod=A({type:t});static \u0275inj=k({imports:[L.forChild(mt),L]})};var je=class t{static \u0275fac=function(i){return new(i||t)};static \u0275mod=A({type:t});static \u0275inj=k({providers:[U,S],imports:[De,N,$e,G,E]})};export{je as GitfirePostModule};
