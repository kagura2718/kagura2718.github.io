import{a as ke}from"./chunk-5WRTKHPQ.js";import{d as Ee,e as Te}from"./chunk-LCE4662W.js";import{c as je}from"./chunk-OUNM32MQ.js";import{a as xe,b as Re,c as Oe,d as We,e as Ne,f as Ue,g as _e,h as Me,i as B,j as Le,k as Be}from"./chunk-BZ4MA5FE.js";import{a as _,b as M,c as T,d as L,e as a,f as De,g as Fe,j as we}from"./chunk-BLXDMDDD.js";import{$ as te,Ba as u,Cb as fe,Eb as c,Fb as he,G as $,Ka as b,M as Y,Oa as de,Ob as N,P as ee,Qc as s,R as C,Tc as E,Va as I,Vc as Ce,Xa as A,Yc as ve,Z as S,Zc as Ie,_c as Ae,a as K,aa as p,ab as P,ad as $e,b as m,ba as re,bb as f,ca as ne,cb as h,cd as Se,da as oe,db as y,ea as ie,eb as R,fb as O,gb as me,gd as be,hd as Pe,ia as ae,ic as ge,la as se,m as X,ma as ce,nb as W,o as d,pb as pe,ra as v,sd as ye,ya as ue,za as le}from"./chunk-YBLQCMPS.js";import{R as U}from"./chunk-LZXNU2FR.js";import{a as Q,d as Z}from"./chunk-VB56BUGO.js";var rr="auth";var k=class{constructor(){return T(rr)}};var D=function(){return D=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var l in t)Object.prototype.hasOwnProperty.call(t,l)&&(e[l]=t[l])}return e},D.apply(this,arguments)};var ir={includeMetadataChanges:!1};function j(r,e){return e===void 0&&(e=ir),new K(function(t){var n=B(r,e,{next:t.next.bind(t),error:t.error.bind(t),complete:t.complete.bind(t)});return{unsubscribe:n}})}function qe(r){return j(r,{includeMetadataChanges:!0})}function ze(r,e){return e===void 0&&(e={}),qe(r).pipe(d(function(t){return q(t,e)}))}function q(r,e){var t;e===void 0&&(e={});var n=r.data(e);return!r.exists()||typeof n!="object"||n===null||!e.idField?n:D(D({},n),(t={},t[e.idField]=r.id,t))}function Ve(r){return j(r,{includeMetadataChanges:!0}).pipe(d(function(e){return e.docs}))}function Ge(r,e){return e===void 0&&(e={}),Ve(r).pipe(d(function(t){return t.map(function(n){return q(n,e)})}))}var g=class{constructor(e){return e}},Je="firestore",z=class{constructor(){return T(Je)}};var V=new te("angularfire2.firestore-instances");function ar(r,e){let t=M(Je,r,e);return t&&new g(t)}function sr(r){return(e,t)=>{let n=e.runOutsideAngular(()=>r(t));return new g(n)}}var cr={provide:z,deps:[[new v,V]]},ur={provide:g,useFactory:ar,deps:[[new v,V],De]};function Fo(r,...e){return U("angularfire",_.full,"fst"),ne([ur,cr,{provide:V,useFactory:sr(r),multi:!0,deps:[ce,ae,L,Fe,[new v,k],[new v,we],...e]}])}var wo=a(Ge,!0);var He=a(ze,!0);var xo=a(xe,!0,2);var Qe=a(Re,!0,2);var Ro=a(Oe,!0);var Oo=a(Ue,!0,2);var Wo=a(Ne,!0,2),No=a(We,!0,2);var Ze=a(_e,!0,2);var Uo=a(Me,!0,2);function Mo(r=[]){return{toFirestore(e){let o=e,{id:t}=o;return Z(o,["id"])},fromFirestore(e,t){let n=e.data(t);return Q({id:e.id},n)}}}function Ke(r=[]){return{toFirestore(e){return e},fromFirestore(e,t){return e.data(t)}}}var F=class{saveNeverAsk;isConfirmed};function mr(r,e){r&1&&(f(0,"div",1),y(1,"div",11),h()),r&2&&(u(),P("innerHTML",e.html,ue))}function pr(r,e){r&1&&y(0,"span",2)}var w=class r extends Ee{confirmed=new se;inputConfirmForm;tosJson=ge();constructor(){super()}ngOnInit(){s("TosConfirmComponent.OnInit()"),this.inputConfirmForm=new Ae({}),this.inputConfirmForm.addControl("neverConfirmTosCheck",new $e(!1))}get neverCheckTosControl(){return this.inputConfirmForm.get("neverConfirmTosCheck")}onClickConfirm(e){if(s("TosConfirmComponent.onClickConfirm()"),e.preventDefault(),this.inputConfirmForm.markAllAsTouched(),this.inputConfirmForm.invalid)return;let t=new F,n=this.inputConfirmForm.get("neverConfirmTosCheck");t.saveNeverAsk=n.value,t.isConfirmed=!0,this.confirmed.emit(t),this.close()}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=b({type:r,selectors:[["gitfire-tos-confirm"]],inputs:{tosJson:[1,"tosJson"]},outputs:{confirmed:"confirmed",tosJson:"tosJsonChange"},features:[de],decls:18,vars:5,consts:[[1,"container"],[1,"m-3"],["role","status",1,"spinner-border","text-primary"],[1,"text-center"],[3,"formGroup"],[1,"m-5","custom-control","custom-checkbox"],["for","appGitfireTosConfirmNeverDismissCheck",1,"visually-hidden"],["id","appGitfireTosConfirmNeverDismissCheck","name","neverConfirmTosCheck","formControlName","neverConfirmTosCheck","type","checkbox",1,"form-check-input"],[1,"text-muted","fw-light"],["href","/terms.htm","about","_blank"],["id","appGitfireTosConfirmButton",1,"btn","btn-success",3,"click","disabled"],[3,"innerHTML"]],template:function(t,n){if(t&1&&(f(0,"div",0),I(1,mr,2,1,"div",1)(2,pr,1,0,"span",2),f(3,"div",3)(4,"form",4)(5,"div",5)(6,"label",6),c(7,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),h(),y(8,"input",7),c(9,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),h(),f(10,"div",8),c(11,"\u8A73\u3057\u304F\u306F"),f(12,"a",9),c(13,"[\u5229\u7528\u898F\u7D04]"),h(),c(14,"\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002 "),h(),f(15,"div",1)(16,"button",10),pe("click",function(l){return n.onClickConfirm(l)}),c(17,"\u78BA\u8A8D\u3057\u307E\u3057\u305F"),h()()()()()),t&2){let o;u(),A((o=n.tosJson())?1:2,o),u(3),P("formGroup",n.inputConfirmForm),u(),fe("was-validated",n.neverCheckTosControl.dirty||n.neverCheckTosControl.touched),u(11),P("disabled",!n.inputConfirmForm.valid)}},dependencies:[ye,Se,Ce,ve,Ie,Pe,be],encapsulation:2})};var Xe=class r{constructor(e,t,n){this.http=e;this.dialog=t;this.firestore=n}UserAgreementConverter=Ke(["createdAt"]);ProtectedUserPrefix="users/v1/protected";destroy$=new m;ngOnDestroy(){s("TosService.OnDestroy()"),this.destroy$.next()}constructSetupTosConfirm(e,t){return n=>{n.tosJson.set(t.json),n.confirmed.pipe(C(this.destroy$)).subscribe(o=>{if(!o.isConfirmed)throw new Error("assert");o.saveNeverAsk?t.answer=2:t.answer=0,e.next(t)})}}confirmTos$(e,t){if(e.match(/\/$/))throw new Error(`Assertion. Not a supported ${e}`);let n=new m,o=new m,l=new m,tt=this.http.fetchGhJson(t).pipe($(1),ee(i=>{let x=`${this.ProtectedUserPrefix}/${e}/${i.version}`,J=Qe(this.firestore,x).withConverter(this.UserAgreementConverter),H={json:i,cached:!1,cacheRef:J};return He(J).pipe(d(rt=>(rt?.alwaysConfirmed&&(s("TOS has already been confirmed."),H.cached=!0),H)))}));return l.pipe(C(this.destroy$)).subscribe({next:i=>{this.dialog.createDefaultBuilder().prepareBody(w).setupChild(this.constructSetupTosConfirm(o,i)).setType(1).setSize(1).setTitle("\u5229\u7528\u898F\u7D04\u306E\u78BA\u8A8D").closeButton(()=>{i.answer=1,o.next(i)}).setFinalize(()=>{i.answer=1,o.next(i)}).open()},complete:()=>{s("completed dialog$")},error:i=>{E("error dialog$",i)}}),tt.pipe($(1),C(this.destroy$)).subscribe({next:i=>{if(i.cached){n.next(!0);return}l.next(i)},complete:()=>{s("Completed TOS reading")},error:i=>{E("Failed reading TOS cache",i)}}),o.pipe($(1),C(this.destroy$)).subscribe({next:async i=>{switch(i.answer){case 0:n.next(!0);break;case 1:n.next(!1);break;case 2:let x={_docClass:"User:UserAgreementStore",alwaysConfirmed:!0,createdAt:Le()};n.next(!0),await Ze(i.cacheRef,x);break;default:throw new Error(`Not a valid answer ${i.answer}`)}},complete:()=>{s("Completed dialog result."),n.complete()},error:i=>{E("Failed receive dialog result"),n.complete()}}),n}static \u0275fac=function(t){return new(t||r)(p(ke),p(Te),p(g))};static \u0275prov=S({token:r,factory:r.\u0275fac,providedIn:"root"})};var Ye=class r{constructor(e,t){this.store=e;this.auth=t;this.pubUser=this.store.collection("/users/v1/public")}destroy$=new m;pubUser;nicknameCache={};userCache={};env=re(oe);ngOnDestroy(){s("UserService.OnDestroy"),this.destroy$.next()}myNickname$(){return this.auth.myUid?this.nickname$(this.auth.myUid):X("")}user$(e){let t=this.userCache[e];return t||(t=ie(this.env,()=>this.pubUser.doc(e).valueChanges().pipe(Y(1))),this.userCache[e]=t,t)}nickname$(e){let t=this.nicknameCache[e];return t||(t=this.user$(e).pipe(d(n=>n?n.nickname:null)),this.nicknameCache[e]=t,t)}static \u0275fac=function(t){return new(t||r)(p(Be),p(je))};static \u0275prov=S({token:r,factory:r.\u0275fac,providedIn:"root"})};function fr(r,e){r&1&&me(0,"img",2),r&2&&W("src",N(e),le)}function hr(r,e){if(r&1&&(R(0,"span",0),I(1,fr,1,2,"img",2),c(2),O()),r&2){let t,n=e;W("title",N(n.about)),u(),A((t=n.photoURL)?1:-1,t),u(),he(n.nickname)}}function gr(r,e){r&1&&(R(0,"span",1),c(1,"[\u524A\u9664]"),O())}var et=class r{userPublic;constructor(){}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=b({type:r,selectors:[["gitfire-user-box"]],inputs:{userPublic:"userPublic"},decls:2,vars:1,consts:[[1,"p-1",3,"title"],["title","\u524A\u9664\u3055\u308C\u305F\u30E6\u30FC\u30B6\u3067\u3059",1,"text-warning"],[1,"p-1",2,"height","100%","width","2rem",3,"src"]],template:function(t,n){if(t&1&&I(0,hr,3,4,"span",0)(1,gr,2,0,"span",1),t&2){let o;A((o=n.userPublic)?0:1,o)}},encapsulation:2})};export{g as a,Fo as b,wo as c,He as d,xo as e,Qe as f,Ro as g,Oo as h,Wo as i,No as j,Uo as k,Mo as l,Ke as m,Xe as n,Ye as o,et as p};
