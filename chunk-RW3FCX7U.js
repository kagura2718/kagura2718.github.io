import{a as nt}from"./chunk-WX33DUA6.js";import{a as ct}from"./chunk-3O3IBVE7.js";import{c as R,d,g as n,h as it,i as m,k as x,l as k}from"./chunk-T2NEJTFN.js";import{b as rt,c as st}from"./chunk-OUNM32MQ.js";import{k as at}from"./chunk-BZ4MA5FE.js";import{c as ot}from"./chunk-UM24SFZX.js";import{$a as H,Ba as a,Bb as W,E as j,Eb as f,Fb as $,Ha as b,Jc as tt,Ka as Q,Nc as et,Ob as D,P as I,Qb as Y,Qc as T,R as M,Tb as z,Va as _,Xa as g,Xb as C,Yb as A,Zb as J,_a as G,ab as u,b as E,ba as q,bb as s,c as F,cb as c,d as B,da as X,db as w,ea as L,fa as y,ga as v,mb as U,na as N,o as S,p as P,pb as h,rb as p,sc as K,tc as Z,x as V,z as O}from"./chunk-YBLQCMPS.js";var dt=i=>({id:i}),mt=(i,e)=>e.id;function ut(i,e){i&1&&(s(0,"div",2)(1,"div",4)(2,"span",5),f(3,"Notification is alived."),c()()())}function ft(i,e){i&1&&(s(0,"span",12),f(1),c()),i&2&&(u("@shakeItTrigger",void 0),a(),$(e))}function yt(i,e){if(i&1&&(s(0,"a",18),f(1),c()),i&2){let t=p().$implicit;u("routerLink",D(t.anchorLink))("fragment",t.anchorId),a(),$(t.title)}}function vt(i,e){if(i&1&&f(0),i&2){let t=p().$implicit;$(t.title)}}function _t(i,e){if(i&1){let t=U();s(0,"tr",6)(1,"td",17),_(2,yt,2,4,"a",18)(3,vt,1,1),c(),s(4,"td",19),C(5,"date"),s(6,"a",20),f(7),C(8,"relativeTime"),c()(),s(9,"td")(10,"input",21),h("click",function(r){let l=y(t).$implicit,pt=p(3);return v(pt.onClickRead(r,l))}),c()()()}if(i&2){let t=e.$implicit;a(),u("title",Y("Title: ",t.title,`

`,t.body)),a(),g(t.anchorLink?2:3),a(2),u("title",D(J(5,10,t.createdAt.toDate(),"yyyy-MM-dd HH:MM"))),a(2),u("queryParams",z(15,dt,t.id)),a(),$(A(8,13,t.createdAt.toDate())),a(3),u("disabled",t.hasRead)("checked",!!t.hasRead)}}function gt(i,e){if(i&1){let t=U();s(0,"div")(1,"div",6)(2,"div",7)(3,"button",8),h("click",function(r){y(t);let l=p(2);return v(l.onClickNext(r))}),w(4,"img",9),c(),s(5,"button",10),h("click",function(r){y(t);let l=p(2);return v(l.onClickPrevious(r))}),w(6,"img",11),c(),_(7,ft,2,2,"span",12),C(8,"async"),c(),s(9,"div",13)(10,"table",14),G(11,_t,11,17,"tr",6,mt),c()(),s(13,"div",7)(14,"button",15),h("click",function(r){y(t);let l=p(2);return v(l.onClickReadAll(r))}),f(15,"Read All"),w(16,"img",16),c()()()()}if(i&2){let t,o=p(2);a(7),g((t=A(8,2,o.pagingMessage$))?7:-1,t),a(3),u("@notificationItemTrigger",o.pageNavigationState),a(),H(o.notifications())}}function ht(i,e){if(i&1){let t=U();s(0,"div",0),h("click",function(r){y(t);let l=p();return v(l.onClickTraySpinner(r))}),w(1,"img",1),_(2,ut,4,0,"div",2),C(3,"async"),c(),s(4,"div",3),C(5,"async"),_(6,gt,17,4,"div"),c()}if(i&2){let t=p();a(2),g(A(3,4,t.hasMessage$)?2:-1),a(2),W("left",A(5,6,t.trayLeft$),"px"),a(2),g(t.isShowingList()?6:-1)}}var lt=class i{constructor(e,t,o,r){this.auth=e;this.store=t;this.funcs=o;this.router=r}NotificationLimit=10;destroy$=new E;query$=new F(e=>e.limit(this.NotificationLimit));pagingMessage$;message$=new E;clickModal$=new E;hasMessage$;isShowingList=N(!1);isActive=N(!1);notificationsSave=[];notifications=N([]);pageNavigationState;trayLeft$=new B;env=q(X);ngOnInit(){this.auth.clientSideUser$.pipe(M(this.destroy$)).subscribe(t=>{this.isActive.update(o=>!!t)});let e=this.auth.clientSideUser$.pipe(O(t=>!!t),S(t=>`/users/v1/protected/${t.uid}/tray/`));this.hasMessage$=e.pipe(I(t=>L(this.env,()=>this.store.collection(t,r=>r.where("hasRead","==",!1)).valueChanges())),S(t=>t.length>0)),P(e,this.query$).pipe(I(([t,o])=>L(this.env,()=>this.store.collection(t,l=>o(l.orderBy("createdAt","desc"))).valueChanges({idField:"id"}))),M(this.destroy$)).subscribe(t=>{if(t.length===0){this.notifications.set(this.notificationsSave),this.pageNavigationState="nomore",this.message$.next("\u3053\u308C\u4EE5\u4E0A\u901A\u77E5\u306F\u3042\u308A\u307E\u305B\u3093\u3002");return}this.pageNavigationState="enter",this.notifications.set(t)}),this.pagingMessage$=V(this.message$,this.message$.pipe(j(2e3),S(()=>null)),this.clickModal$.pipe(S(()=>null)))}ngOnDestroy(){this.destroy$.next()}onClickTraySpinner(e){T("onClickTraySpinner()",e),this.trayLeft$.next(e.x-300),this.isShowingList.set(!0)}prepareToClick(e){e.stopPropagation(),this.clickModal$.next()}async onClickRead(e,t){T("onClickRead()",e),this.prepareToClick(e);let o={id:t.id};await this.funcs.call("setDoneTray",o)}async onClickReadAll(e){T("onClickReadAll()",e),this.prepareToClick(e),await this.funcs.call("setDoneTrayAll")}onClickNext(e){if(T("onClickNext()",e),this.prepareToClick(e),this.pageNavigationState="next",this.notifications().length===0){this.query$.next(o=>o);return}let t=this.notifications()[0];this.notificationsSave=this.notifications(),this.notifications.set([]),this.query$.next(o=>o.endBefore(t.createdAt).limitToLast(this.NotificationLimit))}onClickPrevious(e){T("onClickPrevious()",e),this.prepareToClick(e);let t=this.notifications();if(t.length===0)return;this.pageNavigationState="previous";let o=t[t.length-1];this.notificationsSave=t,this.notifications.set([]),this.query$.next(r=>r.startAfter(o.createdAt).limit(this.NotificationLimit))}static \u0275fac=function(t){return new(t||i)(b(st),b(at),b(rt),b(nt))};static \u0275cmp=Q({type:i,selectors:[["app-user-tray"]],decls:1,vars:1,consts:[["data-bs-toggle","dropdown",3,"click"],["src","/assets/octicons/bell.svg",1,"",2,"width","100%","cursor","pointer"],[2,"position","absolute","top","0px"],[1,"dropdown-menu",2,"max-height","400px","width","400px","position","fixed","top","50px"],["role","status",1,"spinner-grow","spinner-grow-sm","text-warning"],[1,"visually-hidden"],[1,"m-3"],[1,"m-2"],["title","\u65B0\u3057\u3044\u901A\u77E5\u30DA\u30FC\u30B8\u3092\u8868\u793A\u3057\u307E\u3059\u3002",1,"btn","btn-outline-info","btn-sm","mx-1",3,"click"],["src","/assets/octicons/arrow-left.svg",1,"mx-3"],["title","\u53E4\u3044\u901A\u77E5\u30DA\u30FC\u30B8\u3092\u8868\u793A\u3057\u307E\u3059\u3002",1,"btn","btn-outline-info","btn-sm","mx-1",3,"click"],["src","/assets/octicons/arrow-right.svg",1,"mx-3"],[1,"text-warning","mx-2"],[2,"height","250px","overflow-y","scroll","overflow-x","hidden"],[2,"width","100%"],["title","\u3059\u3079\u3066\u65E2\u8AAD\u306B\u3057\u307E\u3059",1,"btn","btn-warning",3,"click"],["src","/assets/octicons/check.svg",1,"mx-2"],[2,"overflow-x","hidden",3,"title"],[3,"routerLink","fragment"],[3,"title"],["routerLink","/Gitfire/tray",3,"queryParams"],["type","checkbox","title","\u65E2\u8AAD\u306B\u3059\u308B\u5834\u5408\u306F check \u3057\u3066\u304F\u3060\u3055\u3044\u3002",1,"m-2",3,"click","disabled","checked"]],template:function(t,o){t&1&&_(0,ht,7,8),t&2&&g(o.isActive()?0:-1)},dependencies:[et,tt,ot,K,Z,ct],styles:["[_nghost-%COMP%]{cursor:initial}tr[_ngcontent-%COMP%]:nth-child(2n){background-color:snow}"],data:{animation:[R("shakeItTrigger",[m(":leave",[n({transform:"none",position:"absolute"}),d("300ms ease-in-out",n({opacity:0,transform:"translateY(-100%)"}))]),m(":enter",[n({transform:"none",position:"absolute"}),d("1000ms ease-in-out",it([n({transform:"translate3d(-4px, 0, 0)",offset:.1}),n({transform:"translate3d(4px, 0, 0)",offset:.2}),n({transform:"translate3d(-3px, 0, 0)",offset:.3}),n({transform:"translate3d(3px, 0, 0)",offset:.4}),n({transform:"translate3d(-3px, 0, 0)",offset:.5}),n({transform:"translate3d(2px, 0, 0)",offset:.6}),n({transform:"translate3d(-2px, 0, 0)",offset:.7}),n({transform:"translate3d(1px, 0, 0)",offset:.8}),n({transform:"translate3d(-1px, 0, 0)",offset:.9})]))])]),R("notificationItemTrigger",[m(":enter",[x("tr",[n({opacity:0,transform:"translateX(-100%)"}),k(20,[d("300ms ease-in-out",n({opacity:1,transform:"none"}))])],{optional:!0})]),m("* => previous",[x("tr",[n({}),k(20,[d("300ms ease-in-out",n({opacity:0,transform:"translateX(-100%)"}))])],{optional:!0})]),m("previous => enter",[x("tr",[n({opacity:0,transform:"translateX(100%)"}),k(20,[d("300ms 100ms ease-in-out",n({opacity:1,transform:"none"}))])],{optional:!0})]),m("* => next",[x("tr",[n({}),k(20,[d("300ms ease-in-out",n({opacity:0,transform:"translateX(100%)"}))])],{optional:!0})]),m("next => enter",[x("tr",[n({opacity:0,transform:"translateX(-100%)"}),k(20,[d("300ms 100ms ease-in-out",n({opacity:1,transform:"none"}))])],{optional:!0})]),m("* => nomore",[n({opacity:0,backgroundColor:"red"}),d("300ms 100ms ease-in-out",n({opacity:1,backgroundColor:"*"}))])])]}})};export{lt as a};
