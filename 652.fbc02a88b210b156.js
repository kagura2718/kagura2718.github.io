"use strict";(self.webpackChunkKaguraGithubPages=self.webpackChunkKaguraGithubPages||[]).push([[652],{3652:(ft,I,a)=>{a.r(I),a.d(I,{GitfireChatModule:()=>lt});var m=a(6504),h=a(1368),g=a(4400),x=a(2112),k=a(1528),G=a(9252),v=a(9900),A=a(4704),d=a(6716),t=a(4496),$=a(5192),D=a(4304),b=a(8472),T=a(2980);class M{id;nick;isOwned=!1}class w extends M{isExisting;constructor(c){super(),this.isExisting=c}}let p=(()=>{class n{tos;auth;store;funcs;user;room;roomIndex;constructor(o,e,i,r,s){this.tos=o,this.auth=e,this.store=i,this.funcs=r,this.user=s,this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}fieldTimestamp(){return G.c.firestore.FieldValue.serverTimestamp()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,d.OU.ChatServiceTosUrl)}readChitchat$(o){return this.room.doc(o).collection("chitchat",e=>e.orderBy("createdAt","desc").limit(30))}postComment$(o,e){return(0,v.Q)(this.funcs.call("postChat",{roomId:o,text:e}))}deleteRoom$(o){var e=this;if(!o)throw new Error("roomId is not supplied");const i=this.room.doc(o);return(0,v.Q)(this.store.firestore.runTransaction(function(){var r=(0,k.c)(function*(s){const l=(yield s.get(i.ref)).data().nick,C=e.roomIndex.doc(l);yield s.delete(i.ref),yield s.delete(C.ref)});return function(s){return r.apply(this,arguments)}}()))}ensureRoom$(o){var e=this;if(!o)throw new Error("room nick is not supplied");const r=this.roomIndex.doc(o);return(0,v.Q)(this.store.firestore.runTransaction(function(){var s=(0,k.c)(function*(u){const R=yield u.get(r.ref),l=new w(!0);if(l.nick=o,R.exists){const O=R.data();return l.id=O.value,l.isOwned=O.owner===e.auth.myUid,l}const C=e.room.ref.doc(),ht={nick:o,owner:e.auth.myUid,createdAt:e.fieldTimestamp()};yield u.set(C,ht);const dt={value:C.id,owner:e.auth.myUid};return yield u.set(r.ref,dt),l.id=C.id,l.isExisting=!1,l.isOwned=!0,l});return function(u){return s.apply(this,arguments)}}()))}maybeRoomInfo$(o){return this.roomIndex.doc(o).get().pipe((0,A.k)(i=>{const r=new w(!!i.exists);if(r.nick=o,!i.exists)return r;const s=i.data();return r.isOwned=s.owner===this.auth.myUid,r.id=s.value,r}))}static \u0275fac=function(e){return new(e||n)(t.CoB($.k),t.CoB(D.o),t.CoB(b.i4),t.CoB(x.W),t.CoB(T.o))};static \u0275prov=t.wxM({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var S=a(8784),f=a(4192),E=a(5657),Y=a(6700),N=a(2392),B=a(2700),_=a(3992),y=a(7368),U=a(6460);class j{id;text;admin;html;createdAt;user$;constructor(c,o,e,i,r,s){this.id=c,this.text=o,this.admin=e,this.html=i,this.createdAt=r,this.user$=s}}var F=a(6520),K=a(496),Q=a(6016),P=a(8631);const V=["chatBox"];function H(n,c){1&n&&t.wR5(0,"div",9)}function J(n,c){1&n&&t.wR5(0,"gitfire-user-box",16),2&n&&t.E7m("userPublic",c.ngIf)}function X(n,c){if(1&n&&t.wR5(0,"div",17),2&n){const o=t.GaO().$implicit;t.E7m("innerHTML",o.html,t.E3n)}}function L(n,c){if(1&n&&(t.I0R(0,"div",18),t.OEk(1),t.C$Y()),2&n){const o=t.GaO().$implicit;t.yG2(),t.cNF(o.text)}}function W(n,c){if(1&n&&(t.I0R(0,"div",10)(1,"div",11),t.OEk(2),t.wVc(3,"relativeTime"),t.C$Y(),t.I0R(4,"div",12),t.yuY(5,J,1,1,"gitfire-user-box",13),t.wVc(6,"async"),t.C$Y(),t.yuY(7,X,1,1,"div",14)(8,L,2,1,"div",15),t.C$Y()),2&n){const o=c.$implicit;t.E7m("ngClass",o.admin?"bg-info text-white":"text-muted"),t.yG2(2),t.oRS("",t.kDX(3,5,o.createdAt)," "),t.yG2(3),t.E7m("ngIf",t.kDX(6,7,o.user$)),t.yG2(2),t.E7m("ngIf",o.html),t.yG2(),t.E7m("ngIf",!o.html)}}let z=(()=>{class n{chat;dialog;toastr;destroy$=new E.E;roomInfo;exitRoom=new t._w7;message="";chatBox;chitchat=[];chitchatMap={};constructor(o,e,i){this.chat=o,this.dialog=e,this.toastr=i}ngOnInit(){this.chat.readChitchat$(this.roomInfo.id).valueChanges({idField:"id"}).subscribe(e=>{(0,d.qe)("Receive ChitChat",e);for(const i of e){const r=i.id;let s=this.chitchatMap[r];const u=i;s||(s=new j(r,u.text,!!u.admin,u.html,u.createdAt?u.createdAt.toDate():new Date,this.chat.user.user$(u.uid)),this.chitchat.push(s),this.chitchatMap[r]=s)}this.chitchat=this.chitchat.sort((i,r)=>this.descDate(i.createdAt,r.createdAt))})}descDate(o,e){return o===e?0:o<e?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo.id).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524a\u9664\u3057\u307e\u3057\u305f\u3002")})}onClickDeleteRoom(o){this.dialog.createSimpleBuilder().setType(F.aU.Warn).setSize(F.q2.Default).setTitle("\u78ba\u8a8d").setMessage("\u672c\u5f53\u306b\u524a\u9664\u3057\u307e\u3059\u304b\uff1f").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(o){this.exitRoom.emit()}onPostComment(o){this.chatBox.invalid||this.chat.postComment$(this.roomInfo.id,this.message).subscribe(e=>{const i=this.chatBox.control;i.setValue(""),i.markAsPristine()},e=>{(0,d.sJ)("Error while post chat",e);const i=e instanceof Error?e.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307e\u3057\u305f\u3002 ( ${i} )`)})}static \u0275fac=function(e){return new(e||n)(t.GI1(p),t.GI1(K.EF),t.GI1(g.SA))};static \u0275cmp=t.In1({type:n,selectors:[["gitfire-chat-room"]],viewQuery:function(e,i){if(1&e&&t.CC$(V,5),2&e){let r;t.wto(r=t.Gqi())&&(i.chatBox=r.first)}},inputs:{roomInfo:"roomInfo"},outputs:{exitRoom:"exitRoom"},decls:12,vars:8,consts:[[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"disabled","title","click"],["title","\u5165\u53e3\u306b\u623b\u308a\u307e\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModel","ngModelChange","keyup.enter"],["chatBox","ngModel"],[1,"col-3","btn","btn-primary",3,"disabled","click"],["class","valid-feedback",4,"ngIf"],["class","row m-3",3,"ngClass",4,"ngFor","ngForOf"],[1,"valid-feedback"],[1,"row","m-3",3,"ngClass"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic",4,"ngIf"],["class","col-8",3,"innerHTML",4,"ngIf"],["class","col-8",4,"ngIf"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(e,i){if(1&e&&(t.I0R(0,"div",0)(1,"button",1),t.qCj("click",function(s){return i.onClickDeleteRoom(s)}),t.OEk(2,"\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u524a\u9664"),t.C$Y(),t.I0R(3,"button",2),t.qCj("click",function(s){return i.onClickExitRoom(s)}),t.OEk(4,"\u9000\u5ba4"),t.C$Y()(),t.I0R(5,"div",3)(6,"input",4,5),t.iHE("ngModelChange",function(s){return t.kNx(i.message,s)||(i.message=s),s}),t.qCj("keyup.enter",function(s){return i.onPostComment(s)}),t.C$Y(),t.I0R(8,"button",6),t.qCj("click",function(s){return i.onPostComment(s)}),t.OEk(9,"\u9001\u4fe1"),t.C$Y(),t.yuY(10,H,1,0,"div",7),t.C$Y(),t.yuY(11,W,9,9,"div",8)),2&e){const r=t.Gew(7);t.yG2(),t.E7m("disabled",!i.roomInfo.isOwned)("title",i.roomInfo.isOwned?"":"\u30eb\u30fc\u30e0\u3092\u958b\u8a2d\u3057\u305f\u4eba\u3060\u3051\u304c\u524a\u9664\u3067\u304d\u307e\u3059\u3002"),t.yG2(4),t.eAK("was-validated",r.dirty||r.touched),t.yG2(),t.OKB("ngModel",i.message),t.yG2(2),t.E7m("disabled",!r.valid),t.yG2(2),t.E7m("ngIf",r.valid),t.yG2(),t.E7m("ngForOf",i.chitchat)}},dependencies:[h.QF,h.ay,h.u_,m.ot,m.ue,m.eJ,m.Mj,m._G,Q.e,h.a,P.o]})}return n})();var Z=a(6684);const q=["inputRoomForm"];function tt(n,c){1&n&&(t.I0R(0,"div",15),t.OEk(1,"\u90e8\u5c4b\u306e\u540d\u524d(\u30cb\u30c3\u30af\u30cd\u30fc\u30e0)\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),t.C$Y())}function ot(n,c){1&n&&(t.I0R(0,"div",15),t.OEk(1,"\u77ed\u3059\u304e\u307e\u3059\u3002"),t.C$Y())}function et(n,c){1&n&&(t.I0R(0,"div",15),t.OEk(1,"\u9577\u3059\u304e\u307e\u3059\u3002"),t.C$Y())}function nt(n,c){if(1&n&&(t.SAx(0),t.yuY(1,tt,2,0,"div",14)(2,ot,2,0,"div",14)(3,et,2,0,"div",14),t.k70()),2&n){t.GaO();const o=t.Gew(23);t.yG2(),t.E7m("ngIf",null==o.errors?null:o.errors.required),t.yG2(),t.E7m("ngIf",null==o.errors?null:o.errors.minlength),t.yG2(),t.E7m("ngIf",null==o.errors?null:o.errors.maxlength)}}let it=(()=>{class n{chat;toastr;roomSelected=new t._w7;initialRoomNick;inputRoomForm;roomNick;nickname;constructor(o,e){this.chat=o,this.toastr=e}ngOnInit(){this.roomNick=this.initialRoomNick,this.chat.user.myNickname$().subscribe(o=>{this.nickname=o})}onEnterRoom(o){if(!this.inputRoomForm.valid)return;const e=this.roomNick;this.chat.confirmTos$().pipe((0,Z.I)(i=>i),(0,y.G)(i=>this.chat.ensureRoom$(e))).subscribe(i=>{(0,d.qe)(`Creating room id: ${i.id} with ${i.nick}`),this.roomNick="",this.toastr.info(i.isExisting?`chat \u30eb\u30fc\u30e0 "${e}" \u306b\u5165\u5ba4\u3057\u307e\u3059\u3002`:`\u65b0\u3057\u3044 chat \u30eb\u30fc\u30e0 "${e}" \u3092\u4f5c\u308a\u307e\u3057\u305f\u3002`),this.roomSelected.emit(i)})}static \u0275fac=function(e){return new(e||n)(t.GI1(p),t.GI1(g.SA))};static \u0275cmp=t.In1({type:n,selectors:[["gitfire-chat-entrance"]],viewQuery:function(e,i){if(1&e&&t.CC$(q,5),2&e){let r;t.wto(r=t.Gqi())&&(i.inputRoomForm=r.first)}},inputs:{initialRoomNick:"initialRoomNick"},outputs:{roomSelected:"roomSelected"},decls:27,vars:9,consts:[["routerLink","/Gitfire/settings"],[1,""],["chatConfigureForm","ngForm"],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4f8b: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModel","disabled","ngModelChange"],["nickNameBox","ngModel"],["title","\u5165\u5ba4\u3059\u308b\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u540d\u524d\u3067\u3059\u3002\u5b58\u5728\u3057\u306a\u3044\u540d\u524d\u306e\u5834\u5408\u306f\u65b0\u3057\u3044\u90e8\u5c4b\u304c\u4f5c\u3089\u308c\u307e\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["inputRoomForm","ngForm"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModel","ngModelChange"],["roomBox","ngModel"],[1,"btn","btn-primary",3,"disabled","click"],[4,"ngIf"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]],template:function(e,i){if(1&e&&(t.I0R(0,"div")(1,"p"),t.OEk(2,"Chat \u3067\u4f7f\u3046\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3067\u3059\u3002"),t.I0R(3,"a",0),t.OEk(4,"[\u8a2d\u5b9a]"),t.C$Y(),t.OEk(5,"\u304b\u3089\u5909\u66f4\u3067\u304d\u307e\u3059\u3002"),t.C$Y(),t.I0R(6,"form",1,2)(8,"div",3)(9,"label",4),t.OEk(10,"\u30cb\u30c3\u30af\u30cd\u30fc\u30e0"),t.C$Y(),t.I0R(11,"input",5,6),t.iHE("ngModelChange",function(s){return t.kNx(i.nickname,s)||(i.nickname=s),s}),t.C$Y()()()(),t.I0R(13,"div")(14,"h2"),t.OEk(15,"Chat Room \u306e\u540d\u524d"),t.wR5(16,"img",7),t.C$Y(),t.I0R(17,"form",null,8)(19,"div",3)(20,"label",9),t.OEk(21,"Room"),t.C$Y(),t.I0R(22,"input",10,11),t.iHE("ngModelChange",function(s){return t.kNx(i.roomNick,s)||(i.roomNick=s),s}),t.C$Y(),t.I0R(24,"button",12),t.qCj("click",function(s){return i.onEnterRoom(s)}),t.OEk(25,"\u5165\u5ba4"),t.C$Y(),t.yuY(26,nt,4,3,"ng-container",13),t.C$Y()()()),2&e){const r=t.Gew(12),s=t.Gew(18),u=t.Gew(23);t.yG2(8),t.eAK("was-validated",r.dirty||r.touched),t.yG2(3),t.OKB("ngModel",i.nickname),t.E7m("disabled",!0),t.yG2(8),t.eAK("was-validated",u.dirty||u.touched),t.yG2(3),t.OKB("ngModel",i.roomNick),t.yG2(2),t.E7m("disabled",!s.valid),t.yG2(2),t.E7m("ngIf",u.invalid)}},dependencies:[h.u_,m.sz,m.ot,m.ue,m.u,m.eJ,m.El,m.Mj,m._G,m.SC,f.ER]})}return n})();function rt(n,c){1&n&&(t.SAx(0),t.wR5(1,"span",2),t.k70())}function st(n,c){if(1&n){const o=t.KQA();t.SAx(0),t.I0R(1,"gitfire-chat-entrance",3),t.qCj("roomSelected",function(i){t.usT(o);const r=t.GaO();return t.CGJ(r.onRoomSelected(i))}),t.C$Y(),t.k70()}if(2&n){const o=t.GaO();t.yG2(),t.E7m("initialRoomNick",o.roomNick)}}function at(n,c){if(1&n){const o=t.KQA();t.SAx(0),t.I0R(1,"gitfire-chat-room",4),t.qCj("exitRoom",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.onExitedRoom())}),t.C$Y(),t.k70()}if(2&n){const o=t.GaO();t.yG2(),t.E7m("roomInfo",o.roomInfo)}}const ct=[{path:"",component:(()=>{class n{chat;router;route;destroy$=new E.E;state$=new Y.g("loading");roomInfo;roomNick;ensureTos$=new E.E;constructor(o,e,i){this.chat=o,this.router=e,this.route=i}ngOnInit(){this.route.fragment.pipe((0,_.U)(1),(0,y.G)(o=>this.maybeRoomInfo$(o))).subscribe(o=>{if(!o||!o.id)return this.state$.next("entrance"),void(o&&o.nick&&(this.roomNick=o.nick));this.ensureTos$.next(o)}),this.ensureTos$.pipe((0,y.G)(o=>(0,N.E)((0,B.of)(o),this.chat.confirmTos$()))).subscribe(([o,e])=>{e?(this.state$.next("room"),this.roomInfo=o):(this.state$.next("entrance"),this.roomNick=o.nick)})}ngOnDestroy(){this.destroy$.next()}onRoomSelected(o){(0,d.qe)("onRoomSelected()",o),this.state$.next("room"),this.roomInfo=o,this.router.navigate(["/Gitfire/chat"],{fragment:o.nick})}onExitedRoom(){(0,d.qe)("onExitedRoom()"),this.state$.next("entrance"),this.roomInfo=null,this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(o){return null==o||o.length<4||10<=o.length?(0,B.of)(null):this.chat.maybeRoomInfo$(o)}get isAdActive(){return!!d.OU.production}static \u0275fac=function(e){return new(e||n)(t.GI1(p),t.GI1(f.E5),t.GI1(f.gV))};static \u0275cmp=t.In1({type:n,selectors:[["ng-component"]],decls:6,vars:6,consts:[[3,"ngSwitch"],[4,"ngSwitchCase"],["role","status",1,"spinner-border","text-primary"],[3,"initialRoomNick","roomSelected"],[3,"roomInfo","exitRoom"]],template:function(e,i){1&e&&(t.SAx(0,0),t.wVc(1,"async"),t.yuY(2,rt,2,0,"ng-container",1)(3,st,2,1,"ng-container",1)(4,at,2,1,"ng-container",1),t.k70(),t.wR5(5,"app-ad-fragment")),2&e&&(t.E7m("ngSwitch",t.kDX(1,4,i.state$)),t.yG2(2),t.E7m("ngSwitchCase","loading"),t.yG2(),t.E7m("ngSwitchCase","entrance"),t.yG2(),t.E7m("ngSwitchCase","room"))},dependencies:[h.Ko,h.Wm,U.G,z,it,h.a]})}return n})()}];let ut=(()=>{class n{static \u0275fac=function(e){return new(e||n)};static \u0275mod=t.a4G({type:n});static \u0275inj=t.s3X({imports:[f.qQ.forChild(ct),f.qQ]})}return n})();var mt=a(4576);let lt=(()=>{class n{static \u0275fac=function(e){return new(e||n)};static \u0275mod=t.a4G({type:n});static \u0275inj=t.s3X({providers:[T.o,p,g.SA,x.W,$.k],imports:[h.MD,m.y,g.gv.forRoot(d.OU.toastrConfig),mt.w,ut,S.C]})}return n})()}}]);