import{a as Le}from"./chunk-VDKQ57PA.js";import{a as re,b as ae,c as qe}from"./chunk-3A263W2U.js";import{a as Ge}from"./chunk-DZWPX2EF.js";import"./chunk-UZY2HUZO.js";import{e as Ve}from"./chunk-A33I7VZA.js";import{D as je}from"./chunk-6WZUEDWW.js";import{b as ne,c as Pe}from"./chunk-KEXJRQZ7.js";import{h as Ue}from"./chunk-OMBL63PV.js";import"./chunk-3R6BKIBG.js";import"./chunk-M5PFS4RI.js";import"./chunk-QQD6XY2M.js";import"./chunk-CO65H67C.js";import{a as Me,c as ie}from"./chunk-C6C2FNVX.js";import"./chunk-B7ECEPKY.js";import"./chunk-X7DVVCNN.js";import{a as J}from"./chunk-FCGTD6OY.js";import{$a as Ie,$c as Ne,A as Ce,Ab as E,Ba as c,Cb as D,Eb as l,Fb as Se,Fc as ke,G as ve,Gb as we,Ha as d,Ib as $,Ic as De,Jb as O,Jc as Te,Ka as k,Kb as V,La as W,Nc as le,Oc as X,P as N,Qc as I,R as y,Tc as Fe,Va as f,Wa as be,Wc as Y,Xa as h,Xb as j,Yb as U,Yc as Z,Z as ge,Zc as Be,_ as q,_a as Ee,aa as w,ab as C,b as x,ba as Re,bb as s,bd as ee,c as de,cb as m,cd as Ae,da as _e,db as _,ea as A,fa as u,ga as p,l as L,la as G,m as ce,mb as b,na as xe,nd as te,o as fe,pb as v,pd as $e,qd as oe,rb as g,rd as T,sc as K,sd as Oe,ub as Q,vb as z,wb as H,ya as ye,z as he}from"./chunk-WKPNEKYO.js";import"./chunk-KEDNFY7G.js";import"./chunk-EU2KAMEK.js";import"./chunk-LZXNU2FR.js";import"./chunk-VB56BUGO.js";var R=class i{constructor(e,t,o,n,a){this.tos=e;this.auth=t;this.store=o;this.funcs=n;this.user=a;this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}env=Re(_e);room;roomIndex;fieldTimestamp(){return je.firestore.FieldValue.serverTimestamp()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,X.ChatServiceTosUrl)}readChitchat$(e){return A(this.env,()=>this.room.doc(e).collection("chitchat",t=>t.orderBy("createdAt","desc").limit(30)))}postComment$(e,t){let o={roomId:e,text:t};return L(this.funcs.call("postChat",o))}deleteRoom$(e){if(!e)throw new Error("roomId is not supplied");let t=this.room.doc(e);return L(this.store.firestore.runTransaction(async o=>{await A(this.env,async()=>{let r=(await o.get(t.ref)).data().nick,S=this.roomIndex.doc(r);await o.delete(t.ref),await o.delete(S.ref)})}))}ensureRoom$(e){if(!e)throw new Error("room nick is not supplied");return L(this.store.firestore.runTransaction(async t=>await A(this.env,async()=>{let o=this.roomIndex.doc(e),n=await t.get(o.ref);if(n.exists){let pe=n.data();return{id:pe.value,nick:e,isOwned:pe.owner===this.auth.myUid,isExisting:!0}}let a=this.room.ref.doc(),r={nick:e,owner:this.auth.myUid,createdAt:this.fieldTimestamp()};await t.set(a,r);let S={value:a.id,owner:this.auth.myUid};return await t.set(o.ref,S),{id:a.id,nick:e,isExisting:!1,isOwned:!0}})))}maybeRoomInfo$(e){return A(this.env,()=>this.roomIndex.doc(e).get().pipe(fe(o=>{let n={nick:e,isExisting:!!o.exists};if(!o.exists)return n;let a=o.data();return n.isOwned=a.owner===this.auth.myUid,n.id=a.value,n})))}static \u0275fac=function(t){return new(t||i)(w(re),w(Pe),w(Ue),w(ne),w(ae))};static \u0275prov=ge({token:i,factory:i.\u0275fac,providedIn:"root"})};var Ke=["inputRoomForm"];function Je(i,e){i&1&&(s(0,"div",13),l(1,"\u90E8\u5C4B\u306E\u540D\u524D(\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0)\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),m())}function Xe(i,e){i&1&&(s(0,"div",13),l(1,"\u77ED\u3059\u304E\u307E\u3059\u3002"),m())}function Ye(i,e){i&1&&(s(0,"div",13),l(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),m())}function Ze(i,e){if(i&1&&(f(0,Je,2,0,"div",13),f(1,Xe,2,0,"div",13),f(2,Ye,2,0,"div",13)),i&2){g();let t=E(23);h(t.errors!=null&&t.errors.required?0:-1),c(),h(t.errors!=null&&t.errors.minlength?1:-1),c(),h(t.errors!=null&&t.errors.maxlength?2:-1)}}var F=class i{constructor(e,t){this.chat=e;this.toastr=t}roomSelected=new G;initialRoomNick;inputRoomForm;roomNick;nickname;destroy$=new x;ngOnInit(){this.roomNick=this.initialRoomNick,this.chat.user.myNickname$().pipe(y(this.destroy$)).subscribe(e=>{this.nickname=e})}ngOnDestroy(){this.destroy$.next()}onEnterRoom(e){if(!this.inputRoomForm.valid)return;let t=this.roomNick;this.chat.confirmTos$().pipe(he(o=>o),N(o=>this.chat.ensureRoom$(t)),y(this.destroy$)).subscribe(o=>{I(`Creating room id: ${o.id} with ${o.nick}`),this.roomNick="",o.isExisting?this.toastr.info(`chat \u30EB\u30FC\u30E0 "${t}" \u306B\u5165\u5BA4\u3057\u307E\u3059\u3002`):this.toastr.info(`\u65B0\u3057\u3044 chat \u30EB\u30FC\u30E0 "${t}" \u3092\u4F5C\u308A\u307E\u3057\u305F\u3002`),this.roomSelected.emit(o)})}static \u0275fac=function(t){return new(t||i)(d(R),d(J))};static \u0275cmp=k({type:i,selectors:[["gitfire-chat-entrance"]],viewQuery:function(t,o){if(t&1&&Q(Ke,5),t&2){let n;z(n=H())&&(o.inputRoomForm=n.first)}},inputs:{initialRoomNick:"initialRoomNick"},outputs:{roomSelected:"roomSelected"},decls:27,vars:9,consts:[["chatConfigureForm","ngForm"],["nickNameBox","ngModel"],["inputRoomForm","ngForm"],["roomBox","ngModel"],["routerLink","/Gitfire/settings"],[1,""],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4F8B: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModelChange","ngModel","disabled"],["title","\u5165\u5BA4\u3059\u308B\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u540D\u524D\u3067\u3059\u3002\u5B58\u5728\u3057\u306A\u3044\u540D\u524D\u306E\u5834\u5408\u306F\u65B0\u3057\u3044\u90E8\u5C4B\u304C\u4F5C\u3089\u308C\u307E\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"click","disabled"],[1,"invalid-feedback"]],template:function(t,o){if(t&1){let n=b();s(0,"div")(1,"p"),l(2,"Chat \u3067\u4F7F\u3046\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3067\u3059\u3002"),s(3,"a",4),l(4,"[\u8A2D\u5B9A]"),m(),l(5,"\u304B\u3089\u5909\u66F4\u3067\u304D\u307E\u3059\u3002"),m(),s(6,"form",5,0)(8,"div",6)(9,"label",7),l(10,"\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0"),m(),s(11,"input",8,1),V("ngModelChange",function(r){return u(n),O(o.nickname,r)||(o.nickname=r),p(r)}),m()()()(),s(13,"div")(14,"h2"),l(15,"Chat Room \u306E\u540D\u524D"),_(16,"img",9),m(),s(17,"form",null,2)(19,"div",6)(20,"label",10),l(21,"Room"),m(),s(22,"input",11,3),V("ngModelChange",function(r){return u(n),O(o.roomNick,r)||(o.roomNick=r),p(r)}),m(),s(24,"button",12),v("click",function(r){return u(n),p(o.onEnterRoom(r))}),l(25,"\u5165\u5BA4"),m(),f(26,Ze,3,3),m()()()}if(t&2){let n=E(12),a=E(18),r=E(23);c(8),D("was-validated",n.dirty||n.touched),c(3),$("ngModel",o.nickname),C("disabled",!0),c(8),D("was-validated",r.dirty||r.touched),c(3),$("ngModel",o.roomNick),c(2),C("disabled",!a.valid),c(2),h(r.invalid?26:-1)}},dependencies:[T,Ae,Y,Z,Be,te,$e,oe,ee,Ne,Oe,Te],encapsulation:2})};var me=class{constructor(e,t,o,n,a,r){this.id=e;this.text=t;this.admin=o;this.html=n;this.createdAt=a;this.user$=r}};var et=["chatBox"],tt=(i,e)=>e.id;function ot(i,e){i&1&&_(0,"div",7)}function it(i,e){i&1&&_(0,"gitfire-user-box",11),i&2&&C("userPublic",e)}function nt(i,e){if(i&1&&_(0,"div",12),i&2){let t=g().$implicit;C("innerHTML",t.html,ye)}}function rt(i,e){if(i&1&&(s(0,"div",13),l(1),m()),i&2){let t=g().$implicit;c(),Se(t.text)}}function at(i,e){if(i&1&&(s(0,"div",1)(1,"div",9),l(2),j(3,"relativeTime"),m(),s(4,"div",10),f(5,it,1,1,"gitfire-user-box",11),j(6,"async"),m(),f(7,nt,1,1,"div",12)(8,rt,2,1,"div",13),m()),i&2){let t,o=e.$implicit;D("bg-info",o.admin)("text-white",o.admin)("text-muted",!o.admin),c(2),we("",U(3,9,o.createdAt)," "),c(3),h((t=U(6,11,o.user$))?5:-1,t),c(2),h(o.html?7:8)}}var M=class i{constructor(e,t,o){this.chat=e;this.dialog=t;this.toastr=o}destroy$=new x;roomInfo;exitRoom=new G;message="";chatBox;chitchat=xe([]);chitchatMap={};ngOnInit(){this.chat.readChitchat$(this.roomInfo.id).valueChanges({idField:"id"}).pipe(y(this.destroy$)).subscribe(t=>{I("Receive ChitChat",t);for(let o of t){let n=o.id,a=this.chitchatMap[n],r=o;a||(a=new me(n,r.text,!!r.admin,r.html,r.createdAt?r.createdAt.toDate():new Date,this.chat.user.user$(r.uid)),this.chitchat.update(S=>(S.push(a),S)),this.chitchatMap[n]=a)}this.chitchat.update(o=>o.sort((n,a)=>this.descDate(n.createdAt,a.createdAt)))})}descDate(e,t){return e===t?0:e<t?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo.id).pipe(y(this.destroy$)).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524A\u9664\u3057\u307E\u3057\u305F\u3002")})}onClickDeleteRoom(e){this.dialog.createSimpleBuilder().setType(1).setSize(1).setTitle("\u78BA\u8A8D").setMessage("\u672C\u5F53\u306B\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(e){this.exitRoom.emit()}onPostComment(e){this.chatBox.invalid||this.chat.postComment$(this.roomInfo.id,this.message).pipe(y(this.destroy$)).subscribe(t=>{let o=this.chatBox.control;o.setValue(""),o.markAsPristine()},t=>{Fe("Error while post chat",t);let o=t instanceof Error?t.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307E\u3057\u305F\u3002 ( ${o} )`)})}static \u0275fac=function(t){return new(t||i)(d(R),d(Ve),d(J))};static \u0275cmp=k({type:i,selectors:[["gitfire-chat-room"]],viewQuery:function(t,o){if(t&1&&Q(et,5),t&2){let n;z(n=H())&&(o.chatBox=n.first)}},inputs:{roomInfo:"roomInfo"},outputs:{exitRoom:"exitRoom"},decls:13,vars:7,consts:[["chatBox","ngModel"],[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"click","disabled","title"],["title","\u5165\u53E3\u306B\u623B\u308A\u307E\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModelChange","keyup.enter","ngModel"],[1,"col-3","btn","btn-primary",3,"click","disabled"],[1,"valid-feedback"],[1,"row","m-3",3,"bg-info","text-white","text-muted"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(t,o){if(t&1){let n=b();s(0,"div",1)(1,"button",2),v("click",function(r){return u(n),p(o.onClickDeleteRoom(r))}),l(2,"\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u524A\u9664"),m(),s(3,"button",3),v("click",function(r){return u(n),p(o.onClickExitRoom(r))}),l(4,"\u9000\u5BA4"),m()(),s(5,"div",4)(6,"input",5,0),V("ngModelChange",function(r){return u(n),O(o.message,r)||(o.message=r),p(r)}),v("keyup.enter",function(r){return u(n),p(o.onPostComment(r))}),m(),s(8,"button",6),v("click",function(r){return u(n),p(o.onPostComment(r))}),l(9,"\u9001\u4FE1"),m(),f(10,ot,1,0,"div",7),m(),Ee(11,at,9,13,"div",8,tt)}if(t&2){let n=E(7);c(),C("disabled",!o.roomInfo.isOwned)("title",o.roomInfo.isOwned?"":"\u30EB\u30FC\u30E0\u3092\u958B\u8A2D\u3057\u305F\u4EBA\u3060\u3051\u304C\u524A\u9664\u3067\u304D\u307E\u3059\u3002"),c(4),D("was-validated",n.dirty||n.touched),c(),$("ngModel",o.message),c(2),C("disabled",!n.valid),c(2),h(n.valid?10:-1),c(),Ie(o.chitchat())}},dependencies:[T,Y,Z,te,oe,ee,ie,qe,K,Ge],encapsulation:2})};function mt(i,e){i&1&&_(0,"span",0)}function st(i,e){if(i&1){let t=b();s(0,"gitfire-chat-entrance",3),v("roomSelected",function(n){u(t);let a=g();return p(a.onRoomSelected(n))}),m()}if(i&2){let t=g();C("initialRoomNick",t.roomNick)}}function ct(i,e){if(i&1){let t=b();s(0,"gitfire-chat-room",4),v("exitRoom",function(){u(t);let n=g();return p(n.onExitedRoom())}),m()}if(i&2){let t=g();C("roomInfo",t.existRoomInfo)}}var B=class i{constructor(e,t,o){this.chat=e;this.router=t;this.route=o}destroy$=new x;state$=new de("loading");existRoomInfo;roomInfo;roomNick;ensureTos$=new x;ngOnInit(){this.route.fragment.pipe(ve(1),N(e=>this.maybeRoomInfo$(e))).subscribe(e=>{if(!e||!e.id){this.state$.next("entrance"),e&&e.nick&&(this.roomNick=e.nick);return}this.ensureTos$.next(e)}),this.ensureTos$.pipe(N(e=>Ce(ce(e),this.chat.confirmTos$()))).subscribe(([e,t])=>{t?(this.state$.next("room"),this.setRoomInfo(e)):(this.state$.next("entrance"),this.roomNick=e.nick)})}ngOnDestroy(){this.destroy$.next()}onRoomSelected(e){I("onRoomSelected()",e),this.state$.next("room"),this.setRoomInfo(e),this.router.navigate(["/Gitfire/chat"],{fragment:e.nick})}onExitedRoom(){I("onExitedRoom()"),this.state$.next("entrance"),this.setRoomInfo(null),this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(e){return e==null||e.length<4||10<=e.length?ce(null):this.chat.maybeRoomInfo$(e)}get isAdActive(){return!!X.production}setRoomInfo(e){if(!e){delete this.roomInfo,delete this.existRoomInfo;return}this.roomInfo=e,e.id?this.existRoomInfo=e:delete this.existRoomInfo}static \u0275fac=function(t){return new(t||i)(d(R),d(De),d(ke))};static \u0275cmp=k({type:i,selectors:[["ng-component"]],decls:5,vars:3,consts:[["role","status",1,"spinner-border","text-primary"],[3,"initialRoomNick"],[3,"roomInfo"],[3,"roomSelected","initialRoomNick"],[3,"exitRoom","roomInfo"]],template:function(t,o){if(t&1&&(f(0,mt,1,0,"span",0),j(1,"async"),be(2,st,1,1,"gitfire-chat-entrance",1)(3,ct,1,1,"gitfire-chat-room",2),_(4,"app-ad-fragment")),t&2){let n;h((n=U(1,1,o.state$))==="loading"?0:n==="entrance"?2:n==="room"?3:-1)}},dependencies:[F,M,Me,K],encapsulation:2})};var lt=[{path:"",component:B}],se=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=W({type:i});static \u0275inj=q({imports:[le.forChild(lt),le]})};var Qe=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=W({type:i});static \u0275inj=q({providers:[ae,R,ne,re],imports:[T,ie,se,Le,M,F,B]})};export{Qe as GitfireChatModule};
