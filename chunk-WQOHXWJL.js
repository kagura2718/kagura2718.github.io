import{a as oe}from"./chunk-NOGSR6GI.js";import{c as ne}from"./chunk-H6CZANH3.js";import{a as ie}from"./chunk-464AWOC3.js";import{a as b}from"./chunk-OS347QJJ.js";import{a as ae,b as W}from"./chunk-M5PFS4RI.js";import{a as se}from"./chunk-QMCYKMDY.js";import{A as w,Ba as q,C as T,D as V,Eb as Z,G,Ha as u,Ia as K,Ka as X,Oc as M,P as p,Pc as m,Qc as o,R as h,Tc as g,Va as $,Xa as _,Xb as ee,Yb as te,Z as Q,aa as z,b as c,bb as R,cb as I,db as D,fa as E,ga as S,l as y,la as d,m as f,mb as x,na as L,o as l,p as B,pb as k,q as O,r as F,rb as U,sc as re,ub as Y,v as A,vb as j,w as P,wb as J,x as H,z as N}from"./chunk-3INYKKFD.js";var C=class s{constructor(e){this.http=e;this.startPolling()}watchers={};loaders={};polling;MaxWatcherInterval=400;MinWatcherInterval=200;RefreshInterval=50;eventDrawnSubject=new c;eventClearedSubject=new c;eventAppendSubject=new c;eventUpdatedSubject=new c;gatherWatchers(){let e=[],t=M.PageCheckInterval*1e3,r=Date.now()-t;for(let i in this.watchers){let n=this.watchers[i];n.shouldUpdate||r<=n.lastCheckedTime||n.metaUrlHasError||e.push(n)}return W(e)}invokeWatcher(e){let t=this.fetchJson(e.metaUrl).pipe(T(r=>{throw e.metaUrlHasError=!0,r}));return w(t,f(e))}clampInterval(e){return Math.max(Math.min(e,this.MaxWatcherInterval),this.MinWatcherInterval)}startPolling(){let e=M.PageCheckInterval*1e3;this.polling=P(e).pipe(l(r=>this.gatherWatchers()),p(r=>{let i=this.clampInterval(e/r.length);return o(`Polling delay ${i} for ${r.length} watchers`),w(y(r),P(i))}),p(([r,i])=>this.invokeWatcher(r))).subscribe({next:([r,i])=>{if(i.lastCheckedTime=Date.now(),i.lastUpdatedAt>=r.updated)return;i.shouldUpdate=!0,this.eventUpdatedSubject.next();let n=this.loaders[i.id];n?.updatedEvent&&n.updatedEvent.emit(r)},error:r=>{g("Error while polling. Restarting.",r),this.startPolling()},complete:()=>{g("Never complete the polling")}});let t=P(e).pipe(p(r=>this.http.fetchGhJson("/beacons.json",{addNonce:!0})),O(r=>{let i=[];for(let n in r.beacons){let a=r.beacons[n],v=this.http.fetchGhJson(a.resource,{addNonce:!0}).pipe(l(le=>{for(let de of le)if(de.value===a.value)return!0;return!1}));i.push(v)}return B(i).pipe(l(n=>n.every(a=>a)))}))}fetchJson(e){return this.http.fetchGhJson(e).pipe()}gatherRefreshener(){let e=[];for(let t in this.loaders){let r=this.loaders[t];e.push(r)}return W(e)}onClickRefresh(){o("ReloadService.onClickRefresh()");let e=this.gatherRefreshener(),t=this.RefreshInterval;y(e).pipe(l(r=>({loader:r,delay:t})),V(r=>A(r.delay).pipe(l(()=>r.loader)))).subscribe({next:r=>{r.refreshEvent.emit()},complete:()=>{o("ReloadService.onClickRefresh completed()"),this.eventDrawnSubject.next()}})}get eventDrawn(){return this.eventDrawnSubject}get eventCleared(){return this.eventClearedSubject}get eventAppend(){return this.eventAppendSubject}get eventUpdated(){return this.eventUpdatedSubject}findWatcher(e){for(let t in this.watchers)if(this.watchers[t].url===e)return t;return null}generateId(){let e=ae(32);return o(`Generating reloadId: ${e}`),e}ensureLoader(e){let t=this.loaders[e];if(!t)throw new Error(`No loader found for id: ${e}`);return t}appendLoader(e){m(`Creating loader id:${e}`);let t={id:e,refreshEvent:new d};this.loaders[e]=t}registerLoader(){let e=this.generateId();return this.appendLoader(e),this.eventAppendSubject.next(),e}updatedEvent(e){let t=this.ensureLoader(e);return t.updatedEvent||(t.updatedEvent=new d),t.updatedEvent}refreshEvent(e){return this.ensureLoader(e).refreshEvent}registerWatcher(e,t,r){let i=this.findWatcher(e),n;return i?(n=this.watchers[i],n.lastUpdatedAt=t,n.lastCheckedTime=Date.now(),i):(i=this.generateId(),m(`Creating watcher id:${i}`),n={id:i,url:e,metaUrl:r||e,lastUpdatedAt:t,lastCheckedTime:Date.now(),shouldUpdate:!1},this.watchers[i]=n,this.appendLoader(i),this.eventAppendSubject.next(),i)}unregister(e){e in this.watchers&&(m(`Purging watcher id:${e}`),delete this.watchers[e]),e in this.loaders&&(m(`Purging loader id:${e}`),delete this.loaders[e]),Object.keys(this.watchers).length===0&&Object.keys(this.loaders).length===0&&(m("Watchers and Loaders both are cleared."),this.eventClearedSubject.next())}static \u0275fac=function(t){return new(t||s)(z(b))};static \u0275prov=Q({token:s,factory:s.\u0275fac,providedIn:"root"})};var me=["safeDocComponent"],ge=["gitfireCommentLoader"];function ve(s,e){if(s&1){let t=x();R(0,"div",3)(1,"button",4),k("click",function(i){E(t);let n=U(2);return S(n.onClickLoadComment(i))}),D(2,"img",5),Z(3,"\u30B3\u30E1\u30F3\u30C8\u8AAD\u307F\u8FBC\u307F"),I()()}}function fe(s,e){s&1&&D(0,"div",null,1)}function Pe(s,e){if(s&1&&$(0,ve,4,0,"div",3)(1,fe,2,0,"div"),s&2){let t=U();_(t.showComment()&&!t.isCommentLoader()?0:1)}}var ce=class s{constructor(e,t,r,i,n){this.http=e;this.reloader=t;this.loader=r;this.router=i;this.localSession=n}pagePath$;loadError=new d;fatalError=new d;loadPageJson=new d;loadPageBody=new d;currentPath=null;eventForceUpdate$=new c;reloadId;refreshSubscription;destroy$=new c;eventPage$;isCommentLoader=L(!1);showComment=L(!1);safeDocComponent;gitfireCommentLoader;includesComment=["/Gitwee","/Diary/","/Cheater/Gitwee"];excludesComment=[];getPagePath(e){return`${e.jsonPath}.json`}getPageMetaPath(e){return`${e.jsonPath}.json`}fetchJson(e){return this.http.fetchGhJson(this.getPagePath(e)).pipe(l(t=>[e,t]))}ngOnInit(){o("PagePathComponent.OnInit()");let e=new c;this.eventPage$=F(f(null),this.eventForceUpdate$).pipe(p(n=>this.pagePath$),p(n=>this.fetchJson(n)));let t=this.eventPage$.pipe(N(([n,a])=>!a.redirectPath)),r=new c;this.eventPage$.pipe(h(this.destroy$)).subscribe(async([n,a])=>{a.redirectPath&&await this.tryRedirect(n.jsonPath,a.redirectPath)||r.next([n,a])}),H(t,r).pipe(h(this.destroy$)).subscribe({next:async([n,a])=>{o("eventPage$.subscribe",n,a),this.maybeRedisplayComments(n),this.currentPath=n,this.drawPageBody(n,a),this.startWatching(n,a),this.loadPageJson.emit(a)},error:n=>{g(n),this.fatalError.emit(n)},complete:()=>{o("Successfully completed PagePathComponent")}}),e.pipe(h(this.destroy$)).subscribe(n=>this.loadError.emit(n)),this.localSession.markedLogout$.pipe(h(this.destroy$)).subscribe(()=>{this.isCommentLoader.set(!1)})}async tryRedirect(e,t){return o(`redirecting ${e} -> ${t}`),!!await this.router.navigateByUrl(t,{replaceUrl:!0})}startWatching(e,t){this.ensureUnregisterWathing();let r=this.getPagePath(e),i=this.reloader.registerWatcher(r,t.updated);this.reloadId=i,this.refreshSubscription=this.reloader.refreshEvent(i).subscribe(()=>{this.eventForceUpdate$.next()})}onPageLoaded(){this.loadPageBody.emit()}drawPageBody(e,t){o(`PagePathComponent.drawPageBody() drawing page at published at ${t.published}.`);let r=this.safeDocComponent,i=t.virtualPath||e.baseResource;r.setHTML(i,t.html,t.styles)}ensureUnregisterWathing(){this.reloadId&&(this.reloader.unregister(this.reloadId),delete this.reloadId),this.refreshSubscription&&this.refreshSubscription.unsubscribe()}matchToPathList(e,t){for(let r of t){let i;if(r.endsWith("/")?(i=r,r=r.substring(0,-1)):i=`${r}/`,e.startsWith(i)||e===r)return!0}return!1}pathMatch(e,t,r=[]){return!(!this.matchToPathList(e,t)||this.matchToPathList(e,r))}urlSubscription=null;maybeRedisplayComments(e){this.currentPath!==e&&(this.maybeClearComments(),this.showComment.set(!1),this.isCommentLoader.set(!1),this.urlSubscription&&(this.urlSubscription.unsubscribe(),this.urlSubscription=null),this.urlSubscription=this.router.currentUrl$.pipe(h(this.destroy$)).subscribe(t=>{this.pathMatch(t,this.includesComment,this.excludesComment)&&this.showComment.set(!0)}))}maybeClearComments(e){let t=e||this.gitfireCommentLoader;t&&(t.element.nativeElement.innerHTML="",t.clear())}onClickLoadComment(e){o("CommentEntryComponent.onClickLoadComment()"),this.isCommentLoader.set(!0),this.eventPage$.pipe(h(this.destroy$),G(1)).subscribe(async([t,r])=>{o("CommentEntryComponent.onClickLoadComment() -> this.eventPage$",t,r);let{GitfireModule:i}=await import("./chunk-TN4GYYP5.js"),{CommentEntryComponent:n}=await import("./chunk-2AHZVBLK.js"),a=this.gitfireCommentLoader;this.maybeClearComments(a);let v=this.loader.appendComponent(a,i,n);v.pagePath=t,v.pageJson=r})}ngOnDestroy(){o("PagePathComponent.OnDestroy()"),this.ensureUnregisterWathing(),this.destroy$.next()}static \u0275fac=function(t){return new(t||s)(u(b),u(C),u(oe),u(ie),u(se))};static \u0275cmp=X({type:s,selectors:[["app-page-path"]],viewQuery:function(t,r){if(t&1&&Y(me,5)(ge,5,K),t&2){let i;j(i=J())&&(r.safeDocComponent=i.first),j(i=J())&&(r.gitfireCommentLoader=i.first)}},inputs:{pagePath$:"pagePath$"},outputs:{loadError:"loadError",fatalError:"fatalError",loadPageJson:"loadPageJson",loadPageBody:"loadPageBody"},decls:4,vars:3,consts:[["safeDocComponent",""],["gitfireCommentLoader",""],[3,"pageLoaded"],[1,"text-center","m-4"],["type","button","aria-expanded","true","aria-label","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059","title","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059",1,"btn","btn-primary",3,"click"],["src","/assets/octicons/comment.svg",1,"m-1"]],template:function(t,r){if(t&1){let i=x();R(0,"app-safe-doc",2,0),k("pageLoaded",function(){return E(i),S(r.onPageLoaded())}),I(),$(2,Pe,2,1),ee(3,"async")}t&2&&(q(2),_(te(3,1,r.localSession.loginStateChanged$)?2:-1))},dependencies:[ne,re],encapsulation:2})};export{C as a,ce as b};
