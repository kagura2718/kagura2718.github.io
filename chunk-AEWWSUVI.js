import{a as le}from"./chunk-7TT7MF3N.js";import{b as ce}from"./chunk-RGGKVQQV.js";import{a as se}from"./chunk-4KPCAL3S.js";import{a as C}from"./chunk-SKUPV555.js";import{a as de,b as j}from"./chunk-M5PFS4RI.js";import{a as pe}from"./chunk-6ARPVYS7.js";import{b as oe}from"./chunk-EH3KOD6T.js";import{$ as G,$a as K,A as w,Aa as Q,C as F,D as A,Db as ee,G as H,Ga as h,Ha as L,Ja as q,O as l,Oc as U,Pc as u,Q as p,Qc as o,Tc as g,Ua as $,Wa as I,Wb as te,Xb as re,Y as T,ab as _,b as c,bb as R,cb as D,cc as m,dc as ie,ea as V,ec as ne,fa as z,ka as E,l as S,lb as X,m as f,ma as b,o as d,ob as x,p as J,q as M,qb as k,r as W,sc as ae,v as B,w as P,x as O,xb as Y,yb as Z,z as N}from"./chunk-RKIVUD57.js";var y=class s{constructor(e){this.http=e;this.startPolling()}watchers={};loaders={};polling;MaxWatcherInterval=400;MinWatcherInterval=200;RefreshInterval=50;eventDrawnSubject=new c;eventClearedSubject=new c;eventAppendSubject=new c;eventUpdatedSubject=new c;gatherWatchers(){let e=[],t=U.PageCheckInterval*1e3,r=Date.now()-t;for(let n in this.watchers){let i=this.watchers[n];i.shouldUpdate||r<=i.lastCheckedTime||i.metaUrlHasError||e.push(i)}return j(e)}invokeWatcher(e){let t=this.fetchJson(e.metaUrl).pipe(F(r=>{throw e.metaUrlHasError=!0,r}));return w(t,f(e))}clampInterval(e){return Math.max(Math.min(e,this.MaxWatcherInterval),this.MinWatcherInterval)}startPolling(){let e=U.PageCheckInterval*1e3;this.polling=P(e).pipe(d(r=>this.gatherWatchers()),l(r=>{let n=this.clampInterval(e/r.length);return o(`Polling delay ${n} for ${r.length} watchers`),w(S(r),P(n))}),l(([r,n])=>this.invokeWatcher(r))).subscribe({next:([r,n])=>{if(n.lastCheckedTime=Date.now(),n.lastUpdatedAt>=r.updated)return;n.shouldUpdate=!0,this.eventUpdatedSubject.next();let i=this.loaders[n.id];i?.updatedEvent&&i.updatedEvent.emit(r)},error:r=>{g("Error while polling. Restarting.",r),this.startPolling()},complete:()=>{g("Never complete the polling")}});let t=P(e).pipe(l(r=>this.http.fetchGhJson("/beacons.json",{addNonce:!0})),M(r=>{let n=[];for(let i in r.beacons){let a=r.beacons[i],v=this.http.fetchGhJson(a.resource,{addNonce:!0}).pipe(d(ue=>{for(let me of ue)if(me.value===a.value)return!0;return!1}));n.push(v)}return J(n).pipe(d(i=>i.every(a=>a)))}))}fetchJson(e){return this.http.fetchGhJson(e).pipe()}gatherRefreshener(){let e=[];for(let t in this.loaders){let r=this.loaders[t];e.push(r)}return j(e)}onClickRefresh(){o("ReloadService.onClickRefresh()");let e=this.gatherRefreshener(),t=this.RefreshInterval;S(e).pipe(d(r=>({loader:r,delay:t})),A(r=>B(r.delay).pipe(d(()=>r.loader)))).subscribe({next:r=>{r.refreshEvent.emit()},complete:()=>{o("ReloadService.onClickRefresh completed()"),this.eventDrawnSubject.next()}})}get eventDrawn(){return this.eventDrawnSubject}get eventCleared(){return this.eventClearedSubject}get eventAppend(){return this.eventAppendSubject}get eventUpdated(){return this.eventUpdatedSubject}findWatcher(e){for(let t in this.watchers)if(this.watchers[t].url===e)return t;return null}generateId(){let e=de(32);return o(`Generating reloadId: ${e}`),e}ensureLoader(e){let t=this.loaders[e];if(!t)throw new Error(`No loader found for id: ${e}`);return t}appendLoader(e){u(`Creating loader id:${e}`);let t={id:e,refreshEvent:new E};this.loaders[e]=t}registerLoader(){let e=this.generateId();return this.appendLoader(e),this.eventAppendSubject.next(),e}updatedEvent(e){let t=this.ensureLoader(e);return t.updatedEvent||(t.updatedEvent=new E),t.updatedEvent}refreshEvent(e){return this.ensureLoader(e).refreshEvent}registerWatcher(e,t,r){let n=this.findWatcher(e),i;return n?(i=this.watchers[n],i.lastUpdatedAt=t,i.lastCheckedTime=Date.now(),n):(n=this.generateId(),u(`Creating watcher id:${n}`),i={id:n,url:e,metaUrl:r||e,lastUpdatedAt:t,lastCheckedTime:Date.now(),shouldUpdate:!1},this.watchers[n]=i,this.appendLoader(n),this.eventAppendSubject.next(),n)}unregister(e){e in this.watchers&&(u(`Purging watcher id:${e}`),delete this.watchers[e]),e in this.loaders&&(u(`Purging loader id:${e}`),delete this.loaders[e]),Object.keys(this.watchers).length===0&&Object.keys(this.loaders).length===0&&(u("Watchers and Loaders both are cleared."),this.eventClearedSubject.next())}static \u0275fac=function(t){return new(t||s)(G(C))};static \u0275prov=T({token:s,factory:s.\u0275fac,providedIn:"root"})};var Pe=["gitfireCommentLoader"];function be(s,e){if(s&1){let t=X();_(0,"div",2)(1,"button",3),x("click",function(n){V(t);let i=k(2);return z(i.onClickLoadComment(n))}),D(2,"img",4),ee(3,"\u30B3\u30E1\u30F3\u30C8\u8AAD\u307F\u8FBC\u307F"),R()()}}function Ce(s,e){s&1&&D(0,"div",null,0)}function ye(s,e){if(s&1&&$(0,be,4,0,"div",2)(1,Ce,2,0,"div"),s&2){let t=k();I(t.showComment()&&!t.isCommentLoader()?0:1)}}var he=class s{constructor(e,t,r,n,i){this.http=e;this.reloader=t;this.loader=r;this.router=n;this.localSession=i}pagePath=ie();pagePath$=oe(this.pagePath);loadError=m();fatalError=m();loadPageJson=m();loadPageBody=m();currentPath=null;eventForceUpdate$=new c;reloadId;refreshSubscription;destroy$=new c;eventPage$;isCommentLoader=b(!1);showComment=b(!1);gitfireCommentLoader=ne("gitfireCommentLoader",{read:L});includesComment=["/Gitwee","/Diary/","/Cheater/Gitwee"];excludesComment=[];doc=b(null);getPagePath(e){return`${e.jsonPath}.json`}getPageMetaPath(e){return`${e.jsonPath}.json`}fetchJson(e){return this.http.fetchGhJson(this.getPagePath(e)).pipe(d(t=>[e,t]))}ngOnInit(){o("PagePathComponent.OnInit()");let e=new c;this.eventPage$=W(f(null),this.eventForceUpdate$).pipe(l(i=>this.pagePath$),l(i=>this.fetchJson(i)));let t=this.eventPage$.pipe(N(([i,a])=>!a.redirectPath)),r=new c;this.eventPage$.pipe(p(this.destroy$)).subscribe(async([i,a])=>{a.redirectPath&&await this.tryRedirect(i.jsonPath,a.redirectPath)||r.next([i,a])}),O(t,r).pipe(p(this.destroy$)).subscribe({next:async([i,a])=>{o("redrawPage$.subscribe",i,a),this.maybeRedisplayComments(i),this.currentPath=i,this.drawPageBody(i,a),this.startWatching(i,a),this.loadPageJson.emit(a)},error:i=>{g(i),this.fatalError.emit(i)},complete:()=>{o("Successfully completed PagePathComponent")}}),e.pipe(p(this.destroy$)).subscribe(i=>this.loadError.emit(i)),this.localSession.markedLogout$.pipe(p(this.destroy$)).subscribe(()=>{this.isCommentLoader.set(!1)})}ngOnDestroy(){o("PagePathComponent.OnDestroy()"),this.ensureUnregisterWathing(),this.destroy$.next()}async tryRedirect(e,t){return o(`redirecting ${e} -> ${t}`),!!await this.router.navigateByUrl(t,{replaceUrl:!0})}startWatching(e,t){this.ensureUnregisterWathing();let r=this.getPagePath(e),n=this.reloader.registerWatcher(r,t.updated);this.reloadId=n,this.refreshSubscription=this.reloader.refreshEvent(n).subscribe(()=>{this.eventForceUpdate$.next()})}onPageLoaded(){this.loadPageBody.emit()}drawPageBody(e,t){o(`PagePathComponent.drawPageBody() drawing page at published at ${t.published}.`);let r=t.virtualPath||e.baseResource,n={html:t.html,styles:t.styles,resource:r};this.doc.set(n)}ensureUnregisterWathing(){this.reloadId&&(this.reloader.unregister(this.reloadId),delete this.reloadId),this.refreshSubscription&&this.refreshSubscription.unsubscribe()}matchToPathList(e,t){for(let r of t){let n;if(r.endsWith("/")?(n=r,r=r.substring(0,-1)):n=`${r}/`,e.startsWith(n)||e===r)return!0}return!1}pathMatch(e,t,r=[]){return!(!this.matchToPathList(e,t)||this.matchToPathList(e,r))}urlSubscription=null;maybeRedisplayComments(e){this.currentPath!==e&&(this.maybeClearComments(),this.showComment.set(!1),this.isCommentLoader.set(!1),this.urlSubscription&&(this.urlSubscription.unsubscribe(),this.urlSubscription=null),this.urlSubscription=this.router.currentUrl$.pipe(p(this.destroy$)).subscribe(t=>{this.pathMatch(t,this.includesComment,this.excludesComment)&&this.showComment.set(!0)}))}maybeClearComments(){let e=this.gitfireCommentLoader();return e?(e.element.nativeElement.innerHTML="",e.clear(),e):null}onClickLoadComment(e){o("PagePathComponent.onClickLoadComment()"),this.eventPage$.pipe(p(this.destroy$),H(1)).subscribe(async([t,r])=>{o("PagePathComponent.onClickLoadComment() -> this.eventPage$",t,r),this.isCommentLoader.set(!0);let{GitfireModule:n}=await import("./chunk-QUM5ZKYZ.js"),{CommentEntryComponent:i}=await import("./chunk-23XCIYUP.js"),a=this.maybeClearComments();if(!a)throw new Error("No loader node is detected");let v=this.loader.appendComponentRef(a,n,i);v.setInput("pagePath",t),v.setInput("pageJson",r)})}static \u0275fac=function(t){return new(t||s)(h(C),h(y),h(le),h(se),h(pe))};static \u0275cmp=q({type:s,selectors:[["app-page-path"]],viewQuery:function(t,r){t&1&&Y(r.gitfireCommentLoader,Pe,5,L),t&2&&Z()},inputs:{pagePath:[1,"pagePath"]},outputs:{loadError:"loadError",fatalError:"fatalError",loadPageJson:"loadPageJson",loadPageBody:"loadPageBody"},decls:3,vars:4,consts:[["gitfireCommentLoader",""],[3,"pageLoaded","doc"],[1,"text-center","m-4"],["type","button","aria-expanded","true","aria-label","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059","title","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059",1,"btn","btn-primary",3,"click"],["src","/assets/octicons/comment.svg",1,"m-1"]],template:function(t,r){t&1&&(_(0,"app-safe-doc",1),x("pageLoaded",function(){return r.onPageLoaded()}),R(),$(1,ye,2,1),te(2,"async")),t&2&&(K("doc",r.doc()),Q(),I(re(2,2,r.localSession.loginStateChanged$)?1:-1))},dependencies:[ce,ae],encapsulation:2})};export{y as a,he as b};
