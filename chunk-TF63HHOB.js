import{a as $t}from"./chunk-KTJ3Z4AG.js";import{a as ee,b as Z,c as ne}from"./chunk-RCE4YYU5.js";import{a as Tt,e as Ht}from"./chunk-CVXX5FR7.js";import{b as O,c as W}from"./chunk-5YUGNV6C.js";import{a as Jt,b as Kt,c as Zt,d as Xt,e as Yt,f as te,g as ct}from"./chunk-A7HDYDRL.js";import{a as at,b as st,c as K,d as ut,e as A,f as zt,g as Gt,j as Qt}from"./chunk-ZW3ZHQKI.js";import{b as J}from"./chunk-UJRLRELD.js";import{a as R}from"./chunk-TIMAWLUM.js";import{$ as Et,$a as Dt,Ab as z,Ba as c,Bb as G,Cb as At,Eb as d,Gb as T,Ha as E,Ka as $,Ob as Q,Oc as M,P as N,Pa as k,Pb as wt,Qc as C,R as vt,Tc as D,Va as l,Wa as b,Wc as kt,Xa as m,Xb as F,Xc as Bt,Yb as I,Yc as Lt,Zb as B,Zc as Rt,_a as yt,_b as Pt,_c as Mt,a as gt,ab as g,ad as Ot,b as ht,bb as u,ca as xt,cb as r,db as x,fa as _,ga as f,gd as Wt,hd as Vt,ia as Ft,ic as ot,jb as H,la as it,m as nt,ma as It,mb as v,na as q,nd as Ut,o as P,pb as h,pd as Nt,qd as qt,ra as j,rb as a,rc as St,sc as L,sd as jt,tc as bt,ya as S,z as U}from"./chunk-7VISKNRN.js";import{R as rt}from"./chunk-LZXNU2FR.js";import{a as _t,d as ft}from"./chunk-VB56BUGO.js";var yn="auth";var X=class{constructor(){return K(yn)}};var Y=function(){return Y=Object.assign||function(n){for(var t,i=1,o=arguments.length;i<o;i++){t=arguments[i];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},Y.apply(this,arguments)};var wn={includeMetadataChanges:!1};function lt(e,n){return n===void 0&&(n=wn),new gt(function(t){var i=ct(e,n,{next:t.next.bind(t),error:t.error.bind(t),complete:t.complete.bind(t)});return{unsubscribe:i}})}function ie(e){return lt(e,{includeMetadataChanges:!0})}function oe(e,n){return n===void 0&&(n={}),ie(e).pipe(P(function(t){return mt(t,n)}))}function mt(e,n){var t;n===void 0&&(n={});var i=e.data(n);return!e.exists()||typeof i!="object"||i===null||!n.idField?i:Y(Y({},i),(t={},t[n.idField]=e.id,t))}function re(e){return lt(e,{includeMetadataChanges:!0}).pipe(P(function(n){return n.docs}))}function ae(e,n){return n===void 0&&(n={}),re(e).pipe(P(function(t){return t.map(function(i){return mt(i,n)})}))}var w=class{constructor(n){return n}},se="firestore",dt=class{constructor(){return K(se)}};var pt=new Et("angularfire2.firestore-instances");function Pn(e,n){let t=st(se,e,n);return t&&new w(t)}function Sn(e){return(n,t)=>{let i=n.runOutsideAngular(()=>e(t));return new w(i)}}var bn={provide:dt,deps:[[new j,pt]]},Tn={provide:w,useFactory:Pn,deps:[[new j,pt],zt]};function da(e,...n){return rt("angularfire",at.full,"fst"),xt([Tn,bn,{provide:pt,useFactory:Sn(e),multi:!0,deps:[It,Ft,ut,Gt,[new j,X],[new j,Qt],...n]}])}var ue=A(ae,!0);var ce=A(oe,!0);var le=A(Jt,!0,2);var tt=A(Kt,!0,2);var pa=A(Zt,!0);var me=A(te,!0,2);var de=A(Yt,!0,2),pe=A(Xt,!0,2);function kn(e,n){if(e&1){let t=v();u(0,"div",0)(1,"button",8),h("click",function(){_(t);let o=a();return f(o.onClickDismiss())}),u(2,"span",9),d(3,"\xD7"),r()()()}}function Bn(e,n){e&1&&(u(0,"div",6),d(1,"OK!"),r())}function Ln(e,n){e&1&&(u(0,"div",10),d(1,"\u5165\u529B\u5FC5\u9808\u3067\u3059\u3002"),r())}function Rn(e,n){e&1&&(u(0,"div",10),d(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),r())}function Mn(e,n){e&1&&(u(0,"div",10),d(1,"\u77ED\u3059\u304E\u307E\u3059\u3002"),r())}function On(e,n){if(e&1&&(l(0,Ln,2,0,"div",10),l(1,Rn,2,0,"div",10),l(2,Mn,2,0,"div",10)),e&2){let t=a();m(t.textareaControl.errors!=null&&t.textareaControl.errors.required?0:-1),c(),m(t.textareaControl.errors!=null&&t.textareaControl.errors.maxlength?1:-1),c(),m(t.textareaControl.errors!=null&&t.textareaControl.errors.minlength?2:-1)}}var V=class e{constructor(n,t,i,o,s){this.user=n;this.auth=t;this.toastr=i;this.funcs=o;this.tos=s}editModel;pageId;showDismiss=!1;replyId;requestSent=new it;editDismiss=new it;inputForm;get textareaControl(){return this.inputForm.get("commentText")}ngOnInit(){C("CommentEditorComponent.OnInit()"),this.inputForm=new Mt({}),this.inputForm.addControl("commentText",new Ot(this.editModel?this.editModel.message:null,[Bt.required]))}onClickDismiss(){C("CommentEditorComponent.onClickDismiss()"),this.editDismiss.emit()}async doNewPost(){let n={message:this.textareaControl.value,pageId:this.pageId,replyId:this.replyId};return await this.funcs.call("postComment",n)}async doUpdatePost(n){let t={pageId:this.pageId,commentId:n.id,message:this.textareaControl.value};return await this.funcs.call("editComment",t)}onClickPostComment(){C("CommentEditorComponent.onClickPostComment()"),!this.inputForm.invalid&&(this.textareaControl.invalid||this.tos.confirmTos$(`${this.auth.myUid}/commentAgreement`,M.CommentServiceTosUrl).pipe(U(n=>n)).subscribe(async n=>{this.inputForm.disable();try{this.editModel?await this.doUpdatePost(this.editModel):await this.doNewPost(),this.toastr.info("\u6295\u7A3F\u3057\u307E\u3057\u305F\u3002(\u627F\u8A8D\u3055\u308C\u308B\u307E\u3067\u4ED6\u306E\u4EBA\u306B\u306F\u8868\u793A\u3055\u308C\u307E\u305B\u3093\u3002)"),this.textareaControl.setValue(""),this.inputForm.markAsPristine(),this.inputForm.markAsUntouched(),this.requestSent.emit()}catch(t){if("message"in t){let i=t.message;this.toastr.error(`\u6295\u7A3F\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002( ${i} )`)}else this.toastr.error("\u6295\u7A3F\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002")}finally{this.inputForm.enable()}}))}static \u0275fac=function(t){return new(t||e)(E(Z),E(W),E(R),E(O),E(ee))};static \u0275cmp=$({type:e,selectors:[["gitfire-comment-editor"]],inputs:{editModel:"editModel",pageId:"pageId",showDismiss:"showDismiss",replyId:"replyId"},outputs:{requestSent:"requestSent",editDismiss:"editDismiss"},decls:16,vars:14,consts:[[1,"text-end"],[1,"input-group",3,"formGroup"],["title","\u3053\u306E\u540D\u524D\u3067\u6295\u7A3F\u306F\u8868\u793A\u3055\u308C\u307E\u3059\u3002","src","/assets/octicons/question.svg",1,"m-1","octicon-info","help-icon"],["disabled","",1,"m-3",3,"value"],[1,"m-3"],["autofocus","","name","commentText","formControlName","commentText","placeholder","\u6295\u7A3F\u3059\u308B\u30B3\u30E1\u30F3\u30C8\u3092\u3053\u3053\u306B\u66F8\u3044\u3066\u304F\u3060\u3055\u3044\u3002","required","","minlength","5","maxlength","65536",1,"p-3","form-control"],[1,"valid-feedback"],["title","\u30B3\u30E1\u30F3\u30C8\u5185\u5BB9\u306F\u627F\u8A8D\u5F8C\u306B\u8868\u793A\u3055\u308C\u307E\u3059\u3002",1,"btn","btn-primary","m-2",3,"click","disabled"],["type","button","aria-label","Close",1,"btn-close",3,"click"],["aria-hidden","true"],[1,"invalid-feedback"]],template:function(t,i){t&1&&(l(0,kn,4,0,"div",0),u(1,"div",1)(2,"div")(3,"label"),d(4,"\u540D\u524D"),x(5,"img",2),d(6,": "),r(),x(7,"input",3),F(8,"async"),r(),u(9,"div",4),x(10,"textarea",5),l(11,Bn,2,0,"div",6)(12,On,3,3),r(),u(13,"div")(14,"button",7),h("click",function(){return i.onClickPostComment()}),d(15,"\u6295\u7A3F\u3059\u308B"),r()()()),t&2&&(m(i.showDismiss?0:-1),c(),At("was-validated",i.textareaControl.dirty||i.textareaControl.touched),g("formGroup",i.inputForm),c(6),g("value",Q(I(8,12,i.user.myNickname$()))),c(2),G("width",100,"%"),c(),G("height",8,"rem"),c(),m(i.textareaControl.invalid?12:11),c(3),g("disabled",i.textareaControl.invalid||i.inputForm.disabled))},dependencies:[jt,kt,Lt,Rt,Ut,Nt,qt,Vt,Wt,L],encapsulation:2})};var Wn=(e,n)=>n.store.id;function Vn(e,n){e&1&&x(0,"span",1)}function Un(e,n){if(e&1&&(u(0,"span",6)(1,"small",5),F(2,"date"),d(3),F(4,"date"),r()()),e&2){let t=a().$implicit;c(),g("title",Q(B(2,3,t.updatedAt,"yyyy-MM-dd HH:mm"))),c(2),T("\u66F4\u65B0\u65E5: ",B(4,6,t.updatedAt,"yyyy-MM-dd"))}}function Nn(e,n){if(e&1&&(u(0,"span",6)(1,"small"),d(2),F(3,"date"),r()()),e&2){let t=a().$implicit;c(2),T("\u627F\u8A8D\u65E5: ",B(3,1,t.decisionAt,"yyyy-MM-dd"))}}function qn(e,n){if(e&1){let t=v();u(0,"a",27),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickApprove(o,s))}),d(1,"\u627F\u8A8D"),r()}}function jn(e,n){if(e&1){let t=v();u(0,"a",28),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickApprove(o,s))}),d(1,"\u7DE8\u96C6\u627F\u8A8D"),r()}}function Hn(e,n){if(e&1){let t=v();u(0,"a",29),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickApprove(o,s))}),d(1,"\u524A\u9664\u627F\u8A8D"),r()}}function zn(e,n){if(e&1){let t=v();u(0,"a",30),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickReject(o,s))}),d(1,"\u62D2\u5426"),r()}}function Gn(e,n){if(e&1){let t=v();u(0,"a",31),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickReject(o,s))}),d(1,"\u7DE8\u96C6\u62D2\u5426"),r()}}function Qn(e,n){if(e&1){let t=v();u(0,"a",32),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickReject(o,s))}),d(1,"\u7DE8\u96C6\u62D2\u5426"),r()}}function Jn(e,n){if(e&1){let t=v();u(0,"a",33),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickProtect(o,s))}),d(1,"\u4FDD\u8B77"),r()}}function Kn(e,n){if(e&1){let t=v();u(0,"a",34),h("click",function(o){_(t);let s=a(2).$implicit,p=a(2);return f(p.onClickUnProtect(o,s))}),d(1,"\u4FDD\u8B77\u89E3\u9664"),r()}}function Zn(e,n){if(e&1&&(u(0,"span",7)(1,"span",17),d(2,"\uFE19"),r(),u(3,"div",18),l(4,qn,2,0,"a",19),l(5,jn,2,0,"a",20),l(6,Hn,2,0,"a",21),l(7,zn,2,0,"a",22),l(8,Gn,2,0,"a",23),l(9,Qn,2,0,"a",24),l(10,Jn,2,0,"a",25),l(11,Kn,2,0,"a",26),r()()),e&2){let t=a().$implicit;c(4),m(t.store.state==="pending"?4:-1),c(),m(t.store.state==="approved"&&t.store.editedState==="edit-request"?5:-1),c(),m(t.store.state==="approved"&&t.store.editedState==="delete-request"?6:-1),c(),m(t.store.state==="pending"?7:-1),c(),m(t.store.state==="approved"&&t.store.editedState==="edit-request"?8:-1),c(),m(t.store.state==="approved"&&t.store.editedState==="delete-request"?9:-1),c(),m(t.store.state==="approved"&&!t.store.isAdminEdit?10:-1),c(),m(t.store.state==="approved"&&t.store.isAdminEdit?11:-1)}}function Xn(e,n){e&1&&x(0,"gitfire-user-box",9),e&2&&g("userPublic",n)}function Yn(e,n){e&1&&(u(0,"span",11),d(1,"\u7BA1\u7406\u4EBA\u306B\u3088\u308B\u4FDD\u8B77"),r())}function ti(e,n){e&1&&(u(0,"span",12),d(1,"\u5374\u4E0B\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3067\u3059\u3002"),r())}function ei(e,n){e&1&&(u(0,"span",13),d(1,"\u627F\u8A8D\u5F85\u3061\u306E\u30B3\u30E1\u30F3\u30C8\u3067\u3059\u3002"),r())}function ni(e,n){e&1&&(u(0,"span",13),d(1,"\u524A\u9664\u3055\u308C\u307E\u3057\u305F\u3002"),r())}function ii(e,n){e&1&&(u(0,"span",12),d(1,"\u7DE8\u96C6\u7533\u8ACB\u304C\u5374\u4E0B\u3055\u308C\u307E\u3057\u305F\u3002"),r())}function oi(e,n){e&1&&(u(0,"span",12),d(1,"\u524A\u9664\u7533\u8ACB\u304C\u5374\u4E0B\u3055\u308C\u307E\u3057\u305F\u3002"),r())}function ri(e,n){e&1&&(u(0,"span",12),d(1,"\u524A\u9664\u7533\u8ACB\u4E2D\u3067\u3059\u3002"),r())}function ai(e,n){e&1&&(u(0,"span",13),d(1,"\u7DE8\u96C6\u7533\u8ACB\u4E2D\u3067\u3059\u3002"),r())}function si(e,n){if(e&1&&l(0,ii,2,0,"span",12)(1,oi,2,0,"span",12)(2,ri,2,0,"span",12)(3,ai,2,0,"span",13),e&2){let t,i=a().$implicit;m((t=i.store.editedState)==="edit-rejected"?0:t==="delete-rejected"?1:t==="delete-request"?2:t==="edit-request"?3:-1)}}function ui(e,n){if(e&1){let t=v();u(0,"gitfire-comment-editor",37),h("requestSent",function(){_(t);let o=a(3).$implicit,s=a(2);return f(s.onEditRequested(o))})("editDismiss",function(){_(t);let o=a(3).$implicit,s=a(2);return f(s.onEditDismissed(o))}),r()}if(e&2){let t=a(5);g("pageId",t.pageId())("editModel",n)("showDismiss",!0)}}function ci(e,n){if(e&1&&(l(0,ui,1,3,"gitfire-comment-editor",36),F(1,"async")),e&2){let t,i=a(2).$implicit;m((t=I(1,1,i.editor$))?0:-1,t)}}function li(e,n){if(e&1&&x(0,"div",35),e&2){let t=a(2).$implicit;g("innerHTML",t.store.messageHtml,S)}}function mi(e,n){if(e&1&&(u(0,"div"),l(1,ci,2,3),l(2,li,1,1,"div",35),r()),e&2){let t=a().$implicit;c(),m(t.isEditing?1:-1),c(),m(t.store.state==="approved"&&!t.isEditing?2:-1)}}function di(e,n){if(e&1&&x(0,"div",35),e&2){let t=a(2).$implicit;g("innerHTML",t.store.messageHtml,S)}}function pi(e,n){if(e&1&&l(0,di,1,1,"div",35),e&2){let t=a().$implicit;m(t.store.state==="approved"?0:-1)}}function Ci(e,n){e&1&&x(0,"span",1)}function _i(e,n){e&1&&x(0,"div",40),e&2&&g("innerHTML",n.messageHtml,S)}function fi(e,n){e&1&&H(0)}function gi(e,n){if(e&1&&k(0,fi,1,0,"ng-container",41),e&2){a(2);let t=z(2);g("ngTemplateOutlet",t)}}function hi(e,n){if(e&1&&(u(0,"div",38)(1,"span",13),d(2,"\u7533\u8ACB\u4E2D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),l(3,_i,1,1,"div",40),F(4,"async"),b(5,gi,1,1,"ng-container"),r()),e&2){let t,i=a(2).$implicit;c(3),m((t=I(4,1,i.privateMessage$))?3:5,t)}}function vi(e,n){e&1&&x(0,"div",40),e&2&&g("innerHTML",n.messageHtml,S)}function Ei(e,n){e&1&&H(0)}function xi(e,n){if(e&1&&k(0,Ei,1,0,"ng-container",41),e&2){a(2);let t=z(2);g("ngTemplateOutlet",t)}}function Fi(e,n){if(e&1&&(u(0,"div",39)(1,"span",12),d(2,"\u5374\u4E0B\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),l(3,vi,1,1,"div",40),F(4,"async"),b(5,xi,1,1,"ng-container"),r()),e&2){let t,i=a(2).$implicit;c(3),m((t=I(4,1,i.privateMessage$))?3:5,t)}}function Ii(e,n){e&1&&x(0,"div",40),e&2&&g("innerHTML",n.messageHtml,S)}function yi(e,n){e&1&&H(0)}function Di(e,n){if(e&1&&k(0,yi,1,0,"ng-container",41),e&2){a(3);let t=z(2);g("ngTemplateOutlet",t)}}function Ai(e,n){if(e&1&&(u(0,"div",38)(1,"span",13),d(2,"\u7DE8\u96C6\u7533\u8ACB\u4E2D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),l(3,Ii,1,1,"div",40),F(4,"async"),b(5,Di,1,1,"ng-container"),r()),e&2){let t,i=a(3).$implicit;c(3),m((t=I(4,1,i.privateMessage$))?3:5,t)}}function wi(e,n){e&1&&x(0,"div",40),e&2&&g("innerHTML",n.messageHtml,S)}function Pi(e,n){e&1&&H(0)}function Si(e,n){if(e&1&&k(0,Pi,1,0,"ng-container",41),e&2){a(3);let t=z(2);g("ngTemplateOutlet",t)}}function bi(e,n){if(e&1&&(u(0,"div",39)(1,"span",12),d(2,"\u7DE8\u96C6\u7533\u8ACB\u304C\u5374\u4E0B\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8"),r(),l(3,wi,1,1,"div",40),F(4,"async"),b(5,Si,1,1,"ng-container"),r()),e&2){let t,i=a(3).$implicit;c(3),m((t=I(4,1,i.privateMessage$))?3:5,t)}}function Ti(e,n){if(e&1&&(u(0,"div"),l(1,Ai,6,3,"div",38),l(2,bi,6,3,"div",39),r()),e&2){let t=a(2).$implicit;c(),m(t.store.editedState==="edit-request"?1:-1),c(),m(t.store.editedState==="edit-rejected"?2:-1)}}function $i(e,n){if(e&1&&(u(0,"div",14),k(1,Ci,1,0,"ng-template",null,0,Pt),l(3,hi,6,3,"div",38),l(4,Fi,6,3,"div",39),l(5,Ti,3,2,"div"),r()),e&2){let t=a().$implicit;c(3),m(t.store.state==="pending"?3:-1),c(),m(t.store.state==="rejected"?4:-1),c(),m(t.store.state==="approved"?5:-1)}}function ki(e,n){if(e&1){let t=v();u(0,"button",42),h("click",function(o){_(t);let s=a().$implicit,p=a(2);return f(p.onClickReply(o,s))}),d(1,"\u8FD4\u4FE1"),r()}}function Bi(e,n){if(e&1){let t=v();u(0,"button",43),h("click",function(o){_(t);let s=a().$implicit,p=a(2);return f(p.onClickDelete(o,s))}),d(1,"\u524A\u9664"),r(),u(2,"button",44),h("click",function(o){_(t);let s=a().$implicit,p=a(2);return f(p.onClickEdit(o,s))}),d(3,"\u7DE8\u96C6"),r()}}function Li(e,n){if(e&1){let t=v();u(0,"div",15)(1,"gitfire-comment-editor",45),h("requestSent",function(){_(t);let o=a().$implicit,s=a(2);return f(s.onReplyRequested(o))})("editDismiss",function(){_(t);let o=a().$implicit,s=a(2);return f(s.onReplyDismissed(o))}),r()()}if(e&2){let t=a().$implicit,i=a(2);c(),g("showDismiss",!0)("replyId",t.store.id)("pageId",i.pageId())}}function Ri(e,n){if(e&1&&(u(0,"div",4)(1,"div")(2,"div")(3,"span",5),F(4,"date"),d(5),F(6,"date"),r(),l(7,Un,5,9,"span",6),l(8,Nn,4,4,"span",6),l(9,Zn,12,8,"span",7),r(),u(10,"div",8),d(11,"\u30E6\u30FC\u30B6: "),l(12,Xn,1,1,"gitfire-user-box",9),F(13,"async"),r()(),u(14,"div",10)(15,"div"),l(16,Yn,2,0,"span",11),l(17,ti,2,0,"span",12)(18,ei,2,0,"span",13)(19,ni,2,0,"span",13)(20,si,4,1),r(),u(21,"div"),l(22,mi,3,2,"div"),l(23,pi,1,1),r(),l(24,$i,6,3,"div",14),r(),u(25,"div",15),l(26,ki,2,0,"button",16),l(27,Bi,4,0),r(),l(28,Li,2,3,"div",15),r()),e&2){let t,i,o=n.$implicit,s=n.$index,p=a(2);G("background",s%2!==0?p.ACCENT_COLOR:null),g("id",wt("appGitfireComment-",o.store.id)),c(3),g("title",Q(B(4,19,o.publishAt,"yyyy-MM-dd HH:mm"))),c(2),T("\u6295\u7A3F\u65E5\u6642: ",B(6,22,o.publishAt,"yyyy-MM-dd HH:mm")),c(2),m(o.isEdited?7:-1),c(),m(o.decisionAt?8:-1),c(),m(o.isDisplayAdmin?9:-1),c(3),m((t=I(13,25,o.user$))?12:-1,t),c(4),m(o.store.isAdminEdit?16:-1),c(),m((i=o.store.state)==="rejected"?17:i==="pending"?18:i==="deleted"?19:i==="approved"?20:-1),c(5),m(o.isOwn?22:-1),c(),m(o.isOwn?-1:23),c(),m(o.isOwn||o.isDisplayAdmin?24:-1),c(2),m(o.canReply?26:-1),c(),m(o.canChange?27:-1),c(),m(o.isReplying?28:-1)}}function Mi(e,n){if(e&1){let t=v();u(0,"button",46),h("click",function(o){_(t);let s=a(2);return f(s.onClickMoreComment(o))}),d(1,"\u3055\u3089\u306B\u8AAD\u307F\u8FBC\u3080"),r()}}function Oi(e,n){if(e&1&&(u(0,"div"),yt(1,Ri,29,27,"div",2,Wn),l(3,Mi,2,0,"button",3),r()),e&2){let t=a();c(),Dt(t.comments()),c(2),m(t.maybeMoreComment?3:-1)}}var Ct=class{store;updatedAt;publishAt;decisionAt;isEdited;privateMessage$;editor$;user$;isEditing;isReplying;isDisplayAdmin;canReply;canChange;isOwn},et=class e{constructor(n,t,i,o,s,p){this.auth=n;this.user=t;this.dialog=i;this.firestore=o;this.funcs=s;this.toastr=p;this.comments$=this.pageId$.pipe(N(y=>{let xe=tt(this.firestore,`comment/v1/page/${y}`),Fe=le(xe,"public").withConverter(this.CommentStoreConverter),Ie=pe(Fe,de("publishAt","desc"),me(30));return ue(Ie,{idField:"id"})}))}ACCENT_COLOR=M.themaColor.EVEN;destroy$=new ht;pageId=ot();pageId$=J(this.pageId);isPageProtect=ot(!1);comments$;comments=q([]);commentData={};maybeMoreComment=!1;isLoading=q(!0);createConverterId(n=[]){return{toFirestore(t){let s=t,{id:i}=s;return ft(s,["id"])},fromFirestore(t,i){let o=t.data(i);return _t({id:t.id},o)}}}CommentStoreConverter=this.createConverterId(["decisionAt","publishAt","updatedAt"]);ngOnDestroy(){C("CommentListComponent.OnDestroy()"),this.destroy$.next()}ngOnInit(){C("CommentListComponent.OnInit()"),this.comments$.pipe(vt(this.destroy$)).subscribe(n=>{let t=this.comments();for(let i of n){let o=this.commentData[i.id];o||(o=new Ct,t.push(o)),o.publishAt=i.publishAt.toDate(),o.updatedAt=i.updatedAt.toDate();let s=o.updatedAt.getTime()-o.publishAt.getTime();if(o.isEdited=i.editedState!=="none"&&Math.abs(s)>5,i.decisionAt&&(o.decisionAt=i.decisionAt.toDate()),o.user$=this.user.user$(i.owner),o.store=i,this.auth.myUid===i.owner||this.auth.isAdmin){if(!o.privateMessage$){let p={pageId:this.pageId(),commentId:i.id};o.privateMessage$=nt(p).pipe(N(y=>this.funcs.call("readPrivateComment",y)),P(y=>y)),o.editor$=o.privateMessage$.pipe(P(y=>({id:y.id,message:y.message,images:y.images})))}}else o.editor$=nt({id:i.id,message:i.message,images:i.images});o.isDisplayAdmin=this.auth.isAdmin,o.isOwn=i.owner===this.auth.myUid,o.canReply=!this.isPageProtect()&&!o.isOwn&&i.state==="approved"&&!i.isProtect,o.canChange=o.isOwn&&!i.isAdminEdit&&!i.isProtect&&i.state==="approved",this.commentData[i.id]=o}this.comments.set(t.sort((i,o)=>o.publishAt.getTime()-i.publishAt.getTime())),this.isLoading.set(!1)})}onClickEdit(n,t){C("CommentListComponent.onClickEdit()"),t.isEditing=!0}async doDeleteRequest(n){let t={pageId:this.pageId(),commentId:n.store.id};try{await this.funcs.call("deleteComment",t),this.toastr.info("\u524A\u9664\u7533\u8ACB\u3057\u307E\u3057\u305F\u3002\u627F\u8A8D\u5F8C\u306B\u524A\u9664\u3055\u308C\u307E\u3059\u3002")}catch(i){D("Error while delete request",i);let o=i instanceof Error?i.message:"Unknown error";this.toastr.error(`\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002 ( ${o} )`)}}async onClickDelete(n,t){C("onClickDelete()",n,t);let i=this.dialog.createHtmlBuilder(),o=new Tt(`
<div>
\u7BA1\u7406\u4EBA\u306B\u627F\u8A8D\u3055\u308C\u305F\u5F8C\u3067\u524A\u9664\u3055\u308C\u307E\u3059\u3002\u3088\u308D\u3057\u3044\u3067\u3059\u304B\uFF1F
</div>
`);i.setMessage(o).setType(1).setSize(1).setTitle("\u78BA\u8A8D").okButton(async()=>{await this.doDeleteRequest(t)}).cancelButton(()=>{}).open()}onClickReply(n,t){C("CommentListComponent.onClickReply()",n,t),t.isReplying=!0}onEditDismissed(n){C("CommentListComponent.onEditDismissed()"),n.isEditing=!1}onEditRequested(n){C("CommentListComponent.onEditRequested()"),n.isEditing=!1}onReplyRequested(n){C("CommentListComponent.onReplyRequested()"),n.isReplying=!1}onReplyDismissed(n){C("CommentListComponent.onReplyDismissed()"),n.isReplying=!1}onClickMoreComment(n){C("CommentListComponent.onClickMoreComment()")}async onClickApprove(n,t){C("CommentListComponent.onClickApprove()");let i={pageId:this.pageId(),commentId:t.store.id};try{await this.funcs.call("approveComment",i),this.toastr.info("\u627F\u8A8D\u3057\u307E\u3057\u305F\u3002")}catch(o){D("Error while approve",o);let s=o instanceof Error?o.message:"Unknown error";this.toastr.error(`\u627F\u8A8D\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${s} )`)}}async onClickReject(n,t){C("CommentListComponent.onClickReject()");let i={pageId:this.pageId(),commentId:t.store.id};try{await this.funcs.call("rejectComment",i),this.toastr.info("\u5374\u4E0B\u3057\u307E\u3057\u305F\u3002")}catch(o){D("Error while reject",o);let s=o instanceof Error?o.message:"Unknown error";this.toastr.error(`\u5374\u4E0B\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${s} )`)}}async onClickProtect(n,t){C("CommentListComponent.onClickProtect()");let i={pageId:this.pageId(),commentId:t.store.id};try{await this.funcs.call("protectComment",i),this.toastr.info("\u4FDD\u8B77\u3057\u307E\u3057\u305F\u3002")}catch(o){D("Error while protect",o);let s=o instanceof Error?o.message:"Unknown error";this.toastr.error(`\u4FDD\u8B77\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${s} )`)}}async onClickUnProtect(n,t){C("CommentListComponent.onClickUnProtect()");let i={pageId:this.pageId(),commentId:t.store.id,unprotect:!0};try{await this.funcs.call("protectComment",i),this.toastr.info("\u4FDD\u8B77\u89E3\u9664\u3057\u307E\u3057\u305F\u3002")}catch(o){D("Error while unprotect",o);let s=o instanceof Error?o.message:"Unknown error";this.toastr.error(`\u4FDD\u8B77\u89E3\u9664\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${s} )`)}}static \u0275fac=function(t){return new(t||e)(E(W),E(Z),E(Ht),E(w),E(O),E(R))};static \u0275cmp=$({type:e,selectors:[["gitfire-comment-list"]],inputs:{pageId:[1,"pageId"],isPageProtect:[1,"isPageProtect"]},outputs:{pageId:"pageIdChange",isPageProtect:"isPageProtectChange"},decls:2,vars:2,consts:[["loadingMessage",""],["role","status",1,"spinner-border","text-primary"],[3,"id","background"],["title","\u53E4\u3044\u6295\u7A3F\u3092\u3055\u3089\u306B\u8AAD\u307F\u8FBC\u307F\u307E\u3059\u3002",1,"btn","btn-primary"],[3,"id"],[3,"title"],[1,"mx-1"],["data-bs-toggle","dropdown",1,"mx-2",2,"position","absolute","right","0px"],[2,"height","2rem"],[3,"userPublic"],[1,"m-1"],[1,"border","border-danger","text-danger","m-1","p-1"],[1,"text-warning"],[1,"text-info"],[1,"p-2"],[1,"m-2"],["title","\u3053\u306E\u30B3\u30E1\u30F3\u30C8\u3078\u8FD4\u4FE1\u3057\u307E\u3059\u3002",1,"btn","btn-primary","m-1"],[1,"gitweeMenuItem"],[1,"dropdown-menu"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem"],["title","\u30B3\u30E1\u30F3\u30C8\u3092\u4FDD\u8B77\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem"],["title","\u30B3\u30E1\u30F3\u30C8\u4FDD\u8B77\u3092\u89E3\u9664\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem",3,"click"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem",3,"click"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u627F\u8A8D\u3057\u307E\u3059\u3002",1,"text-info","dropdown-item","gitweeMenuItem",3,"click"],["title","\u4FDD\u7559\u72B6\u614B\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem",3,"click"],["title","\u7DE8\u96C6\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem",3,"click"],["title","\u524A\u9664\u7533\u8ACB\u3055\u308C\u305F\u30B3\u30E1\u30F3\u30C8\u3092\u62D2\u5426\u3057\u307E\u3059\u3002",1,"text-warning","dropdown-item","gitweeMenuItem",3,"click"],["title","\u30B3\u30E1\u30F3\u30C8\u3092\u4FDD\u8B77\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem",3,"click"],["title","\u30B3\u30E1\u30F3\u30C8\u4FDD\u8B77\u3092\u89E3\u9664\u3057\u307E\u3059\u3002",1,"text-danger","dropdown-item","gitweeMenuItem",3,"click"],[1,"p-2",3,"innerHTML"],[3,"pageId","editModel","showDismiss"],[3,"requestSent","editDismiss","pageId","editModel","showDismiss"],[1,"border","border-info"],[1,"border","border-warning"],[3,"innerHTML"],[4,"ngTemplateOutlet"],["title","\u3053\u306E\u30B3\u30E1\u30F3\u30C8\u3078\u8FD4\u4FE1\u3057\u307E\u3059\u3002",1,"btn","btn-primary","m-1",3,"click"],["title","\u6295\u7A3F\u306E\u524A\u9664\u3092\u7533\u8ACB\u3057\u307E\u3059\u3002",1,"btn","btn-warning","m-1",3,"click"],["title","\u30B3\u30E1\u30F3\u30C8\u3092\u7DE8\u96C6\u3057\u307E\u3059\u3002",1,"btn","btn-secondary","m-1",3,"click"],[3,"requestSent","editDismiss","showDismiss","replyId","pageId"],["title","\u53E4\u3044\u6295\u7A3F\u3092\u3055\u3089\u306B\u8AAD\u307F\u8FBC\u307F\u307E\u3059\u3002",1,"btn","btn-primary",3,"click"]],template:function(t,i){if(t&1&&(l(0,Vn,1,0,"span",1),l(1,Oi,4,1,"div")),t&2){let o;m(i.isLoading()?0:-1),c(),m((o=i.comments())?1:-1,o)}},dependencies:[St,V,ne,L,bt],styles:[".gitweeMenuItem[_ngcontent-%COMP%]{cursor:pointer}"]})};function Wi(e,n){if(e&1){let t=v();u(0,"button",7),h("click",function(){_(t);let o=a(4);return f(o.onClickProtect())}),d(1,"\u30DA\u30FC\u30B8\u3092\u4FDD\u8B77"),r()}}function Vi(e,n){if(e&1){let t=v();u(0,"button",8),h("click",function(){_(t);let o=a(4);return f(o.onClickUnProtect())}),d(1,"\u4FDD\u8B77\u3092\u89E3\u9664"),r()}}function Ui(e,n){if(e&1&&l(0,Wi,2,0,"button",5)(1,Vi,2,0,"button",6),e&2){let t=a();m(t.isProtect?1:0)}}function Ni(e,n){e&1&&(u(0,"span",9)(1,"span",10),d(2,"\u30DA\u30FC\u30B8\u306F\u4FDD\u8B77\u3055\u308C\u3066\u3044\u307E\u3059"),r()())}function qi(e,n){if(e&1&&l(0,Ni,3,0,"span",9),e&2){let t=a();m(t.isProtect?0:-1)}}function ji(e,n){if(e&1){let t=v();u(0,"button",11),h("click",function(o){_(t);let s=a(3);return f(s.onClickWatchPage(o,!0))}),d(1,"Watch(\u30C6\u30B9\u30C8\u4E2D)"),r(),u(2,"button",12),h("click",function(o){_(t);let s=a(3);return f(s.onClickWatchPage(o,!1))}),d(3,"Unwatch(\u30C6\u30B9\u30C8\u4E2D)"),r()}}function Hi(e,n){if(e&1&&(u(0,"span",13),d(1),r()),e&2){let t=a(2);c(),T("(\u4FDD\u7559 ",t.countPending," \u4EF6)")}}function zi(e,n){if(e&1&&(u(0,"div",4)(1,"span"),d(2),r(),l(3,Hi,2,1,"span",13),r()),e&2){let t=a();c(2),T("",t.countAll," \u4EF6\u306E\u30B3\u30E1\u30F3\u30C8"),c(),m(t.countPending>0?3:-1)}}function Gi(e,n){e&1&&(u(0,"div",1),d(1,"\u30B3\u30E1\u30F3\u30C8\u306F\u3042\u308A\u307E\u305B\u3093"),r())}function Qi(e,n){if(e&1&&(u(0,"div")(1,"div",1),l(2,Ui,2,1)(3,qi,1,1),l(4,ji,4,0),r(),l(5,zi,4,2,"div",4)(6,Gi,2,0,"div",1),r()),e&2){let t=a(2);c(2),m(t.auth.isAdmin?2:3),c(2),m(t.auth.hasMessaging?4:-1),c(),m(n.countAll>0?5:6)}}function Ji(e,n){e&1&&(u(0,"div",1),d(1,"\u30B3\u30E1\u30F3\u30C8\u306F\u3042\u308A\u307E\u305B\u3093"),r())}function Ki(e,n){if(e&1&&x(0,"gitfire-comment-editor",2),e&2){let t=a(2);g("pageId",t.pageId())}}function Zi(e,n){if(e&1&&(u(0,"div"),l(1,Qi,7,3,"div"),F(2,"async"),b(3,Ji,2,0,"div",1),u(4,"div"),l(5,Ki,1,1,"gitfire-comment-editor",2),F(6,"async"),x(7,"gitfire-comment-list",3),F(8,"async"),r()()),e&2){let t,i,o,s=a();c(),m((t=I(2,4,s.pageInfo$))?1:3,t),c(4),m((i=I(6,6,s.pageInfo$))!=null&&i.isProtect?-1:5),c(2),g("pageId",s.pageId())("isPageProtect",(o=I(8,8,s.pageInfo$))==null?null:o.isProtect)}}function Xi(e,n){e&1&&x(0,"span",0)}var Ee=class e{constructor(n,t,i,o,s){this.auth=n;this.firestore=t;this.router=i;this.funcs=o;this.toastr=s;this.pageInfo$=this.pageId$.pipe(N(p=>{let y=tt(this.firestore,"comment/v1/page",p);return ce(y.withConverter(this.PageStoreConverter))}))}pagePath;pageJson;pageInfo$;pageId=q(null);pageId$=J(this.pageId).pipe(U(n=>!!n));createConverter(n=[]){return{toFirestore(t){return t},fromFirestore(t,i){return t.data(i)}}}PageStoreConverter=this.createConverter(["lastPostAt","lastUpdatedAt"]);pagePath2PageKey(n){let t=`${M.PAGE_DATA}/`,i=t.length,o=n.jsonPath;if(!o.startsWith(t))throw new Error(`Not a supported path ${o}`);return o.substring(i-1)}buildLeafUrl(){let n=this.pageJson;return n.anchorLink?n.anchorId?`${n.anchorLink}#${n.anchorId}`:n.anchorLink:this.router.url}async ngOnInit(){C("CommentEntryComponent.OnInit()",this.pagePath);let n=this.pageJson?.pageKey||this.pagePath2PageKey(this.pagePath),t=this.buildLeafUrl(),i={pageKey:n,leafUrl:t},o=await this.funcs.call("getPageId",i);this.pageId.set(o),C("getPageId",o,i)}async doProtectPage(n){let t={pageId:this.pageId(),unprotect:n};await this.funcs.call("protectPage",t)}async onClickUnProtect(){C("CommentEntryComponent.onClickUnProtect()");try{this.doProtectPage(!0),this.toastr.info("\u30DA\u30FC\u30B8\u306E\u4FDD\u8B77\u3092\u89E3\u9664\u3057\u307E\u3057\u305F\u3002")}catch(n){D(n);let t=n instanceof Error?n.message:"Unknown error";this.toastr.error(`\u30DA\u30FC\u30B8\u306E\u4FDD\u8B77\u3092\u89E3\u9664\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${t} )`)}}async onClickWatchPage(n,t){C("CommentEntryComponent.onClickWatchPage()");try{let i={pageId:this.pageId(),isWatch:t};await this.funcs.call("watchCommentPage",i),this.toastr.info(t?"\u30DA\u30FC\u30B8\u306E Watch \u3092\u958B\u59CB\u3057\u307E\u3057\u305F\u3002":"\u30DA\u30FC\u30B8\u3092 Watch \u3092\u505C\u6B62\u3057\u307E\u3057\u305F\u3002")}catch(i){D(i);let o=i instanceof Error?i.message:"Unknown error";this.toastr.error(`\u30DA\u30FC\u30B8\u306E Watch \u72B6\u614B\u3092\u5909\u66F4\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${o} )`)}}async onClickProtect(){C("CommentEntryComponent.onClickProtect()");try{this.doProtectPage(!1),this.toastr.info("\u30DA\u30FC\u30B8\u3092\u4FDD\u8B77\u3057\u307E\u3057\u305F\u3002")}catch(n){D(n);let t=n instanceof Error?n.message:"Unknown error";this.toastr.error(`\u30DA\u30FC\u30B8\u3092\u4FDD\u8B77\u72B6\u614B\u306B\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002 ( ${t} )`)}}static \u0275fac=function(t){return new(t||e)(E(W),E(w),E($t),E(O),E(R))};static \u0275cmp=$({type:e,selectors:[["gitfire-comment-entry"]],inputs:{pagePath:"pagePath",pageJson:"pageJson"},decls:3,vars:1,consts:[["role","status",1,"spinner-border","text-primary"],[1,"text-end"],[3,"pageId"],[3,"pageId","isPageProtect"],[1,"m-1","text-end"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u7981\u6B62\u3057\u307E\u3059\u3002",1,"btn","btn-danger","m-1"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u53EF\u80FD\u306B\u3057\u307E\u3059\u3002",1,"btn","btn-info","m-1"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u7981\u6B62\u3057\u307E\u3059\u3002",1,"btn","btn-danger","m-1",3,"click"],["title","\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3092\u53EF\u80FD\u306B\u3057\u307E\u3059\u3002",1,"btn","btn-info","m-1",3,"click"],[1,"p-1","border","border-danger"],[1,"text-danger"],["title","\u3053\u306E\u6A5F\u80FD\u306F\u8A66\u9A13\u904B\u7528\u4E2D\u3067\u3059\u3002\u3053\u306E\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3001\u66F4\u65B0\u3092\u901A\u77E5\u3057\u307E\u3059\u3002",1,"btn","btn-secondary","m-1",3,"click"],["title","\u3053\u306E\u6A5F\u80FD\u306F\u8A66\u9A13\u904B\u7528\u4E2D\u3067\u3059\u3002\u3053\u306E\u30DA\u30FC\u30B8\u3078\u306E\u30B3\u30E1\u30F3\u30C8\u3001\u66F4\u65B0\u901A\u77E5\u3092\u505C\u6B62\u3057\u307E\u3059\u3002",1,"btn","btn-secondary","m-1",3,"click"],[1,"text-warning"]],template:function(t,i){t&1&&(x(0,"hr"),l(1,Zi,9,10,"div")(2,Xi,1,0,"span",0)),t&2&&(c(),m(i.pageId()?1:2))},dependencies:[V,et,L],encapsulation:2})};export{da as a,pa as b,V as c,et as d,Ee as e};
