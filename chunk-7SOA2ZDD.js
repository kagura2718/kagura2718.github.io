import{a as se}from"./chunk-56JACISL.js";import{c as ae}from"./chunk-FHEPK3GS.js";import{a as ne}from"./chunk-CB3UAQLU.js";import{a as C}from"./chunk-2ONXIU7E.js";import{a as oe,b as k}from"./chunk-M5PFS4RI.js";import{a as ce}from"./chunk-NWVWPIRS.js";import{$ as H,$a as q,A as w,Aa as V,C as O,D as F,Db as ee,G as A,Ga as u,Ha as z,Ja as Q,Nc as x,O as p,Oc as m,Pc as o,Q as h,Sc as g,Ua as E,Wa as $,Wb as te,Xb as re,Y as N,ab as L,b as c,bb as _,cb as I,ea as T,fa as G,ka as d,l as S,lb as K,m as f,ma as b,o as l,ob as R,p as U,q as j,qb as D,r as J,rc as ie,tb as X,ub as Y,v as M,vb as Z,w as P,x as W,z as B}from"./chunk-FWGH4434.js";var y=class s{constructor(e){this.http=e;this.startPolling()}watchers={};loaders={};polling;MaxWatcherInterval=400;MinWatcherInterval=200;RefreshInterval=50;eventDrawnSubject=new c;eventClearedSubject=new c;eventAppendSubject=new c;eventUpdatedSubject=new c;gatherWatchers(){let e=[],t=x.PageCheckInterval*1e3,r=Date.now()-t;for(let i in this.watchers){let n=this.watchers[i];n.shouldUpdate||r<=n.lastCheckedTime||n.metaUrlHasError||e.push(n)}return k(e)}invokeWatcher(e){let t=this.fetchJson(e.metaUrl).pipe(O(r=>{throw e.metaUrlHasError=!0,r}));return w(t,f(e))}clampInterval(e){return Math.max(Math.min(e,this.MaxWatcherInterval),this.MinWatcherInterval)}startPolling(){let e=x.PageCheckInterval*1e3;this.polling=P(e).pipe(l(r=>this.gatherWatchers()),p(r=>{let i=this.clampInterval(e/r.length);return o(`Polling delay ${i} for ${r.length} watchers`),w(S(r),P(i))}),p(([r,i])=>this.invokeWatcher(r))).subscribe({next:([r,i])=>{if(i.lastCheckedTime=Date.now(),i.lastUpdatedAt>=r.updated)return;i.shouldUpdate=!0,this.eventUpdatedSubject.next();let n=this.loaders[i.id];n?.updatedEvent&&n.updatedEvent.emit(r)},error:r=>{g("Error while polling. Restarting.",r),this.startPolling()},complete:()=>{g("Never complete the polling")}});let t=P(e).pipe(p(r=>this.http.fetchGhJson("/beacons.json",{addNonce:!0})),j(r=>{let i=[];for(let n in r.beacons){let a=r.beacons[n],v=this.http.fetchGhJson(a.resource,{addNonce:!0}).pipe(l(de=>{for(let pe of de)if(pe.value===a.value)return!0;return!1}));i.push(v)}return U(i).pipe(l(n=>n.every(a=>a)))}))}fetchJson(e){return this.http.fetchGhJson(e).pipe()}gatherRefreshener(){let e=[];for(let t in this.loaders){let r=this.loaders[t];e.push(r)}return k(e)}onClickRefresh(){o("ReloadService.onClickRefresh()");let e=this.gatherRefreshener(),t=this.RefreshInterval;S(e).pipe(l(r=>({loader:r,delay:t})),F(r=>M(r.delay).pipe(l(()=>r.loader)))).subscribe({next:r=>{r.refreshEvent.emit()},complete:()=>{o("ReloadService.onClickRefresh completed()"),this.eventDrawnSubject.next()}})}get eventDrawn(){return this.eventDrawnSubject}get eventCleared(){return this.eventClearedSubject}get eventAppend(){return this.eventAppendSubject}get eventUpdated(){return this.eventUpdatedSubject}findWatcher(e){for(let t in this.watchers)if(this.watchers[t].url===e)return t;return null}generateId(){let e=oe(32);return o(`Generating reloadId: ${e}`),e}ensureLoader(e){let t=this.loaders[e];if(!t)throw new Error(`No loader found for id: ${e}`);return t}appendLoader(e){m(`Creating loader id:${e}`);let t={id:e,refreshEvent:new d};this.loaders[e]=t}registerLoader(){let e=this.generateId();return this.appendLoader(e),this.eventAppendSubject.next(),e}updatedEvent(e){let t=this.ensureLoader(e);return t.updatedEvent||(t.updatedEvent=new d),t.updatedEvent}refreshEvent(e){return this.ensureLoader(e).refreshEvent}registerWatcher(e,t,r){let i=this.findWatcher(e),n;return i?(n=this.watchers[i],n.lastUpdatedAt=t,n.lastCheckedTime=Date.now(),i):(i=this.generateId(),m(`Creating watcher id:${i}`),n={id:i,url:e,metaUrl:r||e,lastUpdatedAt:t,lastCheckedTime:Date.now(),shouldUpdate:!1},this.watchers[i]=n,this.appendLoader(i),this.eventAppendSubject.next(),i)}unregister(e){e in this.watchers&&(m(`Purging watcher id:${e}`),delete this.watchers[e]),e in this.loaders&&(m(`Purging loader id:${e}`),delete this.loaders[e]),Object.keys(this.watchers).length===0&&Object.keys(this.loaders).length===0&&(m("Watchers and Loaders both are cleared."),this.eventClearedSubject.next())}static \u0275fac=function(t){return new(t||s)(H(C))};static \u0275prov=N({token:s,factory:s.\u0275fac,providedIn:"root"})};var ge=["gitfireCommentLoader"];function ve(s,e){if(s&1){let t=K();L(0,"div",2)(1,"button",3),R("click",function(i){T(t);let n=D(2);return G(n.onClickLoadComment(i))}),I(2,"img",4),ee(3,"\u30B3\u30E1\u30F3\u30C8\u8AAD\u307F\u8FBC\u307F"),_()()}}function fe(s,e){s&1&&I(0,"div",null,0)}function Pe(s,e){if(s&1&&E(0,ve,4,0,"div",2)(1,fe,2,0,"div"),s&2){let t=D();$(t.showComment()&&!t.isCommentLoader()?0:1)}}var le=class s{constructor(e,t,r,i,n){this.http=e;this.reloader=t;this.loader=r;this.router=i;this.localSession=n}pagePath$;loadError=new d;fatalError=new d;loadPageJson=new d;loadPageBody=new d;currentPath=null;eventForceUpdate$=new c;reloadId;refreshSubscription;destroy$=new c;eventPage$;isCommentLoader=b(!1);showComment=b(!1);gitfireCommentLoader;includesComment=["/Gitwee","/Diary/","/Cheater/Gitwee"];excludesComment=[];doc=b(null);getPagePath(e){return`${e.jsonPath}.json`}getPageMetaPath(e){return`${e.jsonPath}.json`}fetchJson(e){return this.http.fetchGhJson(this.getPagePath(e)).pipe(l(t=>[e,t]))}ngOnInit(){o("PagePathComponent.OnInit()");let e=new c;this.eventPage$=J(f(null),this.eventForceUpdate$).pipe(p(n=>this.pagePath$),p(n=>this.fetchJson(n)));let t=this.eventPage$.pipe(B(([n,a])=>!a.redirectPath)),r=new c;this.eventPage$.pipe(h(this.destroy$)).subscribe(async([n,a])=>{a.redirectPath&&await this.tryRedirect(n.jsonPath,a.redirectPath)||r.next([n,a])}),W(t,r).pipe(h(this.destroy$)).subscribe({next:async([n,a])=>{o("eventPage$.subscribe",n,a),this.maybeRedisplayComments(n),this.currentPath=n,this.drawPageBody(n,a),this.startWatching(n,a),this.loadPageJson.emit(a)},error:n=>{g(n),this.fatalError.emit(n)},complete:()=>{o("Successfully completed PagePathComponent")}}),e.pipe(h(this.destroy$)).subscribe(n=>this.loadError.emit(n)),this.localSession.markedLogout$.pipe(h(this.destroy$)).subscribe(()=>{this.isCommentLoader.set(!1)})}async tryRedirect(e,t){return o(`redirecting ${e} -> ${t}`),!!await this.router.navigateByUrl(t,{replaceUrl:!0})}startWatching(e,t){this.ensureUnregisterWathing();let r=this.getPagePath(e),i=this.reloader.registerWatcher(r,t.updated);this.reloadId=i,this.refreshSubscription=this.reloader.refreshEvent(i).subscribe(()=>{this.eventForceUpdate$.next()})}onPageLoaded(){this.loadPageBody.emit()}drawPageBody(e,t){o(`PagePathComponent.drawPageBody() drawing page at published at ${t.published}.`);let r=t.virtualPath||e.baseResource,i={html:t.html,styles:t.styles,resource:r};this.doc.set(i)}ensureUnregisterWathing(){this.reloadId&&(this.reloader.unregister(this.reloadId),delete this.reloadId),this.refreshSubscription&&this.refreshSubscription.unsubscribe()}matchToPathList(e,t){for(let r of t){let i;if(r.endsWith("/")?(i=r,r=r.substring(0,-1)):i=`${r}/`,e.startsWith(i)||e===r)return!0}return!1}pathMatch(e,t,r=[]){return!(!this.matchToPathList(e,t)||this.matchToPathList(e,r))}urlSubscription=null;maybeRedisplayComments(e){this.currentPath!==e&&(this.maybeClearComments(),this.showComment.set(!1),this.isCommentLoader.set(!1),this.urlSubscription&&(this.urlSubscription.unsubscribe(),this.urlSubscription=null),this.urlSubscription=this.router.currentUrl$.pipe(h(this.destroy$)).subscribe(t=>{this.pathMatch(t,this.includesComment,this.excludesComment)&&this.showComment.set(!0)}))}maybeClearComments(e){let t=e||this.gitfireCommentLoader;t&&(t.element.nativeElement.innerHTML="",t.clear())}onClickLoadComment(e){o("CommentEntryComponent.onClickLoadComment()"),this.isCommentLoader.set(!0),this.eventPage$.pipe(h(this.destroy$),A(1)).subscribe(async([t,r])=>{o("CommentEntryComponent.onClickLoadComment() -> this.eventPage$",t,r);let{GitfireModule:i}=await import("./chunk-CILX6UXI.js"),{CommentEntryComponent:n}=await import("./chunk-ZOPDCVCI.js"),a=this.gitfireCommentLoader;this.maybeClearComments(a);let v=this.loader.appendComponent(a,i,n);v.pagePath=t,v.pageJson=r})}ngOnDestroy(){o("PagePathComponent.OnDestroy()"),this.ensureUnregisterWathing(),this.destroy$.next()}static \u0275fac=function(t){return new(t||s)(u(C),u(y),u(se),u(ne),u(ce))};static \u0275cmp=Q({type:s,selectors:[["app-page-path"]],viewQuery:function(t,r){if(t&1&&X(ge,5,z),t&2){let i;Y(i=Z())&&(r.gitfireCommentLoader=i.first)}},inputs:{pagePath$:"pagePath$"},outputs:{loadError:"loadError",fatalError:"fatalError",loadPageJson:"loadPageJson",loadPageBody:"loadPageBody"},decls:3,vars:4,consts:[["gitfireCommentLoader",""],[3,"pageLoaded","doc"],[1,"text-center","m-4"],["type","button","aria-expanded","true","aria-label","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059","title","\u30B3\u30E1\u30F3\u30C8\u3092\u8AAD\u307F\u8FBC\u307F\u307E\u3059",1,"btn","btn-primary",3,"click"],["src","/assets/octicons/comment.svg",1,"m-1"]],template:function(t,r){t&1&&(L(0,"app-safe-doc",1),R("pageLoaded",function(){return r.onPageLoaded()}),_(),E(1,Pe,2,1),te(2,"async")),t&2&&(q("doc",r.doc()),V(),$(re(2,2,r.localSession.loginStateChanged$)?1:-1))},dependencies:[ae,ie],encapsulation:2})};export{y as a,le as b};
