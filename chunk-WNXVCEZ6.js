import{a as qe}from"./chunk-KEFGVOK7.js";import{a as Pe,n as me,o as se,p as Ge}from"./chunk-7O2CK3KP.js";import{a as Qe}from"./chunk-3O3IBVE7.js";import"./chunk-5WRTKHPQ.js";import{e as je}from"./chunk-LCE4662W.js";import{b as ae,c as Le}from"./chunk-OUNM32MQ.js";import{j as Ue,k as We}from"./chunk-BZ4MA5FE.js";import"./chunk-S6XJAOVL.js";import"./chunk-M5PFS4RI.js";import"./chunk-QQD6XY2M.js";import"./chunk-AN6OQJXE.js";import{a as Te,c as re}from"./chunk-UM24SFZX.js";import"./chunk-BLXDMDDD.js";import"./chunk-4ORJKYY4.js";import{a as Y}from"./chunk-3QI2BE5Z.js";import{$a as Ie,$c as $e,A as ge,Ab as w,Ba as c,Cb as M,Eb as l,Fb as we,Fc as De,G as Re,Gb as ke,Ha as p,Ib as O,Ic as Me,Jb as V,Jc as Fe,Ka as D,Kb as j,La as z,Nc as de,Oc as Z,P as $,Qc as _,R as g,Tc as Ne,Va as f,Wa as Ee,Wc as ee,Xa as h,Xb as U,Yb as P,Yc as te,Z as ye,Zc as Be,_ as G,_a as Se,aa as S,ab as C,b,ba as _e,bb as s,bd as oe,c as he,cb as m,cd as Ae,da as xe,db as E,ea as A,fa as u,ga as d,ic as W,l as q,la as Q,m as ue,mb as I,na as k,nd as ie,o as Ce,pb as R,pd as Oe,qd as ne,rb as y,rd as F,sc as X,sd as Ve,ub as H,vb as K,wb as J,ya as be,z as ve}from"./chunk-YBLQCMPS.js";import"./chunk-KEDNFY7G.js";import"./chunk-EU2KAMEK.js";import"./chunk-LZXNU2FR.js";import"./chunk-VB56BUGO.js";var x=class i{constructor(e,t,o,n,a,r){this.tos=e;this.auth=t;this.store=o;this.firestore=n;this.funcs=a;this.user=r;this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}env=_e(xe);room;roomIndex;destroy$=new b;ngOnDestroy(){_("ChatService.OnDestroy()"),this.destroy$.next()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,Z.ChatServiceTosUrl)}readChitchat$(e){return A(this.env,()=>this.room.doc(e).collection("chitchat",t=>t.orderBy("createdAt","desc").limit(30)))}postComment$(e,t){let o={roomId:e,text:t};return q(this.funcs.call("postChat",o))}deleteRoom$(e){if(!e)throw new Error("roomId is not supplied");let t=this.room.doc(e);return q(this.store.firestore.runTransaction(async o=>{await A(this.env,async()=>{let r=(await o.get(t.ref)).data().nick,v=this.roomIndex.doc(r);await o.delete(t.ref),await o.delete(v.ref)})}))}ensureRoom$(e){if(!e)throw new Error("room nick is not supplied");return q(this.store.firestore.runTransaction(async t=>await A(this.env,async()=>{let o=this.roomIndex.doc(e),n=await t.get(o.ref);if(n.exists){let fe=n.data();return{id:fe.value,nick:e,isOwned:fe.owner===this.auth.myUid,isExisting:!0}}let a=this.room.ref.doc(),r={nick:e,owner:this.auth.myUid,createdAt:Ue()};await t.set(a,r);let v={value:a.id,owner:this.auth.myUid};return await t.set(o.ref,v),{id:a.id,nick:e,isExisting:!1,isOwned:!0}})))}maybeRoomInfo$(e){return A(this.env,()=>this.roomIndex.doc(e).get().pipe(Ce(o=>{let n={nick:e,isExisting:!!o.exists};if(!o.exists)return n;let a=o.data();return n.isOwned=a.owner===this.auth.myUid,n.id=a.value,n})))}static \u0275fac=function(t){return new(t||i)(S(me),S(Le),S(We),S(Pe),S(ae),S(se))};static \u0275prov=ye({token:i,factory:i.\u0275fac,providedIn:"root"})};var Xe=["inputRoomForm"];function Ye(i,e){i&1&&(s(0,"div",13),l(1,"\u90E8\u5C4B\u306E\u540D\u524D(\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0)\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),m())}function Ze(i,e){i&1&&(s(0,"div",13),l(1,"\u77ED\u3059\u304E\u307E\u3059\u3002"),m())}function et(i,e){i&1&&(s(0,"div",13),l(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),m())}function tt(i,e){if(i&1&&(f(0,Ye,2,0,"div",13),f(1,Ze,2,0,"div",13),f(2,et,2,0,"div",13)),i&2){y();let t=w(23);h(t.errors!=null&&t.errors.required?0:-1),c(),h(t.errors!=null&&t.errors.minlength?1:-1),c(),h(t.errors!=null&&t.errors.maxlength?2:-1)}}var N=class i{constructor(e,t){this.chat=e;this.toastr=t}roomSelected=new Q;initialRoomNick;inputRoomForm;roomNick=W();nickname=W();destroy$=new b;ngOnInit(){this.roomNick.set(this.initialRoomNick),this.chat.user.myNickname$().pipe(g(this.destroy$)).subscribe(e=>{this.nickname.set(e)})}ngOnDestroy(){this.destroy$.next()}onEnterRoom(e){if(!this.inputRoomForm.valid)return;let t=this.roomNick();this.chat.confirmTos$().pipe(ve(o=>o),$(o=>this.chat.ensureRoom$(t)),g(this.destroy$)).subscribe(o=>{_(`Creating room id: ${o.id} with ${o.nick}`),this.roomNick.set(""),o.isExisting?this.toastr.info(`chat \u30EB\u30FC\u30E0 "${t}" \u306B\u5165\u5BA4\u3057\u307E\u3059\u3002`):this.toastr.info(`\u65B0\u3057\u3044 chat \u30EB\u30FC\u30E0 "${t}" \u3092\u4F5C\u308A\u307E\u3057\u305F\u3002`),this.roomSelected.emit(o)})}static \u0275fac=function(t){return new(t||i)(p(x),p(Y))};static \u0275cmp=D({type:i,selectors:[["gitfire-chat-entrance"]],viewQuery:function(t,o){if(t&1&&H(Xe,5),t&2){let n;K(n=J())&&(o.inputRoomForm=n.first)}},inputs:{initialRoomNick:"initialRoomNick",roomNick:[1,"roomNick"],nickname:[1,"nickname"]},outputs:{roomSelected:"roomSelected",roomNick:"roomNickChange",nickname:"nicknameChange"},decls:27,vars:9,consts:[["chatConfigureForm","ngForm"],["nickNameBox","ngModel"],["inputRoomForm","ngForm"],["roomBox","ngModel"],["routerLink","/Gitfire/settings"],[1,""],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4F8B: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModelChange","ngModel","disabled"],["title","\u5165\u5BA4\u3059\u308B\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u540D\u524D\u3067\u3059\u3002\u5B58\u5728\u3057\u306A\u3044\u540D\u524D\u306E\u5834\u5408\u306F\u65B0\u3057\u3044\u90E8\u5C4B\u304C\u4F5C\u3089\u308C\u307E\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"click","disabled"],[1,"invalid-feedback"]],template:function(t,o){if(t&1){let n=I();s(0,"div")(1,"p"),l(2,"Chat \u3067\u4F7F\u3046\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3067\u3059\u3002"),s(3,"a",4),l(4,"[\u8A2D\u5B9A]"),m(),l(5,"\u304B\u3089\u5909\u66F4\u3067\u304D\u307E\u3059\u3002"),m(),s(6,"form",5,0)(8,"div",6)(9,"label",7),l(10,"\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0"),m(),s(11,"input",8,1),j("ngModelChange",function(r){return u(n),V(o.nickname,r)||(o.nickname=r),d(r)}),m()()()(),s(13,"div")(14,"h2"),l(15,"Chat Room \u306E\u540D\u524D"),E(16,"img",9),m(),s(17,"form",null,2)(19,"div",6)(20,"label",10),l(21,"Room"),m(),s(22,"input",11,3),j("ngModelChange",function(r){return u(n),V(o.roomNick,r)||(o.roomNick=r),d(r)}),m(),s(24,"button",12),R("click",function(r){return u(n),d(o.onEnterRoom(r))}),l(25,"\u5165\u5BA4"),m(),f(26,tt,3,3),m()()()}if(t&2){let n=w(12),a=w(18),r=w(23);c(8),M("was-validated",n.dirty||n.touched),c(3),O("ngModel",o.nickname),C("disabled",!0),c(8),M("was-validated",r.dirty||r.touched),c(3),O("ngModel",o.roomNick),c(2),C("disabled",!a.valid),c(2),h(r.invalid?26:-1)}},dependencies:[F,Ae,ee,te,Be,ie,Oe,ne,oe,$e,Ve,Fe],encapsulation:2})};var ce=class{constructor(e,t,o,n,a,r){this.id=e;this.text=t;this.admin=o;this.html=n;this.createdAt=a;this.user$=r}};var ot=["chatBox"],it=(i,e)=>e.id;function nt(i,e){i&1&&E(0,"div",7)}function rt(i,e){i&1&&E(0,"gitfire-user-box",11),i&2&&C("userPublic",e)}function at(i,e){if(i&1&&E(0,"div",12),i&2){let t=y().$implicit;C("innerHTML",t.html,be)}}function mt(i,e){if(i&1&&(s(0,"div",13),l(1),m()),i&2){let t=y().$implicit;c(),we(t.text)}}function st(i,e){if(i&1&&(s(0,"div",1)(1,"div",9),l(2),U(3,"relativeTime"),m(),s(4,"div",10),f(5,rt,1,1,"gitfire-user-box",11),U(6,"async"),m(),f(7,at,1,1,"div",12)(8,mt,2,1,"div",13),m()),i&2){let t,o=e.$implicit;M("bg-info",o.admin)("text-white",o.admin)("text-muted",!o.admin),c(2),ke("",P(3,9,o.createdAt)," "),c(3),h((t=P(6,11,o.user$))?5:-1,t),c(2),h(o.html?7:8)}}var T=class i{constructor(e,t,o){this.chat=e;this.dialog=t;this.toastr=o}destroy$=new b;roomInfo=W();exitRoom=new Q;message="";chatBox;chitchat=k([]);chitchatMap={};ngOnInit(){this.chat.readChitchat$(this.roomInfo().id).valueChanges({idField:"id"}).pipe(g(this.destroy$)).subscribe(t=>{_("Receive ChitChat",t);let o=this.chitchat();for(let n of t){let a=n.id,r=this.chitchatMap[a],v=n;r||(r=new ce(a,v.text,!!v.admin,v.html,v.createdAt?v.createdAt.toDate():new Date,this.chat.user.user$(v.uid)),o.push(r),this.chitchatMap[a]=r)}this.chitchat.set(o.sort((n,a)=>this.descDate(n.createdAt,a.createdAt)))})}descDate(e,t){return e===t?0:e<t?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo().id).pipe(g(this.destroy$)).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524A\u9664\u3057\u307E\u3057\u305F\u3002")})}onClickDeleteRoom(e){this.dialog.createSimpleBuilder().setType(1).setSize(1).setTitle("\u78BA\u8A8D").setMessage("\u672C\u5F53\u306B\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(e){this.exitRoom.emit()}onPostComment(e){this.chatBox.invalid||this.chat.postComment$(this.roomInfo().id,this.message).pipe(g(this.destroy$)).subscribe(t=>{let o=this.chatBox.control;o.setValue(""),o.markAsPristine()},t=>{Ne("Error while post chat",t);let o=t instanceof Error?t.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307E\u3057\u305F\u3002 ( ${o} )`)})}static \u0275fac=function(t){return new(t||i)(p(x),p(je),p(Y))};static \u0275cmp=D({type:i,selectors:[["gitfire-chat-room"]],viewQuery:function(t,o){if(t&1&&H(ot,5),t&2){let n;K(n=J())&&(o.chatBox=n.first)}},inputs:{roomInfo:[1,"roomInfo"]},outputs:{roomInfo:"roomInfoChange",exitRoom:"exitRoom"},decls:13,vars:7,consts:[["chatBox","ngModel"],[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"click","disabled","title"],["title","\u5165\u53E3\u306B\u623B\u308A\u307E\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModelChange","keyup.enter","ngModel"],[1,"col-3","btn","btn-primary",3,"click","disabled"],[1,"valid-feedback"],[1,"row","m-3",3,"bg-info","text-white","text-muted"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(t,o){if(t&1){let n=I();s(0,"div",1)(1,"button",2),R("click",function(r){return u(n),d(o.onClickDeleteRoom(r))}),l(2,"\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u524A\u9664"),m(),s(3,"button",3),R("click",function(r){return u(n),d(o.onClickExitRoom(r))}),l(4,"\u9000\u5BA4"),m()(),s(5,"div",4)(6,"input",5,0),j("ngModelChange",function(r){return u(n),V(o.message,r)||(o.message=r),d(r)}),R("keyup.enter",function(r){return u(n),d(o.onPostComment(r))}),m(),s(8,"button",6),R("click",function(r){return u(n),d(o.onPostComment(r))}),l(9,"\u9001\u4FE1"),m(),f(10,nt,1,0,"div",7),m(),Se(11,st,9,13,"div",8,it)}if(t&2){let n=w(7);c(),C("disabled",!o.roomInfo().isOwned)("title",o.roomInfo().isOwned?"":"\u30EB\u30FC\u30E0\u3092\u958B\u8A2D\u3057\u305F\u4EBA\u3060\u3051\u304C\u524A\u9664\u3067\u304D\u307E\u3059\u3002"),c(4),M("was-validated",n.dirty||n.touched),c(),O("ngModel",o.message),c(2),C("disabled",!n.valid),c(2),h(n.valid?10:-1),c(),Ie(o.chitchat())}},dependencies:[F,ee,te,ie,ne,oe,re,Ge,X,Qe],encapsulation:2})};function ct(i,e){i&1&&E(0,"span",0)}function lt(i,e){if(i&1){let t=I();s(0,"gitfire-chat-entrance",3),R("roomSelected",function(n){u(t);let a=y();return d(a.onRoomSelected(n))}),m()}if(i&2){let t=y();C("initialRoomNick",t.roomNick())}}function ut(i,e){if(i&1){let t=I();s(0,"gitfire-chat-room",4),R("exitRoom",function(){u(t);let n=y();return d(n.onExitedRoom())}),m()}if(i&2){let t=y();C("roomInfo",t.existRoomInfo())}}var B=class i{constructor(e,t,o){this.chat=e;this.router=t;this.route=o}destroy$=new b;state$=new he("loading");existRoomInfo=k(null);roomInfo=k(null);roomNick=k(null);ensureTos$=new b;ngOnInit(){this.route.fragment.pipe(Re(1),$(e=>this.maybeRoomInfo$(e)),g(this.destroy$)).subscribe(e=>{if(!e||!e.id){this.state$.next("entrance"),e&&e.nick&&this.roomNick.set(e.nick);return}this.ensureTos$.next(e)}),this.ensureTos$.pipe($(e=>ge(ue(e),this.chat.confirmTos$())),g(this.destroy$)).subscribe(([e,t])=>{t?(this.state$.next("room"),this.setRoomInfo(e)):(this.state$.next("entrance"),this.roomNick.set(e.nick))})}ngOnDestroy(){_("ChatComponent.OnDestroy()"),this.destroy$.next()}onRoomSelected(e){_("onRoomSelected()",e),this.state$.next("room"),this.setRoomInfo(e),this.router.navigate(["/Gitfire/chat"],{fragment:e.nick})}onExitedRoom(){_("onExitedRoom()"),this.state$.next("entrance"),this.setRoomInfo(null),this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(e){return e==null||e.length<4||10<=e.length?ue(null):this.chat.maybeRoomInfo$(e)}get isAdActive(){return!!Z.production}setRoomInfo(e){if(!e){this.roomInfo.set(null);return}this.roomInfo.set(e),e.id?this.existRoomInfo.set(e):this.existRoomInfo.set(null)}static \u0275fac=function(t){return new(t||i)(p(x),p(Me),p(De))};static \u0275cmp=D({type:i,selectors:[["ng-component"]],decls:5,vars:3,consts:[["role","status",1,"spinner-border","text-primary"],[3,"initialRoomNick"],[3,"roomInfo"],[3,"roomSelected","initialRoomNick"],[3,"exitRoom","roomInfo"]],template:function(t,o){if(t&1&&(f(0,ct,1,0,"span",0),U(1,"async"),Ee(2,lt,1,1,"gitfire-chat-entrance",1)(3,ut,1,1,"gitfire-chat-room",2),E(4,"app-ad-fragment")),t&2){let n;h((n=P(1,1,o.state$))==="loading"?0:n==="entrance"?2:n==="room"?3:-1)}},dependencies:[N,T,Te,X],encapsulation:2})};var dt=[{path:"",component:B}],le=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=z({type:i});static \u0275inj=G({imports:[de.forChild(dt),de]})};var He=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=z({type:i});static \u0275inj=G({providers:[se,x,ae,me],imports:[F,re,le,qe,T,N,B]})};export{He as GitfireChatModule};
