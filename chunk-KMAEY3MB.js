import{a as Ge}from"./chunk-ZCNZH7N4.js";import{a as ze}from"./chunk-PVDFZURY.js";import{a as Le,n as se,o as ce,p as Qe}from"./chunk-PF44J4XZ.js";import"./chunk-CEGM4YDP.js";import{e as Pe}from"./chunk-PPKZ6WBG.js";import{d as me,e as qe}from"./chunk-CMOT2GVO.js";import{j as Ue,k as We}from"./chunk-UXGQAVKW.js";import"./chunk-DG46H57O.js";import"./chunk-M5PFS4RI.js";import"./chunk-GWNSOZ2S.js";import{a as Be,c as ae}from"./chunk-IDYZAMJ5.js";import"./chunk-XQP67AG3.js";import"./chunk-ZF5UGXRX.js";import{a as Z}from"./chunk-XA4BGICE.js";import{$a as we,$c as Ae,A as Re,Ab as k,Ba as c,Cb as F,Eb as l,Fb as ke,Fc as Me,G as ye,Gb as De,Ha as p,Ib as V,Ic as Fe,Jb as j,Jc as Ne,Ka as M,Kb as P,La as H,Nc as pe,Oc as ee,P as A,Qc as y,R as v,Tc as Te,Va as f,Wa as Se,Wc as te,Xa as h,Xb as U,Yb as L,Yc as oe,Z as _e,Zc as $e,_ as Q,_a as Ie,aa as I,ab as C,b as x,ba as xe,bb as s,bd as ie,c as Ce,cb as m,cd as Oe,da as be,db as b,ea as O,fa as u,ga as d,ic as W,l as G,la as z,m as de,mb as w,na as D,nd as ne,o as ve,pb as g,pd as Ve,qd as re,rb as R,rd as N,sc as Y,sd as je,ub as K,vb as J,wb as X,ya as Ee,z as ge}from"./chunk-NPI22PXE.js";import"./chunk-KEDNFY7G.js";import"./chunk-EU2KAMEK.js";import"./chunk-LZXNU2FR.js";import"./chunk-VB56BUGO.js";var _=class i{constructor(e,t,o,n,a,r){this.tos=e;this.auth=t;this.store=o;this.firestore=n;this.funcs=a;this.user=r;this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}env=xe(be);room;roomIndex;destroy$=new x;ngOnDestroy(){y("ChatService.OnDestroy()"),this.destroy$.next()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,ee.ChatServiceTosUrl)}readChitchat$(e){return O(this.env,()=>this.room.doc(e).collection("chitchat",t=>t.orderBy("createdAt","desc").limit(30)))}postComment$(e,t){let o={roomId:e,text:t};return G(this.funcs.call("postChat",o))}deleteRoom$(e){if(!e)throw new Error("roomId is not supplied");let t=this.room.doc(e);return G(this.store.firestore.runTransaction(async o=>{await O(this.env,async()=>{let r=(await o.get(t.ref)).data().nick,E=this.roomIndex.doc(r);await o.delete(t.ref),await o.delete(E.ref)})}))}ensureRoom$(e){if(!e)throw new Error("room nick is not supplied");return G(this.store.firestore.runTransaction(async t=>await O(this.env,async()=>{let o=this.roomIndex.doc(e),n=await t.get(o.ref);if(n.exists){let he=n.data();return{id:he.value,nick:e,isOwned:he.owner===this.auth.myUid,isExisting:!0}}let a=this.room.ref.doc(),r={nick:e,owner:this.auth.myUid,createdAt:Ue()};await t.set(a,r);let E={value:a.id,owner:this.auth.myUid};return await t.set(o.ref,E),{id:a.id,nick:e,isExisting:!1,isOwned:!0}})))}maybeRoomInfo$(e){return O(this.env,()=>this.roomIndex.doc(e).get().pipe(ve(o=>{let n={nick:e,isExisting:!!o.exists};if(!o.exists)return n;let a=o.data();return n.isOwned=a.owner===this.auth.myUid,n.id=a.value,n})))}static \u0275fac=function(t){return new(t||i)(I(se),I(qe),I(We),I(Le),I(me),I(ce))};static \u0275prov=_e({token:i,factory:i.\u0275fac,providedIn:"root"})};var Ye=["inputRoomForm"];function Ze(i,e){i&1&&(s(0,"div",13),l(1,"\u90E8\u5C4B\u306E\u540D\u524D(\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0)\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),m())}function et(i,e){i&1&&(s(0,"div",13),l(1,"\u77ED\u3059\u304E\u307E\u3059\u3002"),m())}function tt(i,e){i&1&&(s(0,"div",13),l(1,"\u9577\u3059\u304E\u307E\u3059\u3002"),m())}function ot(i,e){if(i&1&&(f(0,Ze,2,0,"div",13),f(1,et,2,0,"div",13),f(2,tt,2,0,"div",13)),i&2){R();let t=k(23);h(t.errors!=null&&t.errors.required?0:-1),c(),h(t.errors!=null&&t.errors.minlength?1:-1),c(),h(t.errors!=null&&t.errors.maxlength?2:-1)}}var T=class i{constructor(e,t){this.chat=e;this.toastr=t}roomSelected=new z;initialRoomNick;inputRoomForm;roomNick=W();nickname=W();destroy$=new x;ngOnInit(){this.roomNick.set(this.initialRoomNick),this.chat.user.myNickname$().pipe(v(this.destroy$)).subscribe(e=>{this.nickname.set(e)})}ngOnDestroy(){this.destroy$.next()}onEnterRoom(e){if(!this.inputRoomForm.valid)return;let t=this.roomNick();this.chat.confirmTos$().pipe(ge(o=>o),A(o=>this.chat.ensureRoom$(t)),v(this.destroy$)).subscribe(o=>{y(`Creating room id: ${o.id} with ${o.nick}`),this.roomNick.set(""),o.isExisting?this.toastr.info(`chat \u30EB\u30FC\u30E0 "${t}" \u306B\u5165\u5BA4\u3057\u307E\u3059\u3002`):this.toastr.info(`\u65B0\u3057\u3044 chat \u30EB\u30FC\u30E0 "${t}" \u3092\u4F5C\u308A\u307E\u3057\u305F\u3002`),this.roomSelected.emit(o)})}static \u0275fac=function(t){return new(t||i)(p(_),p(Z))};static \u0275cmp=M({type:i,selectors:[["gitfire-chat-entrance"]],viewQuery:function(t,o){if(t&1&&K(Ye,5),t&2){let n;J(n=X())&&(o.inputRoomForm=n.first)}},inputs:{initialRoomNick:"initialRoomNick",roomNick:[1,"roomNick"],nickname:[1,"nickname"]},outputs:{roomSelected:"roomSelected",roomNick:"roomNickChange",nickname:"nicknameChange"},decls:27,vars:9,consts:[["chatConfigureForm","ngForm"],["nickNameBox","ngModel"],["inputRoomForm","ngForm"],["roomBox","ngModel"],["routerLink","/Gitfire/settings"],[1,""],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4F8B: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModelChange","ngModel","disabled"],["title","\u5165\u5BA4\u3059\u308B\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u540D\u524D\u3067\u3059\u3002\u5B58\u5728\u3057\u306A\u3044\u540D\u524D\u306E\u5834\u5408\u306F\u65B0\u3057\u3044\u90E8\u5C4B\u304C\u4F5C\u3089\u308C\u307E\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-primary",3,"click","disabled"],[1,"invalid-feedback"]],template:function(t,o){if(t&1){let n=w();s(0,"div")(1,"p"),l(2,"Chat \u3067\u4F7F\u3046\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3067\u3059\u3002"),s(3,"a",4),l(4,"[\u8A2D\u5B9A]"),m(),l(5,"\u304B\u3089\u5909\u66F4\u3067\u304D\u307E\u3059\u3002"),m(),s(6,"form",5,0)(8,"div",6)(9,"label",7),l(10,"\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0"),m(),s(11,"input",8,1),P("ngModelChange",function(r){return u(n),j(o.nickname,r)||(o.nickname=r),d(r)}),m()()()(),s(13,"div")(14,"h2"),l(15,"Chat Room \u306E\u540D\u524D"),b(16,"img",9),m(),s(17,"form",null,2)(19,"div",6)(20,"label",10),l(21,"Room"),m(),s(22,"input",11,3),P("ngModelChange",function(r){return u(n),j(o.roomNick,r)||(o.roomNick=r),d(r)}),m(),s(24,"button",12),g("click",function(r){return u(n),d(o.onEnterRoom(r))}),l(25,"\u5165\u5BA4"),m(),f(26,ot,3,3),m()()()}if(t&2){let n=k(12),a=k(18),r=k(23);c(8),F("was-validated",n.dirty||n.touched),c(3),V("ngModel",o.nickname),C("disabled",!0),c(8),F("was-validated",r.dirty||r.touched),c(3),V("ngModel",o.roomNick),c(2),C("disabled",!a.valid),c(2),h(r.invalid?26:-1)}},dependencies:[N,Oe,te,oe,$e,ne,Ve,re,ie,Ae,je,Ne],encapsulation:2})};var le=class{constructor(e,t,o,n,a,r){this.id=e;this.text=t;this.admin=o;this.html=n;this.createdAt=a;this.user$=r}};var it=["chatBox"],nt=(i,e)=>e.id;function rt(i,e){i&1&&b(0,"div",7)}function at(i,e){i&1&&b(0,"gitfire-user-box",11),i&2&&C("userPublic",e)}function mt(i,e){if(i&1&&b(0,"div",12),i&2){let t=R().$implicit;C("innerHTML",t.html,Ee)}}function st(i,e){if(i&1&&(s(0,"div",13),l(1),m()),i&2){let t=R().$implicit;c(),ke(t.text)}}function ct(i,e){if(i&1&&(s(0,"div",1)(1,"div",9),l(2),U(3,"relativeTime"),m(),s(4,"div",10),f(5,at,1,1,"gitfire-user-box",11),U(6,"async"),m(),f(7,mt,1,1,"div",12)(8,st,2,1,"div",13),m()),i&2){let t,o=e.$implicit;F("bg-info",o.admin)("text-white",o.admin)("text-muted",!o.admin),c(2),De("",L(3,9,o.createdAt)," "),c(3),h((t=L(6,11,o.user$))?5:-1,t),c(2),h(o.html?7:8)}}var B=class i{constructor(e,t,o){this.chat=e;this.dialog=t;this.toastr=o}destroy$=new x;roomInfo=W();exitRoom=new z;message="";chatBox;chitchat=D([]);chitchatMap={};ngOnInit(){this.chat.readChitchat$(this.roomInfo().id).valueChanges({idField:"id"}).pipe(v(this.destroy$)).subscribe(t=>{y("Receive ChitChat",t);let o=this.chitchat();for(let a of t){let r=a.id,E=this.chitchatMap[r],S=a;E||(E=new le(r,S.text,!!S.admin,S.html,S.createdAt?S.createdAt.toDate():new Date,this.chat.user.user$(S.uid)),o.push(E),this.chitchatMap[r]=E)}let n=[...o].sort((a,r)=>this.descDate(a.createdAt,r.createdAt));this.chitchat.set(n)})}descDate(e,t){return e===t?0:e<t?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo().id).pipe(v(this.destroy$)).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524A\u9664\u3057\u307E\u3057\u305F\u3002")})}onClickDeleteRoom(e){this.dialog.createSimpleBuilder().setType(1).setSize(1).setTitle("\u78BA\u8A8D").setMessage("\u672C\u5F53\u306B\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(e){this.exitRoom.emit()}onPostComment(e){this.chatBox.invalid||this.chat.postComment$(this.roomInfo().id,this.message).pipe(v(this.destroy$)).subscribe(t=>{let o=this.chatBox.control;o.setValue(""),o.markAsPristine()},t=>{Te("Error while post chat",t);let o=t instanceof Error?t.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307E\u3057\u305F\u3002 ( ${o} )`)})}static \u0275fac=function(t){return new(t||i)(p(_),p(Pe),p(Z))};static \u0275cmp=M({type:i,selectors:[["gitfire-chat-room"]],viewQuery:function(t,o){if(t&1&&K(it,5),t&2){let n;J(n=X())&&(o.chatBox=n.first)}},inputs:{roomInfo:[1,"roomInfo"]},outputs:{roomInfo:"roomInfoChange",exitRoom:"exitRoom"},decls:13,vars:7,consts:[["chatBox","ngModel"],[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"click","disabled","title"],["title","\u5165\u53E3\u306B\u623B\u308A\u307E\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModelChange","keyup.enter","ngModel"],[1,"col-3","btn","btn-primary",3,"click","disabled"],[1,"valid-feedback"],[1,"row","m-3",3,"bg-info","text-white","text-muted"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(t,o){if(t&1){let n=w();s(0,"div",1)(1,"button",2),g("click",function(r){return u(n),d(o.onClickDeleteRoom(r))}),l(2,"\u30C1\u30E3\u30C3\u30C8\u30EB\u30FC\u30E0\u306E\u524A\u9664"),m(),s(3,"button",3),g("click",function(r){return u(n),d(o.onClickExitRoom(r))}),l(4,"\u9000\u5BA4"),m()(),s(5,"div",4)(6,"input",5,0),P("ngModelChange",function(r){return u(n),j(o.message,r)||(o.message=r),d(r)}),g("keyup.enter",function(r){return u(n),d(o.onPostComment(r))}),m(),s(8,"button",6),g("click",function(r){return u(n),d(o.onPostComment(r))}),l(9,"\u9001\u4FE1"),m(),f(10,rt,1,0,"div",7),m(),Ie(11,ct,9,13,"div",8,nt)}if(t&2){let n=k(7);c(),C("disabled",!o.roomInfo().isOwned)("title",o.roomInfo().isOwned?"":"\u30EB\u30FC\u30E0\u3092\u958B\u8A2D\u3057\u305F\u4EBA\u3060\u3051\u304C\u524A\u9664\u3067\u304D\u307E\u3059\u3002"),c(4),F("was-validated",n.dirty||n.touched),c(),V("ngModel",o.message),c(2),C("disabled",!n.valid),c(2),h(n.valid?10:-1),c(),we(o.chitchat())}},dependencies:[N,te,oe,ne,re,ie,ae,Qe,Y,ze],encapsulation:2})};function lt(i,e){i&1&&b(0,"span",0)}function ut(i,e){if(i&1){let t=w();s(0,"gitfire-chat-entrance",3),g("roomSelected",function(n){u(t);let a=R();return d(a.onRoomSelected(n))}),m()}if(i&2){let t=R();C("initialRoomNick",t.roomNick())}}function dt(i,e){if(i&1){let t=w();s(0,"gitfire-chat-room",4),g("exitRoom",function(){u(t);let n=R();return d(n.onExitedRoom())}),m()}if(i&2){let t=R();C("roomInfo",t.existRoomInfo())}}var $=class i{constructor(e,t,o){this.chat=e;this.router=t;this.route=o}destroy$=new x;state$=new Ce("loading");existRoomInfo=D(null);roomInfo=D(null);roomNick=D(null);ensureTos$=new x;ngOnInit(){this.route.fragment.pipe(ye(1),A(e=>this.maybeRoomInfo$(e)),v(this.destroy$)).subscribe(e=>{if(!e||!e.id){this.state$.next("entrance"),e&&e.nick&&this.roomNick.set(e.nick);return}this.ensureTos$.next(e)}),this.ensureTos$.pipe(A(e=>Re(de(e),this.chat.confirmTos$())),v(this.destroy$)).subscribe(([e,t])=>{t?(this.state$.next("room"),this.setRoomInfo(e)):(this.state$.next("entrance"),this.roomNick.set(e.nick))})}ngOnDestroy(){y("ChatComponent.OnDestroy()"),this.destroy$.next()}onRoomSelected(e){y("onRoomSelected()",e),this.state$.next("room"),this.setRoomInfo(e),this.router.navigate(["/Gitfire/chat"],{fragment:e.nick})}onExitedRoom(){y("onExitedRoom()"),this.state$.next("entrance"),this.setRoomInfo(null),this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(e){return e==null||e.length<4||10<=e.length?de(null):this.chat.maybeRoomInfo$(e)}get isAdActive(){return!!ee.production}setRoomInfo(e){if(!e){this.roomInfo.set(null);return}this.roomInfo.set(e),e.id?this.existRoomInfo.set(e):this.existRoomInfo.set(null)}static \u0275fac=function(t){return new(t||i)(p(_),p(Fe),p(Me))};static \u0275cmp=M({type:i,selectors:[["ng-component"]],decls:5,vars:3,consts:[["role","status",1,"spinner-border","text-primary"],[3,"initialRoomNick"],[3,"roomInfo"],[3,"roomSelected","initialRoomNick"],[3,"exitRoom","roomInfo"]],template:function(t,o){if(t&1&&(f(0,lt,1,0,"span",0),U(1,"async"),Se(2,ut,1,1,"gitfire-chat-entrance",1)(3,dt,1,1,"gitfire-chat-room",2),b(4,"app-ad-fragment")),t&2){let n;h((n=L(1,1,o.state$))==="loading"?0:n==="entrance"?2:n==="room"?3:-1)}},dependencies:[T,B,Be,Y],encapsulation:2})};var pt=[{path:"",component:$}],ue=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=H({type:i});static \u0275inj=Q({imports:[pe.forChild(pt),pe]})};var Ke=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=H({type:i});static \u0275inj=Q({providers:[ce,_,me,se],imports:[N,ae,ue,Ge,B,T,$]})};export{Ke as GitfireChatModule};
