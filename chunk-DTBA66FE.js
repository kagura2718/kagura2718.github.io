import{a as De}from"./chunk-OPEU4PYB.js";import{d as Ee,e as ke}from"./chunk-E3XKS6FU.js";import{c as qe}from"./chunk-5LQQWSVJ.js";import{a as Re,b as Oe,c as We,d as Ne,e as Ue,f as _e,g as Me,h as Le,i as B,j as Be,k as je}from"./chunk-N2QKUVGW.js";import{a as _,b as M,c as E,d as L,e as a,f as Fe,g as we,j as xe}from"./chunk-5WAFVXVX.js";import{$ as re,Ba as l,Cb as he,Eb as u,Fb as ge,G as $,Ka as S,M as ee,Oa as me,Ob as N,P as te,Qc as s,R as C,Tc as T,Va as I,Vc as ve,Xa as A,Yc as Ie,Z as b,Zc as Ae,_c as $e,a as X,aa as p,ab as P,ad as be,b as d,ba as ne,bb as f,ca as oe,cb as h,cd as Se,da as ie,db as y,ea as ae,eb as R,fb as O,gb as pe,gd as Pe,hd as ye,ia as se,ic as Ce,la as ce,m as Y,ma as ue,nb as W,o as m,pb as fe,ra as v,sd as Te,ya as le,za as de}from"./chunk-LR2XCKTF.js";import{R as U}from"./chunk-LZXNU2FR.js";import{a as Z,d as K}from"./chunk-VB56BUGO.js";var nr="auth";var k=class{constructor(){return E(nr)}};var D=function(){return D=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var c in t)Object.prototype.hasOwnProperty.call(t,c)&&(e[c]=t[c])}return e},D.apply(this,arguments)};var ar={includeMetadataChanges:!1};function j(r,e){return e===void 0&&(e=ar),new X(function(t){var n=B(r,e,{next:t.next.bind(t),error:t.error.bind(t),complete:t.complete.bind(t)});return{unsubscribe:n}})}function ze(r){return j(r,{includeMetadataChanges:!0})}function Ve(r,e){return e===void 0&&(e={}),ze(r).pipe(m(function(t){return q(t,e)}))}function q(r,e){var t;e===void 0&&(e={});var n=r.data(e);return!r.exists()||typeof n!="object"||n===null||!e.idField?n:D(D({},n),(t={},t[e.idField]=r.id,t))}function Ge(r){return j(r,{includeMetadataChanges:!0}).pipe(m(function(e){return e.docs}))}function Je(r,e){return e===void 0&&(e={}),Ge(r).pipe(m(function(t){return t.map(function(n){return q(n,e)})}))}var g=class{constructor(e){return e}},He="firestore",z=class{constructor(){return E(He)}};var V=new re("angularfire2.firestore-instances");function sr(r,e){let t=M(He,r,e);return t&&new g(t)}function cr(r){return(e,t)=>{let n=e.runOutsideAngular(()=>r(t));return new g(n)}}var ur={provide:z,deps:[[new v,V]]},lr={provide:g,useFactory:sr,deps:[[new v,V],Fe]};function wo(r,...e){return U("angularfire",_.full,"fst"),oe([lr,ur,{provide:V,useFactory:cr(r),multi:!0,deps:[ue,se,L,we,[new v,k],[new v,xe],...e]}])}var xo=a(Je,!0);var Qe=a(Ve,!0);var Ro=a(Re,!0,2);var Ze=a(Oe,!0,2);var Oo=a(We,!0);var Wo=a(_e,!0,2);var No=a(Ue,!0,2),Uo=a(Ne,!0,2);var Ke=a(Me,!0,2);var _o=a(Le,!0,2);function Lo(r=[]){return{toFirestore(e){let i=e,{id:t}=i;return K(i,["id"])},fromFirestore(e,t){let n=e.data(t);return Z({id:e.id},n)}}}function Xe(r=[]){return{toFirestore(e){return e},fromFirestore(e,t){return e.data(t)}}}var F=class{saveNeverAsk;isConfirmed};function pr(r,e){r&1&&(f(0,"div",1),y(1,"div",11),h()),r&2&&(l(),P("innerHTML",e.html,le))}function fr(r,e){r&1&&y(0,"span",2)}var w=class r extends Ee{confirmed=new ce;inputConfirmForm;tosJson=Ce();constructor(){super()}ngOnInit(){s("TosConfirmComponent.OnInit()"),this.inputConfirmForm=new $e({}),this.inputConfirmForm.addControl("neverConfirmTosCheck",new be(!1))}get neverCheckTosControl(){return this.inputConfirmForm.get("neverConfirmTosCheck")}onClickConfirm(e){if(s("TosConfirmComponent.onClickConfirm()"),e.preventDefault(),this.inputConfirmForm.markAllAsTouched(),this.inputConfirmForm.invalid)return;let t=new F,n=this.inputConfirmForm.get("neverConfirmTosCheck");t.saveNeverAsk=n.value,t.isConfirmed=!0,this.confirmed.emit(t),this.close()}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=S({type:r,selectors:[["gitfire-tos-confirm"]],inputs:{tosJson:[1,"tosJson"]},outputs:{confirmed:"confirmed",tosJson:"tosJsonChange"},features:[me],decls:18,vars:5,consts:[[1,"container"],[1,"m-3"],["role","status",1,"spinner-border","text-primary"],[1,"text-center"],[3,"formGroup"],[1,"m-5","custom-control","custom-checkbox"],["for","appGitfireTosConfirmNeverDismissCheck",1,"visually-hidden"],["id","appGitfireTosConfirmNeverDismissCheck","name","neverConfirmTosCheck","formControlName","neverConfirmTosCheck","type","checkbox",1,"form-check-input"],[1,"text-muted","fw-light"],["href","/terms.htm","about","_blank"],["id","appGitfireTosConfirmButton",1,"btn","btn-success",3,"click","disabled"],[3,"innerHTML"]],template:function(t,n){if(t&1&&(f(0,"div",0),I(1,pr,2,1,"div",1)(2,fr,1,0,"span",2),f(3,"div",3)(4,"form",4)(5,"div",5)(6,"label",6),u(7,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),h(),y(8,"input",7),u(9,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),h(),f(10,"div",8),u(11,"\u8A73\u3057\u304F\u306F"),f(12,"a",9),u(13,"[\u5229\u7528\u898F\u7D04]"),h(),u(14,"\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002 "),h(),f(15,"div",1)(16,"button",10),fe("click",function(c){return n.onClickConfirm(c)}),u(17,"\u78BA\u8A8D\u3057\u307E\u3057\u305F"),h()()()()()),t&2){let i;l(),A((i=n.tosJson())?1:2,i),l(3),P("formGroup",n.inputConfirmForm),l(),he("was-validated",n.neverCheckTosControl.dirty||n.neverCheckTosControl.touched),l(11),P("disabled",!n.inputConfirmForm.valid)}},dependencies:[Te,Se,ve,Ie,Ae,ye,Pe],encapsulation:2})};var Ye=class r{constructor(e,t,n){this.http=e;this.dialog=t;this.firestore=n}UserAgreementConverter=Xe(["createdAt"]);ProtectedUserPrefix="users/v1/protected";destroy$=new d;ngOnDestroy(){s("TosService.OnDestroy()"),this.destroy$.next()}constructSetupTosConfirm(e,t){return n=>{n.tosJson.set(t.json),n.confirmed.pipe(C(this.destroy$)).subscribe(i=>{if(!i.isConfirmed)throw new Error("assert");i.saveNeverAsk?t.answer=2:t.answer=0,e.next(t)})}}confirmTos$(e,t){if(e.match(/\/$/))throw new Error(`Assertion. Not a supported ${e}`);let n=new d,i=new d,c=new d,J=new d,rt=this.http.fetchGhJson(t).pipe($(1),te(o=>{let x=`${this.ProtectedUserPrefix}/${e}/${o.version}`,H=Ze(this.firestore,x).withConverter(this.UserAgreementConverter),Q={json:o,cached:!1,cacheRef:H};return Qe(H).pipe(m(nt=>(nt?.alwaysConfirmed&&(s("TOS has already been confirmed."),Q.cached=!0),Q)))}));return J.pipe(C(this.destroy$)).subscribe({next:o=>{this.dialog.createDefaultBuilder().prepareBody(w).setupChild(this.constructSetupTosConfirm(c,o)).setType(1).setSize(1).setTitle("\u5229\u7528\u898F\u7D04\u306E\u78BA\u8A8D").closeButton(()=>{o.answer=1,c.next(o)}).setFinalize(()=>{o.answer=1,c.next(o)}).open()},complete:()=>{s("completed dialog$")},error:o=>{T("error dialog$",o)}}),rt.pipe($(1),C(this.destroy$)).subscribe({next:o=>{if(o.cached){n.next(!0);return}J.next(o)},complete:()=>{s("Completed TOS reading")},error:o=>{T("Failed reading TOS cache",o)}}),c.pipe($(1),C(this.destroy$)).subscribe({next:async o=>{switch(o.answer){case 0:n.next(!0);break;case 1:n.next(!1);break;case 2:let x={_docClass:"User:UserAgreementStore",alwaysConfirmed:!0,createdAt:Be()};n.next(!0),await Ke(o.cacheRef,x);break;default:throw new Error(`Not a valid answer ${o.answer}`)}},complete:()=>{s("Completed dialog result."),n.complete()},error:o=>{T("Failed receive dialog result"),n.complete()}}),n}static \u0275fac=function(t){return new(t||r)(p(De),p(ke),p(g))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var et=class r{constructor(e,t){this.store=e;this.auth=t;this.pubUser=this.store.collection("/users/v1/public")}destroy$=new d;pubUser;nicknameCache={};userCache={};env=ne(ie);ngOnDestroy(){s("UserService.OnDestroy"),this.destroy$.next()}myNickname$(){return this.auth.myUid?this.nickname$(this.auth.myUid):Y("")}user$(e){let t=this.userCache[e];return t||(t=ae(this.env,()=>this.pubUser.doc(e).valueChanges().pipe(ee(1))),this.userCache[e]=t,t)}nickname$(e){let t=this.nicknameCache[e];return t||(t=this.user$(e).pipe(m(n=>n?n.nickname:null)),this.nicknameCache[e]=t,t)}static \u0275fac=function(t){return new(t||r)(p(je),p(qe))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};function hr(r,e){r&1&&pe(0,"img",2),r&2&&W("src",N(e),de)}function gr(r,e){if(r&1&&(R(0,"span",0),I(1,hr,1,2,"img",2),u(2),O()),r&2){let t,n=e;W("title",N(n.about)),l(),A((t=n.photoURL)?1:-1,t),l(),ge(n.nickname)}}function Cr(r,e){r&1&&(R(0,"span",1),u(1,"[\u524A\u9664]"),O())}var tt=class r{userPublic;constructor(){}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=S({type:r,selectors:[["gitfire-user-box"]],inputs:{userPublic:"userPublic"},decls:2,vars:1,consts:[[1,"p-1",3,"title"],["title","\u524A\u9664\u3055\u308C\u305F\u30E6\u30FC\u30B6\u3067\u3059",1,"text-warning"],[1,"p-1",2,"height","100%","width","2rem",3,"src"]],template:function(t,n){if(t&1&&I(0,gr,3,4,"span",0)(1,Cr,2,0,"span",1),t&2){let i;A((i=n.userPublic)?0:1,i)}},encapsulation:2})};export{g as a,wo as b,xo as c,Qe as d,Ro as e,Ze as f,Oo as g,Wo as h,No as i,Uo as j,_o as k,Lo as l,Xe as m,Ye as n,et as o,tt as p};
