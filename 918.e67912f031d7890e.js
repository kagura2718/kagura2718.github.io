"use strict";(self.webpackChunkKaguraGithubPages=self.webpackChunkKaguraGithubPages||[]).push([[918],{5918:(gt,A,u)=>{u.r(A),u.d(A,{GitfireChatModule:()=>dt});var r=u(1180),m=u(5739),f=u(6814),v=u(2425),E=u(2413),_=u(5861),F=u(7142),x=u(2459),J=u(7398),p=u(553),t=u(5879),I=u(6450),D=u(9782),b=u(5579),k=u(7910);class w{constructor(){(0,r.Z)(this,"id",void 0),(0,r.Z)(this,"nick",void 0),(0,r.Z)(this,"isOwned",!1)}}class M extends w{constructor(s){super(),(0,r.Z)(this,"isExisting",void 0),this.isExisting=s}}let Z=(()=>{var i;class s{constructor(o,e,n,c,h){(0,r.Z)(this,"tos",void 0),(0,r.Z)(this,"auth",void 0),(0,r.Z)(this,"store",void 0),(0,r.Z)(this,"funcs",void 0),(0,r.Z)(this,"user",void 0),(0,r.Z)(this,"room",void 0),(0,r.Z)(this,"roomIndex",void 0),this.tos=o,this.auth=e,this.store=n,this.funcs=c,this.user=h,this.room=this.store.collection("/chat/v1/room"),this.roomIndex=this.store.collection("/index/chat/roomnick")}fieldTimestamp(){return F.Z.firestore.FieldValue.serverTimestamp()}confirmTos$(){return this.tos.confirmTos$(`${this.auth.myUid}/chatAgreement`,p.NZ.ChatServiceTosUrl)}readChitchat$(o){return this.room.doc(o).collection("chitchat",e=>e.orderBy("createdAt","desc").limit(30))}postComment$(o,e){return(0,x.D)(this.funcs.call("postChat",{roomId:o,text:e}))}deleteRoom$(o){var e=this;if(!o)throw new Error("roomId is not supplied");const n=this.room.doc(o);return(0,x.D)(this.store.firestore.runTransaction(function(){var c=(0,_.Z)(function*(h){const d=(yield h.get(n.ref)).data().nick,C=e.roomIndex.doc(d);yield h.delete(n.ref),yield h.delete(C.ref)});return function(h){return c.apply(this,arguments)}}()))}ensureRoom$(o){var e=this;if(!o)throw new Error("room nick is not supplied");const c=this.roomIndex.doc(o);return(0,x.D)(this.store.firestore.runTransaction(function(){var h=(0,_.Z)(function*(l){const T=yield l.get(c.ref),d=new M(!0);if(d.nick=o,T.exists){const B=T.data();return d.id=B.value,d.isOwned=B.owner===e.auth.myUid,d}const C=e.room.ref.doc(),ft={nick:o,owner:e.auth.myUid,createdAt:e.fieldTimestamp()};yield l.set(C,ft);const pt={value:C.id,owner:e.auth.myUid};return yield l.set(c.ref,pt),d.id=C.id,d.isExisting=!1,d.isOwned=!0,d});return function(l){return h.apply(this,arguments)}}()))}maybeRoomInfo$(o){return this.roomIndex.doc(o).get().pipe((0,J.U)(n=>{const c=new M(!!n.exists);if(c.nick=o,!n.exists)return c;const h=n.data();return c.isOwned=h.owner===this.auth.myUid,c.id=h.value,c}))}}return i=s,(0,r.Z)(s,"\u0275fac",function(o){return new(o||i)(t.LFG(I.F),t.LFG(D.e),t.LFG(b.ST),t.LFG(E.c),t.LFG(k.K))}),(0,r.Z)(s,"\u0275prov",t.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"})),s})();var Q=u(1134),g=u(5187),R=u(8645),U=u(5619),S=u(9026),N=u(2096),G=u(8180),y=u(4664),Y=u(9009);class O{constructor(s,a,o,e,n,c){(0,r.Z)(this,"id",void 0),(0,r.Z)(this,"text",void 0),(0,r.Z)(this,"admin",void 0),(0,r.Z)(this,"html",void 0),(0,r.Z)(this,"createdAt",void 0),(0,r.Z)(this,"user$",void 0),this.id=s,this.text=a,this.admin=o,this.html=e,this.createdAt=n,this.user$=c}}var $=u(7319),L=u(103),P=u(3429),j=u(1601);const H=["chatBox"];function K(i,s){1&i&&t._UZ(0,"div",9)}function z(i,s){1&i&&t._UZ(0,"gitfire-user-box",16),2&i&&t.Q6J("userPublic",s.ngIf)}function W(i,s){if(1&i&&t._UZ(0,"div",17),2&i){const a=t.oxw().$implicit;t.Q6J("innerHTML",a.html,t.oJD)}}function X(i,s){if(1&i&&(t.TgZ(0,"div",18),t._uU(1),t.qZA()),2&i){const a=t.oxw().$implicit;t.xp6(1),t.Oqu(a.text)}}function V(i,s){if(1&i&&(t.TgZ(0,"div",10)(1,"div",11),t._uU(2),t.ALo(3,"relativeTime"),t.qZA(),t.TgZ(4,"div",12),t.YNc(5,z,1,1,"gitfire-user-box",13),t.ALo(6,"async"),t.qZA(),t.YNc(7,W,1,1,"div",14),t.YNc(8,X,2,1,"div",15),t.qZA()),2&i){const a=s.$implicit;t.Q6J("ngClass",a.admin?"bg-info text-white":"text-muted"),t.xp6(2),t.hij("",t.lcZ(3,5,a.createdAt)," "),t.xp6(3),t.Q6J("ngIf",t.lcZ(6,7,a.user$)),t.xp6(2),t.Q6J("ngIf",a.html),t.xp6(1),t.Q6J("ngIf",!a.html)}}let q=(()=>{var i;class s{constructor(o,e,n){(0,r.Z)(this,"chat",void 0),(0,r.Z)(this,"dialog",void 0),(0,r.Z)(this,"toastr",void 0),(0,r.Z)(this,"destroy$",new R.x),(0,r.Z)(this,"roomInfo",void 0),(0,r.Z)(this,"exitRoom",new t.vpe),(0,r.Z)(this,"message",""),(0,r.Z)(this,"chatBox",void 0),(0,r.Z)(this,"chitchat",[]),(0,r.Z)(this,"chitchatMap",{}),this.chat=o,this.dialog=e,this.toastr=n}ngOnInit(){this.chat.readChitchat$(this.roomInfo.id).valueChanges({idField:"id"}).subscribe(e=>{(0,p.eM)("Receive ChitChat",e);for(const n of e){const c=n.id;let h=this.chitchatMap[c];const l=n;h||(h=new O(c,l.text,!!l.admin,l.html,l.createdAt?l.createdAt.toDate():new Date,this.chat.user.user$(l.uid)),this.chitchat.push(h),this.chitchatMap[c]=h)}this.chitchat=this.chitchat.sort((n,c)=>this.descDate(n.createdAt,c.createdAt))})}descDate(o,e){return o===e?0:o<e?1:-1}ngOnDestroy(){this.destroy$.next()}doDeleteRoom(){this.chat.deleteRoom$(this.roomInfo.id).subscribe(()=>{this.exitRoom.emit(),this.toastr.info("\u524a\u9664\u3057\u307e\u3057\u305f\u3002")})}onClickDeleteRoom(o){this.dialog.createSimpleBuilder().setType($.iR.Warn).setSize($.PW.Default).setTitle("\u78ba\u8a8d").setMessage("\u672c\u5f53\u306b\u524a\u9664\u3057\u307e\u3059\u304b\uff1f").okButton(()=>{this.doDeleteRoom()}).cancelButton(()=>{}).open()}onClickExitRoom(o){this.exitRoom.emit()}onPostComment(o){this.chatBox.invalid||this.chat.postComment$(this.roomInfo.id,this.message).subscribe(e=>{const n=this.chatBox.control;n.setValue(""),n.markAsPristine()},e=>{(0,p.wb)("Error while post chat",e);const n=e instanceof Error?e.message:"Unknown error";this.toastr.error(`\u5931\u6557\u3057\u307e\u3057\u305f\u3002 ( ${n} )`)})}}return i=s,(0,r.Z)(s,"\u0275fac",function(o){return new(o||i)(t.Y36(Z),t.Y36(L.xA),t.Y36(v._W))}),(0,r.Z)(s,"\u0275cmp",t.Xpm({type:i,selectors:[["gitfire-chat-room"]],viewQuery:function(o,e){if(1&o&&t.Gf(H,5),2&o){let n;t.iGM(n=t.CRH())&&(e.chatBox=n.first)}},inputs:{roomInfo:"roomInfo"},outputs:{exitRoom:"exitRoom"},decls:12,vars:8,consts:[[1,"row","m-3"],["tabindex","-1",1,"col-5","btn","btn-danger",3,"disabled","title","click"],["title","\u5165\u53e3\u306b\u623b\u308a\u307e\u3059\u3002",1,"col-3","btn","btn-secondary",3,"click"],[1,"row","m-3","input-group"],["name","chatText","type","text","required","","maxlength","1024",1,"col-9","form-control",3,"ngModel","ngModelChange","keyup.enter"],["chatBox","ngModel"],[1,"col-3","btn","btn-primary",3,"disabled","click"],["class","valid-feedback",4,"ngIf"],["class","row m-3",3,"ngClass",4,"ngFor","ngForOf"],[1,"valid-feedback"],[1,"row","m-3",3,"ngClass"],[1,"col-2"],[1,"col-2",2,"height","2rem"],[3,"userPublic",4,"ngIf"],["class","col-8",3,"innerHTML",4,"ngIf"],["class","col-8",4,"ngIf"],[3,"userPublic"],[1,"col-8",3,"innerHTML"],[1,"col-8"]],template:function(o,e){if(1&o&&(t.TgZ(0,"div",0)(1,"button",1),t.NdJ("click",function(c){return e.onClickDeleteRoom(c)}),t._uU(2,"\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u524a\u9664"),t.qZA(),t.TgZ(3,"button",2),t.NdJ("click",function(c){return e.onClickExitRoom(c)}),t._uU(4,"\u9000\u5ba4"),t.qZA()(),t.TgZ(5,"div",3)(6,"input",4,5),t.NdJ("ngModelChange",function(c){return e.message=c})("keyup.enter",function(c){return e.onPostComment(c)}),t.qZA(),t.TgZ(8,"button",6),t.NdJ("click",function(c){return e.onPostComment(c)}),t._uU(9,"\u9001\u4fe1"),t.qZA(),t.YNc(10,K,1,0,"div",7),t.qZA(),t.YNc(11,V,9,9,"div",8)),2&o){const n=t.MAs(7);t.xp6(1),t.Q6J("disabled",!e.roomInfo.isOwned)("title",e.roomInfo.isOwned?"":"\u30eb\u30fc\u30e0\u3092\u958b\u8a2d\u3057\u305f\u4eba\u3060\u3051\u304c\u524a\u9664\u3067\u304d\u307e\u3059\u3002"),t.xp6(4),t.ekj("was-validated",n.dirty||n.touched),t.xp6(1),t.Q6J("ngModel",e.message),t.xp6(2),t.Q6J("disabled",!n.valid),t.xp6(2),t.Q6J("ngIf",n.valid),t.xp6(1),t.Q6J("ngForOf",e.chitchat)}},dependencies:[f.mk,f.sg,f.O5,m.Fj,m.JJ,m.Q7,m.nD,m.On,P.a,f.Ov,j.a]})),s})();var tt=u(2181);const ot=["inputRoomForm"];function et(i,s){1&i&&(t.TgZ(0,"div",15),t._uU(1,"\u90e8\u5c4b\u306e\u540d\u524d(\u30cb\u30c3\u30af\u30cd\u30fc\u30e0)\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),t.qZA())}function nt(i,s){1&i&&(t.TgZ(0,"div",15),t._uU(1,"\u77ed\u3059\u304e\u307e\u3059\u3002"),t.qZA())}function it(i,s){1&i&&(t.TgZ(0,"div",15),t._uU(1,"\u9577\u3059\u304e\u307e\u3059\u3002"),t.qZA())}function rt(i,s){if(1&i&&(t.ynx(0),t.YNc(1,et,2,0,"div",14),t.YNc(2,nt,2,0,"div",14),t.YNc(3,it,2,0,"div",14),t.BQk()),2&i){t.oxw();const a=t.MAs(23);t.xp6(1),t.Q6J("ngIf",null==a.errors?null:a.errors.required),t.xp6(1),t.Q6J("ngIf",null==a.errors?null:a.errors.minlength),t.xp6(1),t.Q6J("ngIf",null==a.errors?null:a.errors.maxlength)}}let st=(()=>{var i;class s{constructor(o,e){(0,r.Z)(this,"chat",void 0),(0,r.Z)(this,"toastr",void 0),(0,r.Z)(this,"roomSelected",new t.vpe),(0,r.Z)(this,"initialRoomNick",void 0),(0,r.Z)(this,"inputRoomForm",void 0),(0,r.Z)(this,"roomNick",void 0),(0,r.Z)(this,"nickname",void 0),this.chat=o,this.toastr=e}ngOnInit(){this.roomNick=this.initialRoomNick,this.chat.user.myNickname$().subscribe(o=>{this.nickname=o})}onEnterRoom(o){if(!this.inputRoomForm.valid)return;const e=this.roomNick;this.chat.confirmTos$().pipe((0,tt.h)(n=>n),(0,y.w)(n=>this.chat.ensureRoom$(e))).subscribe(n=>{(0,p.eM)(`Creating room id: ${n.id} with ${n.nick}`),this.roomNick="",this.toastr.info(n.isExisting?`chat \u30eb\u30fc\u30e0 "${e}" \u306b\u5165\u5ba4\u3057\u307e\u3059\u3002`:`\u65b0\u3057\u3044 chat \u30eb\u30fc\u30e0 "${e}" \u3092\u4f5c\u308a\u307e\u3057\u305f\u3002`),this.roomSelected.emit(n)})}}return i=s,(0,r.Z)(s,"\u0275fac",function(o){return new(o||i)(t.Y36(Z),t.Y36(v._W))}),(0,r.Z)(s,"\u0275cmp",t.Xpm({type:i,selectors:[["gitfire-chat-entrance"]],viewQuery:function(o,e){if(1&o&&t.Gf(ot,5),2&o){let n;t.iGM(n=t.CRH())&&(e.inputRoomForm=n.first)}},inputs:{initialRoomNick:"initialRoomNick"},outputs:{roomSelected:"roomSelected"},decls:27,vars:9,consts:[["routerLink","/Gitfire/settings"],[1,""],["chatConfigureForm","ngForm"],[1,"input-group","p-3"],["for","appGitfireChatUserNickanmeInput",1,"visually-hidden"],["id","appGitfireChatUserNickanmeInput","type","text","name","nickname","placeholder","\u4f8b: hogehoge1032","require","","maxlength","19","minlength","4",1,"form-control",3,"ngModel","disabled","ngModelChange"],["nickNameBox","ngModel"],["title","\u5165\u5ba4\u3059\u308b\u30c1\u30e3\u30c3\u30c8\u30eb\u30fc\u30e0\u306e\u540d\u524d\u3067\u3059\u3002\u5b58\u5728\u3057\u306a\u3044\u540d\u524d\u306e\u5834\u5408\u306f\u65b0\u3057\u3044\u90e8\u5c4b\u304c\u4f5c\u3089\u308c\u307e\u3059\u3002","src","/assets/octicons/question.svg",1,"m-3","octicon-info"],["inputRoomForm","ngForm"],["for","appGitfireRoomnickNameInput",1,"visually-hidden"],["id","appGitfireRoomnickNameInput","type","text","name","roomNickname","maxlength","9","minlength","4","required","",1,"form-control",3,"ngModel","ngModelChange"],["roomBox","ngModel"],[1,"btn","btn-primary",3,"disabled","click"],[4,"ngIf"],["class","invalid-feedback",4,"ngIf"],[1,"invalid-feedback"]],template:function(o,e){if(1&o&&(t.TgZ(0,"div")(1,"p"),t._uU(2,"Chat \u3067\u4f7f\u3046\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3067\u3059\u3002"),t.TgZ(3,"a",0),t._uU(4,"[\u8a2d\u5b9a]"),t.qZA(),t._uU(5,"\u304b\u3089\u5909\u66f4\u3067\u304d\u307e\u3059\u3002"),t.qZA(),t.TgZ(6,"form",1,2)(8,"div",3)(9,"label",4),t._uU(10,"\u30cb\u30c3\u30af\u30cd\u30fc\u30e0"),t.qZA(),t.TgZ(11,"input",5,6),t.NdJ("ngModelChange",function(c){return e.nickname=c}),t.qZA()()()(),t.TgZ(13,"div")(14,"h2"),t._uU(15,"Chat Room \u306e\u540d\u524d"),t._UZ(16,"img",7),t.qZA(),t.TgZ(17,"form",null,8)(19,"div",3)(20,"label",9),t._uU(21,"Room"),t.qZA(),t.TgZ(22,"input",10,11),t.NdJ("ngModelChange",function(c){return e.roomNick=c}),t.qZA(),t.TgZ(24,"button",12),t.NdJ("click",function(c){return e.onEnterRoom(c)}),t._uU(25,"\u5165\u5ba4"),t.qZA(),t.YNc(26,rt,4,3,"ng-container",13),t.qZA()()()),2&o){const n=t.MAs(12),c=t.MAs(18),h=t.MAs(23);t.xp6(8),t.ekj("was-validated",n.dirty||n.touched),t.xp6(3),t.Q6J("ngModel",e.nickname)("disabled",!0),t.xp6(8),t.ekj("was-validated",h.dirty||h.touched),t.xp6(3),t.Q6J("ngModel",e.roomNick),t.xp6(2),t.Q6J("disabled",!c.valid),t.xp6(2),t.Q6J("ngIf",h.invalid)}},dependencies:[f.O5,m._Y,m.Fj,m.JJ,m.JL,m.Q7,m.wO,m.nD,m.On,m.F,g.rH]})),s})();function at(i,s){1&i&&(t.ynx(0),t._UZ(1,"span",2),t.BQk())}function ct(i,s){if(1&i){const a=t.EpF();t.ynx(0),t.TgZ(1,"gitfire-chat-entrance",3),t.NdJ("roomSelected",function(e){t.CHM(a);const n=t.oxw();return t.KtG(n.onRoomSelected(e))}),t.qZA(),t.BQk()}if(2&i){const a=t.oxw();t.xp6(1),t.Q6J("initialRoomNick",a.roomNick)}}function ut(i,s){if(1&i){const a=t.EpF();t.ynx(0),t.TgZ(1,"gitfire-chat-room",4),t.NdJ("exitRoom",function(){t.CHM(a);const e=t.oxw();return t.KtG(e.onExitedRoom())}),t.qZA(),t.BQk()}if(2&i){const a=t.oxw();t.xp6(1),t.Q6J("roomInfo",a.roomInfo)}}const ht=[{path:"",component:(()=>{var i;class s{constructor(o,e,n){(0,r.Z)(this,"chat",void 0),(0,r.Z)(this,"router",void 0),(0,r.Z)(this,"route",void 0),(0,r.Z)(this,"destroy$",new R.x),(0,r.Z)(this,"state$",new U.X("loading")),(0,r.Z)(this,"roomInfo",void 0),(0,r.Z)(this,"roomNick",void 0),(0,r.Z)(this,"ensureTos$",new R.x),this.chat=o,this.router=e,this.route=n}ngOnInit(){this.route.fragment.pipe((0,G.q)(1),(0,y.w)(o=>this.maybeRoomInfo$(o))).subscribe(o=>{if(!o||!o.id)return this.state$.next("entrance"),void(o&&o.nick&&(this.roomNick=o.nick));this.ensureTos$.next(o)}),this.ensureTos$.pipe((0,y.w)(o=>(0,S.$)((0,N.of)(o),this.chat.confirmTos$()))).subscribe(([o,e])=>{e?(this.state$.next("room"),this.roomInfo=o):(this.state$.next("entrance"),this.roomNick=o.nick)})}ngOnDestroy(){this.destroy$.next()}onRoomSelected(o){(0,p.eM)("onRoomSelected()",o),this.state$.next("room"),this.roomInfo=o,this.router.navigate(["/Gitfire/chat"],{fragment:o.nick})}onExitedRoom(){(0,p.eM)("onExitedRoom()"),this.state$.next("entrance"),this.roomInfo=null,this.router.navigate(["/Gitfire/chat"])}maybeRoomInfo$(o){return null==o||o.length<4||10<=o.length?(0,N.of)(null):this.chat.maybeRoomInfo$(o)}get isAdActive(){return!!p.NZ.production}}return i=s,(0,r.Z)(s,"\u0275fac",function(o){return new(o||i)(t.Y36(Z),t.Y36(g.F0),t.Y36(g.gz))}),(0,r.Z)(s,"\u0275cmp",t.Xpm({type:i,selectors:[["ng-component"]],decls:6,vars:6,consts:[[3,"ngSwitch"],[4,"ngSwitchCase"],["role","status",1,"spinner-border","text-primary"],[3,"initialRoomNick","roomSelected"],[3,"roomInfo","exitRoom"]],template:function(o,e){1&o&&(t.ynx(0,0),t.ALo(1,"async"),t.YNc(2,at,2,0,"ng-container",1),t.YNc(3,ct,2,1,"ng-container",1),t.YNc(4,ut,2,1,"ng-container",1),t.BQk(),t._UZ(5,"app-ad-fragment")),2&o&&(t.Q6J("ngSwitch",t.lcZ(1,4,e.state$)),t.xp6(2),t.Q6J("ngSwitchCase","loading"),t.xp6(1),t.Q6J("ngSwitchCase","entrance"),t.xp6(1),t.Q6J("ngSwitchCase","room"))},dependencies:[f.RF,f.n9,Y.J,q,st,f.Ov]})),s})()}];let mt=(()=>{var i;class s{}return i=s,(0,r.Z)(s,"\u0275fac",function(o){return new(o||i)}),(0,r.Z)(s,"\u0275mod",t.oAB({type:i})),(0,r.Z)(s,"\u0275inj",t.cJS({imports:[g.Bz.forChild(ht),g.Bz]})),s})();var lt=u(5101);let dt=(()=>{var i;class s{}return i=s,(0,r.Z)(s,"\u0275fac",function(o){return new(o||i)}),(0,r.Z)(s,"\u0275mod",t.oAB({type:i})),(0,r.Z)(s,"\u0275inj",t.cJS({providers:[k.K,Z,v._W,E.c,I.F],imports:[f.ez,m.u5,v.Rh.forRoot(p.NZ.toastrConfig),lt.R,mt,Q.M]})),s})()}}]);