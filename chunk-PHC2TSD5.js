import{b as A}from"./chunk-DQJB75ZH.js";import{a as me}from"./chunk-TBBNNVJM.js";import{d as ne,e as se}from"./chunk-OPYW42UR.js";import{a as D,d as x,f as w,o as ce,v as pe}from"./chunk-KP47Q6DE.js";import{ia as ae}from"./chunk-LQZV7VGV.js";import{Ba as a,Cb as q,Eb as m,Fb as W,G as b,Ka as y,M as I,Oa as H,Ob as B,P as J,Qc as s,R as u,Tc as k,Va as d,Vc as Q,Xa as C,Yc as X,Z as g,Zc as Y,_c as Z,aa as p,ab as S,ad as ee,b as c,bb as l,cb as f,cd as te,db as T,eb as $,fb as _,gb as L,gd as oe,hd as re,ic as K,la as M,m as j,nb as E,o as h,pb as V,sd as ie,ya as G,za as z}from"./chunk-LXNYTSMG.js";var F=class{saveNeverAsk;isConfirmed};function he(r,t){r&1&&(l(0,"div",1),T(1,"div",11),f()),r&2&&(a(),S("innerHTML",t.html,G))}function be(r,t){r&1&&T(0,"span",2)}var U=class r extends ne{confirmed=new M;inputConfirmForm;tosJson=K();constructor(){super()}ngOnInit(){s("TosConfirmComponent.OnInit()"),this.inputConfirmForm=new Z({}),this.inputConfirmForm.addControl("neverConfirmTosCheck",new ee(!1))}get neverCheckTosControl(){return this.inputConfirmForm.get("neverConfirmTosCheck")}onClickConfirm(t){if(s("TosConfirmComponent.onClickConfirm()"),t.preventDefault(),this.inputConfirmForm.markAllAsTouched(),this.inputConfirmForm.invalid)return;let e=new F,o=this.inputConfirmForm.get("neverConfirmTosCheck");e.saveNeverAsk=o.value,e.isConfirmed=!0,this.confirmed.emit(e),this.close()}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=y({type:r,selectors:[["gitfire-tos-confirm"]],inputs:{tosJson:[1,"tosJson"]},outputs:{confirmed:"confirmed",tosJson:"tosJsonChange"},features:[H],decls:18,vars:5,consts:[[1,"container"],[1,"m-3"],["role","status",1,"spinner-border","text-primary"],[1,"text-center"],[3,"formGroup"],[1,"m-5","custom-control","custom-checkbox"],["for","appGitfireTosConfirmNeverDismissCheck",1,"visually-hidden"],["id","appGitfireTosConfirmNeverDismissCheck","name","neverConfirmTosCheck","formControlName","neverConfirmTosCheck","type","checkbox",1,"form-check-input"],[1,"text-muted","fw-light"],["href","/terms.htm","about","_blank"],["id","appGitfireTosConfirmButton",1,"btn","btn-success",3,"click","disabled"],[3,"innerHTML"]],template:function(e,o){if(e&1&&(l(0,"div",0),d(1,he,2,1,"div",1)(2,be,1,0,"span",2),l(3,"div",3)(4,"form",4)(5,"div",5)(6,"label",6),m(7,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),f(),T(8,"input",7),m(9,"\u518D\u5EA6\u8868\u793A\u3057\u306A\u3044"),f(),l(10,"div",8),m(11,"\u8A73\u3057\u304F\u306F"),l(12,"a",9),m(13,"[\u5229\u7528\u898F\u7D04]"),f(),m(14,"\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002 "),f(),l(15,"div",1)(16,"button",10),V("click",function(v){return o.onClickConfirm(v)}),m(17,"\u78BA\u8A8D\u3057\u307E\u3057\u305F"),f()()()()()),e&2){let n;a(),C((n=o.tosJson())?1:2,n),a(3),S("formGroup",o.inputConfirmForm),a(),q("was-validated",o.neverCheckTosControl.dirty||o.neverCheckTosControl.touched),a(11),S("disabled",!o.inputConfirmForm.valid)}},dependencies:[ie,te,Q,X,Y,re,oe],encapsulation:2})};var le=class r{constructor(t,e,o){this.http=t;this.dialog=e;this.firestore=o}UserAgreementConverter=A(["createdAt"]);ProtectedUserPrefix="users/v1/protected";destroy$=new c;ngOnDestroy(){s("TosService.OnDestroy()"),this.destroy$.next()}constructSetupTosConfirm(t,e){return o=>{o.tosJson.set(e.json),o.confirmed.pipe(u(this.destroy$)).subscribe(n=>{if(!n.isConfirmed)throw new Error("assert");n.saveNeverAsk?e.answer=2:e.answer=0,t.next(e)})}}confirmTos$(t,e){if(t.match(/\/$/))throw new Error(`Assertion. Not a supported ${t}`);let o=new c,n=new c,v=new c,de=this.http.fetchGhJson(e).pipe(b(1),J(i=>{let O=`${this.ProtectedUserPrefix}/${t}/${i.version}`,P=w(this.firestore,O).withConverter(this.UserAgreementConverter),R={json:i,cached:!1,cacheRef:P};return x(P).pipe(h(Ce=>(Ce?.alwaysConfirmed&&(s("TOS has already been confirmed."),R.cached=!0),R)))}));return v.pipe(u(this.destroy$)).subscribe({next:i=>{this.dialog.createDefaultBuilder().prepareBody(U).setupChild(this.constructSetupTosConfirm(n,i)).setType(1).setSize(1).setTitle("\u5229\u7528\u898F\u7D04\u306E\u78BA\u8A8D").closeButton(()=>{i.answer=1,n.next(i)}).setFinalize(()=>{i.answer=1,n.next(i)}).open()},complete:()=>{s("completed dialog$")},error:i=>{k("error dialog$",i)}}),de.pipe(b(1),u(this.destroy$)).subscribe({next:i=>{if(i.cached){o.next(!0);return}v.next(i)},complete:()=>{s("Completed TOS reading")},error:i=>{k("Failed reading TOS cache",i)}}),n.pipe(b(1),u(this.destroy$)).subscribe({next:async i=>{switch(i.answer){case 0:o.next(!0);break;case 1:o.next(!1);break;case 2:let O={_docClass:"User:UserAgreementStore",alwaysConfirmed:!0,createdAt:ae()};o.next(!0),await ce(i.cacheRef,O);break;default:throw new Error(`Not a valid answer ${i.answer}`)}},complete:()=>{s("Completed dialog result."),o.complete()},error:i=>{k("Failed receive dialog result"),o.complete()}}),o}static \u0275fac=function(e){return new(e||r)(p(me),p(se),p(D))};static \u0275prov=g({token:r,factory:r.\u0275fac,providedIn:"root"})};var fe=class r{constructor(t,e){this.firestore=t;this.auth=e}destroy$=new c;nicknameCache={};userCache={};UserPublicConverter=A(["createdAt","updatedAt"]);ngOnDestroy(){s("UserService.OnDestroy"),this.destroy$.next()}myNickname$(){return this.auth.myUid?this.nickname$(this.auth.myUid):j("")}user$(t){let e=this.userCache[t];if(e)return e;let o=w(this.firestore,`users/v1/public/${t}`).withConverter(this.UserPublicConverter);return e=x(o).pipe(I(1)),this.userCache[t]=e,e}nickname$(t){let e=this.nicknameCache[t];return e||(e=this.user$(t).pipe(h(o=>o?o.nickname:null)),this.nicknameCache[t]=e,e)}static \u0275fac=function(e){return new(e||r)(p(D),p(pe))};static \u0275prov=g({token:r,factory:r.\u0275fac,providedIn:"root"})};function ye(r,t){r&1&&L(0,"img",2),r&2&&E("src",B(t),z)}function Se(r,t){if(r&1&&($(0,"span",0),d(1,ye,1,2,"img",2),m(2),_()),r&2){let e,o=t;E("title",B(o.about)),a(),C((e=o.photoURL)?1:-1,e),a(),W(o.nickname)}}function Te(r,t){r&1&&($(0,"span",1),m(1,"[\u524A\u9664]"),_())}var ue=class r{userPublic;constructor(){}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=y({type:r,selectors:[["gitfire-user-box"]],inputs:{userPublic:"userPublic"},decls:2,vars:1,consts:[[1,"p-1",3,"title"],["title","\u524A\u9664\u3055\u308C\u305F\u30E6\u30FC\u30B6\u3067\u3059",1,"text-warning"],[1,"p-1",2,"height","100%","width","2rem",3,"src"]],template:function(e,o){if(e&1&&d(0,Se,3,4,"span",0)(1,Te,2,0,"span",1),e&2){let n;C((n=o.userPublic)?0:1,n)}},encapsulation:2})};export{le as a,fe as b,ue as c};
